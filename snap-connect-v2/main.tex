\documentclass[a4paper,11pt]{article}
\usepackage[utf8]{inputenc}
\input{prelude}
\input{ldef}
\usepackage{eucal}
\usepackage{url}
\usepackage{tikz}
\usepackage{amsfonts,amsmath}
\usepackage{hyperref}
\begin{document}

\title{Verifying Snapping Mechanism - Connecting Ideal and Flopt}
\author{}

\date{}

\maketitle
In order to verify the differential privacy proeprty of
the snapping mechanism \cite{mironov2012significance},
we follow the logic rules designed from
\cite{barthe2016proving} and connecting 
it with the floating point computation semantics.
\section{Syntax}
\[\begin{array}{llll}
\mbox{Programs} & \prog & ::= & 
	%
     \varx = \expr ~|~ \varx \samplel \edistr
	%
	~|~ \prog ; \prog \\

\mbox{Expr} & \expr & ::= & \rval  ~|~  \fval
	%
	~|~ \varx  ~|~ \expr \bop \expr
	%
	~|~ \uop (\expr) \\
%
\mbox{Binary Operation} & \bop & ::= & + ~|~ - ~|~ \times ~|~ \div \\
%
\mbox{Unary Operation} & \uop & ::= & \ln ~|~ - ~|~ \round{\cdot} 
	%
	~|~ \clamp_B(\cdot) \\
%
\mbox{Value} & \valv & ::= & \fval_{(\rval, \rval)}\\
%
\mbox{Distr} & \edistr & ::= & \uniform(0, 1) 
%
	~|~ \uniform\{-1, 1\}\\ 
%
\mbox{Error} & \err & ::= & (\rval, \rval) \\
%
\mbox{Env} & \trsmem & ::= & \cdot ~|~ \trsmem[x \mapsto (\fval_{\err})]\\
%
\mbox{Type} & \tau & ::= & \float ~|~ \real ~|~ \float_{\real \times \real}
\end{array}
\]
where $\rval$ is in domain of real number $\real$, $\rval \in \real$ and $\fval$ is in domain of floating point number $\float$, $\fval \in \float$. Furthermore, the domain of floating point number $\float$ is a subset of $\real$ containing the real number that can be represented in the floating point computation. The type $\float_{\real \times \real}$ represents the base type of expressions. In Env., the variables are mapped to $(\fval_{\err})$ of the type $\float_{\real \times \real}$.


%
\paragraph{Semantics.}
$\boxed{Env \times Expr \to Value }$
%
\[
	\begin{array}{rcl}
	\sem{\expr}_{\trsmem}
	& \in &  
	\big\{\fval_{(\rval_{l}, \rval_{u})} ~|~
	\exists ~~  
	\trsmem,  
	\expr \trsto (\fvalv_{(\rval_{l}, \rval_{u})})\big\}
	\end{array}
\]
%
$
\boxed{Env \times \distr \to 
\distr(Value)}
$
%
\[
	\begin{array}{rcl}
	\sem{\uniform(0, 1)}_{\trsmem}
	& \in & 
	\big\{
	(\fval_{(\rval_{l}, \rval_{u})}) ~|~
	\fval \leftarrow \uniform(0, 1)^{\diamond}
	\land \rval_{l} = \rval_{u} = \fval
	\big\}\\
	\sem{\uniform\{-1, 1\}}_{\trsmem}
	& \in & 
	\big\{
	(-1_{(-1, -1)}), (1_{(1, 1)}) ~|~
	each ~ w.p. ~ 0.5 
	\big\}\\	
	\end{array}
\]
%
$\boxed{Env \times prog \to \distr(Env)}$
\[
\begin{array}{rcl}
	%
	\sem{\varx \samplel \edistr}_{\trsmem}
	& = & 
	\elet \fval_{(\rval_{l}, \rval_{u})} = \sem{\edistr}_{\trsmem}
	\ein 
	\unit{\trsmem[\varx \mapsto \fval_{(\rval_{l}, \rval_{u})}]}
	\\
	%
	\sem{\varx = \expr}_{\trsmem}
	& = &  
	~\unit{\trsmem[\varx \mapsto \sem{\expr}_{\trsmem}]}
	\\
	%
	\sem{\prog_1; \prog_2}_{\trsmem}
	& = &  \elet  \trsmem_1 = 
	\sem{\prog_1}_{\trsmem} \ein
	\sem{\prog_2}_{\trsmem_1} 
\end{array}
\]
%
In the semantics, 
%
$\trsmem, \expr \trsto (\fvalv_{\err})$ represents given an environment
%
$\trsmem$, the expression $\expr$
%
is transited to $\fvalv$ with error bound $err = (\rval_{l}, \rval_{u})$
in floating point transition semantics,
%
s.t. $\rval_{l} \leq \fvalv \leq \rval_{u}$.
%
$\trsmem, \prog \trsto \trsmem'$ represents given and environment $\trsmem$,
%
the program $\prog$ is transited to a new environment $\trsmem'$.
%
%
%
\section{Judgement and Validity}
%
\begin{defn}
[$\epsilon-$lifting \cite{barthe2016proving}]
Two sub-distributions $\mu_1 \in \distr(U_1)$, $\mu_2 \in \distr(U_2)$ are related by the $\epsilon-$lifting of $\Psi \subseteq U_1 \times U_2$, written $\mu_1 \Psi^{\#(\epsilon)} \mu_2$, if there exist two witness sub-distributions $\mu_L \in \distr(U_1 \times U_2)$ and $\mu_R \in \distr(U_1, U_2)$ s.t.:
\begin{enumerate}
	\item $\projl(\mu_L) = \mu_1$ and $\projr(\mu_R) = \mu_2$;
	\item $\supp(\mu_L) \subseteq \Psi$ and $\supp(\mu_R) \subseteq \Psi$; and
	\item $\Delta_{\epsilon}(\mu_L, \mu_R) \leq 0.0$.
\end{enumerate}
\end{defn}
%
\begin{defn}[tagged variable]
Let $\mathcal{X}\langle 1 \rangle$ and $\mathcal{X}\langle 2 \rangle$ be the sets of tagged variables, finite sets of variable names tagged with $\langle 1 \rangle$ or $\langle 2 \rangle$ respectively:
\[
	\mathcal{X}\langle 1 \rangle = \{\varx\langle 1 \rangle ~|~ x \in \mathcal{X}\}
	~~
	\text{and}
	~~
	\mathcal{X}\langle 2 \rangle = \{\varx\langle 2 \rangle ~|~ x \in \mathcal{X}\},
\]
where $\mathcal{X}$ is a finite set of variable names.
\end{defn}
%
\paragraph{Assertion.} We consider a set $\mathcal{A}$ of assertions (predicates) from first order logic by the following grammar:
\[
\begin{array}{llll}
%
\mbox{Bool Expression} & \bexp & :: = & 
\pi_i(\expr\langle 1 / 2 \rangle) = \pi_i(\expr\langle 1 / 2 \rangle)  
 ~|~ \pi_i(\expr\langle 1 / 2 \rangle) < \pi_i(\expr\langle 1 / 2 \rangle) \\
 & & &
 ~|~ \pi_i(\expr\langle 1 / 2 \rangle) \leq \pi_i(\expr\langle 1 / 2 \rangle)
 ~|~ \pi_i(\expr\langle 1 / 2 \rangle) \lameq \pi_i(\expr\langle 1 / 2 \rangle)
	\\
%
\mbox{Assert.} & \mathcal{A} & ::= & \top ~|~ \bot ~|~ \bexp 
	~|~ \bexp \land \bexp ~|~ \bexp \lor \bexp ~|~ \neg \bexp
\end{array}
\]
%
We typically use capital Greek letters ($\Phi, \Psi, \cdots$) for predicates. 
%
$\expr\langle 1 / 2 \rangle$ denotes an expression where program variables are tagged with $\langle 1 \rangle$ or $\langle 2 \rangle$.
%
$\pi_i(\expr\langle 1 / 2 \rangle)$ represents an expression where program variables are projected to the $i^{th}$ value from its triples, where $i \in \{1, 2, 3\}$.
%
\paragraph{Assertion Interpretation.} Assertions are interpreted as set of product environments. Let $\Phi$ be an assertion,
%
for example, when $\Phi \triangleq \pi_1(\expr_1\langle 1 \rangle) < \pi_1(\expr_2\langle 2 \rangle)$:
\[
	\sem{\Phi} = \{(\trsmem_1, \trsmem_2)
	~|~ \pi_1(\sem{\expr_1}_{\trsmem_1}) 
	< \pi_1(\sem{\expr_2}_{\trsmem_2}) \}.
\]
%
%
\paragraph{Judgment.}
The judgments are defined in following form:
\[
	\prog_1 \sim_{\epsilon} \prog_2: \Phi \Rightarrow \Psi.
\]
Here, $\prog_1$ and $\prog_2$ are programs and $\Phi$ and $\Psi$ are assertions on pairs of memories. Each assertions can refer to two copies $x\langle 1 \rangle, x\langle 2 \rangle$ of each program variable $x$, where these tagged variables refer to the value of x in the execution of $\prog_1$ and $\prog_2$ respectively.
%
\\
A judgment is valid, written $\vdash \prog_1 \sim_{\epsilon} \prog_2: \Phi_0 \Rightarrow \Phi$, 
if for any two environments $\trsmem_1$ and $\trsmem_2$ satisfying precondition $\Phi_0$, 
i.e., $(\trsmem_1, \trsmem_2) \in \sem{\Phi_0}$, there exists a lifting of $\Phi$ relating the output distributions: 
%
$(\sem{\prog_1}_{\trsmem_1})$ 
$\sem{\Phi}^{\#(\epsilon)}$ 
$(\sem{\prog_2}_{\trsmem_2})$.
%
\\
%
Fig. \ref{fig:aprhl} presents the main rules from apRHL+ \cite{barthe2016proving} excluding the while and condition rules which is not defined in out syntax, as well as the sampling rule, which we generalized in extended apRHL.
The rule in Fig. \ref{fig:aprhlplus} represents the lifting proved in soundness theorem.
%
\begin{figure}[ht]
\boxed{\vdash: prog \times prog \times \real \times Assert \times Assert, ~~ \Phi: Env \times Env \to bool}\\
\boxed{\pi_i: Value \times Value \times Value \to Value, ~~ i = 1, 2, 3}
\begin{mathpar}
\inferrule*[right = Unif]
{
\empty
}
{
	\vdash
	\varx_1 \samplel \uniform(0, 1) 	
	\sim_{\epsilon+\ln(\frac{\rvalR_2}{\rvalL_2})} 
	\varx_2 \samplel \uniform(0, 1)
	:
	\rvalL_1, \rvalL_2, \rvalR_1, \rvalR_2 \neq 0
	\land
	e^{-\epsilon} \leq 
	\frac{\rvalL_1}{\rvalL_2}
	\leq e^{\epsilon}
	\land
	e^{-\epsilon} \leq 
	\frac{\rvalR_1}{\rvalR_2}
	\leq e^{\epsilon}
	\\
	\land
	e^{-\epsilon} \leq 
	\frac{\rvalR_1 - \rvalL_1}{\rvalR_2 - \rvalL_2}
	\leq e^{\epsilon}
	\Rightarrow  
	\rvalL_1 \leq \pi_1(\varx_1\langle 1 \rangle) \leq \rvalR_1 
	\land 
	\rvalL_2 \leq \pi_1 (\varx_2\langle 2 \rangle) \leq \rvalR_2
}
\and
\mathtodo{
\inferrule*[right = Unif0]
{
\empty
}
{
	\vdash
	\varx_1 \samplel \uniform(0, 1) 	
	\sim_{\epsilon+\ln(\frac{\rvalR_2}{\rvalL_2})} 
	\varx_2 \samplel \uniform(0, 1)
	:
	\rvalL_1 = 0
	\lor 
	\rvalL_2 = 0
	\land
	e^{-\epsilon} \leq 
	\frac{\rvalR_1}{\rvalR_2}
	\leq e^{\epsilon}
	\land
	e^{-\epsilon} \leq 
	\frac{\rvalR_1 - \rvalL_1}{\rvalR_2 - \rvalL_2}
	\leq e^{\epsilon}
	\\
	\Rightarrow  
	% (P \Rightarrow   Q)
	\rvalL_1 \leq \pi_1(\varx_1\langle 1 \rangle) \leq \rvalR_1 
	\land 
	\rvalL_2 \leq \pi_1 (\varx_2\langle 2 \rangle) \leq \rvalR_2
}
}
\and
\inferrule
{
\empty
}
{
	\vdash 
	\varx_1 \samplel \uniform(0, 1) 	
	\sim_{0} 
	\varx_2 \samplel \uniform(0, 1) 
	: \top \Rightarrow 
	\pi_1 (\varx_2\langle 2 \rangle) 
	= \pi_1 (\varx_1\langle 1 \rangle )
	\land \pi_2 (\varx_2\langle 2 \rangle) = \pi_2 (\varx_1\langle 1 \rangle)
	\land \pi_3 (\varx_2\langle 2 \rangle) = \pi_3 (\varx_1\langle 1 \rangle)
}~\textbf{null1}
\and
\inferrule
{
\empty
}
{
	\vdash 
	\varx_1 \samplel \uniform\{-1, 1\} 	
	\sim_{0} 
	\varx_2 \samplel \uniform\{-1, 1\}  
	: \top \Rightarrow 
	\pi_1 (\varx_2\langle 2 \rangle) = \pi_1 (\varx_1\langle 1 \rangle )
	\land \pi_2 (\varx_2\langle 2 \rangle) = \pi_2 (\varx_1\langle 1 \rangle)
	\land \pi_3 (\varx_2\langle 2 \rangle) = \pi_3 (\varx_1\langle 1 \rangle)
}~\textbf{null}	
\and
\inferrule*[right = round]
{
\empty
}
{
	\vdash 
	\varx_1 \samplel \round{\vary_1}_{\Lambda}	
	\sim_{0} 
	\varx_2 \samplel \round{\vary_2}_{\Lambda}
	: \vary_1 \langle 1 \rangle \lameq \vary_2 \langle 2 \rangle
	\Rightarrow 
	\pi_1 (\varx_2 \langle 2 \rangle) = \pi_1 (\varx_1 \langle 1 \rangle) = k
}
\end{mathpar}
\caption{Rules Extended from apRHL+}
\label{fig:aprhlplus}
\end{figure}
%
\begin{figure}[ht]
\begin{mathpar}
\inferrule*[right = Assn]
{
\empty
}
{
	\vdash 
	\varx_1 = \expr_1  
	\sim_{0} 
	\varx_2 = \expr_2  
	: \Phi[\expr_1/\varx_1\langle 1 \rangle]
	[\expr_2/\varx_2\langle 2 \rangle]  \Rightarrow \Phi
}
~~~
\inferrule*[right = Seq]
{
\prog_1 \sim_{\epsilon} \prog_2 : \Phi_1 \Rightarrow \Phi'_1
\\
\prog'_1 \sim_{\epsilon'} \prog'_2 : \Phi'_1 \Rightarrow \Phi_2
}
{
	\vdash 
	\prog_1; \prog'_1  
	\sim_{\epsilon + \epsilon'} 
	\prog_2; \prog'_2
	: \Phi_1  \Rightarrow  \Phi_2
}
\and
\inferrule*[right = Conseq]
{
\prog_1 \sim_{\epsilon} \prog_2 : \Phi'_1 \Rightarrow \Phi'_2
\and
\Phi_1 \Rightarrow \Phi'_1
\and 
\Phi'_2 \Rightarrow \Phi_2
\and 
\epsilon \leq \epsilon'
}
{
\prog_1 \sim_{\epsilon'} \prog_2 : 
\Phi_1 \Rightarrow \Phi_2
}
\end{mathpar}
\caption{Proving Rules from apRHL}
\label{fig:aprhl}
\end{figure}
%
%
\clearpage
\begin{thm}
\label{thm:unif_coupling}
Let $\edistr_1 \in \distr(\float)$, $\edistr_2 \in \distr(\float)$ are defined:
\[
	\edistr_1(\fvarx_{(\rvarx_l, \rvarx_u)}) 
	= \sem{\uniform(0, 1)}_{[]},
~~
	\edistr_2(\fvary_{(\rvary_l, \rvary_u)}) 
	= \sem{\uniform(0, 1)}_{[]}
\]
where $\uniform$ is uniform distribution over $[0, 1)$ whoes $\pdf.$ is defined as:
\[
	\pdf_{\edistr_1}(\fvarx_{(\rvarx_l, \rvarx_u)}) = 
	\begin{cases}
	1 & \fvarx \in [0, 1)^{\mathbb{F}} 
	%\land \fvarx = \rvarx_1 = \rvarx_2
	\\
	0       & o.w.
	\end{cases},
	~~
	\pdf_{\edistr_2}(\fvary_{(\rvary_l, \rvary_u)}) = 
	\begin{cases}
	1 & \fvary \in [0, 1)^{\mathbb{F}}
	% \land \fvary = \rvary_1 = \rvary_2
	\\
	0       & o.w.
	\end{cases},
\]
where $\fvarx$ and $\fvary$ is the only random variable in $\edistr_1$ and $\edistr_2$ respectively. 
The $\rvarx_l, \rvarx_u$ and $\rvary_l, \rvary_u$ are deterministic results calculated from $\fvarx$ and $\fvary$ respectively in $\edistr_1$ and $\edistr_2$ . In our $\uniform$ distribution semantics, i.e., $\sem{\uniform(0, 1)}$, the deterministic function is equality $(\rvarx_u = \rvarx_l = \fvarx) \land (\fvary = \rvary_l = \rvary_u)$.
\\
Then, $	\exists ~ \rvalL_1, \rvalL_2, \rvalR_1, \rvalR_2. ~ s.t. ~
	e^{-\epsilon} \leq 
	\frac{\rvalL_1}{\rvalL_2}
	\leq e^{\epsilon}
	\land
	e^{-\epsilon} \leq 
	\frac{\rvalR_1}{\rvalR_2}
	\leq e^{\epsilon}
	\land
	e^{-\epsilon} \leq 
	\frac{\rvalR_1 - \rvalL_1}{\rvalR_2 - \rvalL_2}
	\leq e^{\epsilon}$, s.t. 
$\sem{\varx_1 \samplel \edistr_1}_{\trsmem_1} 
	~ \sem{\Phi}^{\#(\epsilon + \ln(\frac{\rvalR_1}{\rvalL_1})} ~
\sem{\varx_2 \samplel \edistr_2}_{\trsmem_2}$, 
where
\[
\begin{array}{rl}
	\sem{\Phi} = &
	\{((\fval_{1(\rval_{1l}, \rval_{1u})}), (\fval_{2(\rval_{2l}, \rval_{2u})})) 
	\in (\float_{\real \times \real}) \times (\float_{\real \times \real})\\
	& ~|~
	\rval_{1l} = \rval_{1u} = \fval_1 
	\land \fval_2 = \rval_{2l} = \rval_{2u}
	\land
	\rvalL_1 \leq \fval_1 \leq \rvalR_1 ~ (\star) 
	\land 
	\rvalL_2 \leq \fval_2 \leq \rvalR_2 ~ (\diamond)
	\}
\end{array}
\]
\end{thm}
%
\begin{proof}[Proof of Theorem \ref{thm:unif_coupling}]
%
By the restriction on $\rvalR_1$, $\rvalL_1$, $\rvalR_2$ and $\rvalL_2$, we have:
\\
$e^{-\epsilon}\rvalL_2 \leq \rvalL_1 \leq e^{\epsilon}\rvalL_2$ (1)
and
$e^{-\epsilon}\rvalR_2 \leq \rvalR_1 \leq e^{\epsilon}\rvalR_2$ (2).
%
\\
Since we also have the relation on $\fval_1$ and $\fval_2$, i.e. $(\star)$ and $(\diamond)$, we can get:
\\
$e^{-\epsilon} \rvalL_2 \leq \fval_1 \leq e^{\epsilon} \rvalR_2$ (3)
and
$e^{-\epsilon} \rvalL_1 \leq \fval_2 \leq e^{\epsilon} \rvalR_1$ (4)
\\
Then, by $(\star)$ and (3), we can get: 
$e^{-\epsilon} \frac{\rvalL_2}{\rvalR_2} 
\leq \frac{\fval_1}{\fval_2} \leq
e^{\epsilon} \frac{\rvalR_2}{\rvalL_2} $, i.e., 
$e^{-(\epsilon + \ln(\frac{\rvalR_2}{\rvalL_2}))}  
\leq \frac{\fval_1}{\fval_2} \leq
e^{\epsilon + \ln(\frac{\rvalR_2}{\rvalL_2})}$.
%
\\
%
Let $\epsilon' = \epsilon + \ln(\frac{\rvalL_2}{\rvalR_2})$ and $\mu_L, \mu_R \in \distr((\float_{\real \times \real}) \times (\float_{\real \times \real}))$ be the two witness distribution s.t.:
\[
	{\mu_L}(x, y) = 
	\begin{cases}
	\edistr_1(\varx)
	& \pi_1(x) \cdot e^{-\epsilon'} = \pi_1(y) \land \pi_1(x) \in [0, 1)\\
	0       & o.w.
	\end{cases},
~~~
	{\mu_R}(x, y) = 
	\begin{cases}
	\edistr_2(y)
	& \pi_1(x) \cdot e^{-\epsilon'} = \pi_1(y) \land \pi_1(y) \in [0, 1)\\
	0       & o.w.
	\end{cases},
\]
%
%
where $\varx = (\fvarx_{(\rvarx_l, \rvarx_u)}) \in (\float_{\real \times \real})$,
$\vary = (\fvary_{(\rvary_l, \rvary_u)}) \in (\float_{\real \times \real})$ and their $\pdf.$ are defined as:
\[
	\pdf_{\mu_L}(x, y) = 
	\begin{cases}
	\pdf_{\edistr_1}(x) & \pi_1(x) \cdot e^{-\epsilon'} = \pi_1(y) \land \pi_1(x) \in [0, 1)\\
	0       & o.w.
	\end{cases},
\]
\[
	\pdf_{\mu_R}(x, y) = 
	\begin{cases}
	\pdf_{\edistr_2}(y) & \pi_1(x) \cdot e^{-\epsilon'} = \pi_1(y) \land \pi_1(y) \in [0, 1)\\
	0       & o.w.
	\end{cases}.
\]
It is enough to show the 2 witnesses $\edistr_L(x, y)$ and $\edistr_R(x, y)$ are satisfying following three requirements:
\begin{itemize}
	\item $\supp(\mu_L) \in \Psi \land \supp(\mu_R) \in \Psi$

	\begin{itemize}
		\item $\supp(\mu_L) \subseteq \Psi$ 
		%
		\\
		% 
		By definition of the $\pdf$ of $\mu_L$, 
		$\forall \pdf_{\mu_R}(x, y) > 0$,
		we have 
		$\pi_1(x) \cdot e^{-\epsilon'} = \pi(y) \in \Psi$ 
		%
		\\%
		%
		Then we can derive $\supp(\mu_L) \in \Psi$
		%
		\item $\supp(\mu_R) \subseteq \Psi$
		%
		\\
		%
		By definition of the $\pdf$ of $\mu_L$, 
		$\forall \pdf_{\mu_L}(x, y) > 0$,
		we have
		$\pi_1(x) \cdot e^{-\epsilon'} = \pi(y) \in \Psi$ 
		%
		\\
		%
		Then we can derive $\supp(\mu_L) \in \Psi$
		%
	\end{itemize}		
%
	\item $\projl(\mu_L) = \mu_1 \land \pi_2(\mu_R) = \mu_2$
	
	\begin{itemize}
		\item $\projl(\mu_L) = \mu_1$ 

		% Equivalent to show $\pdf_{\projl(\mu_L)}  = \pdf_{\mu_1}$.

		By definition of the $\projl$ and $\pdf$ of $\mu_L$, we have $\forall x = (\fvarx_{(\rvarx_l, \rvarx_u)}) \in \float_{\real \times \real}$:
		\[
			\pdf_{\projl(\mu_L)}(x) = 
			\begin{cases}
			\int_{y}\pdf_{\uniform}(x) 
			& \fvarx \cdot e^{-\epsilon'} = \pi_1(\fvary) 
			\land \fvarx \in [0, 1)\\
			0       & o.w.
			\end{cases} 
			= 
			\begin{cases}
			\pdf_{\uniform}(x) & \fvarx \in [0, 1)\\
			0       & o.w.
			\end{cases}
			=
			\pdf_{\mu_1}(x)
		\]

		\item $\projl(\mu_R) = \mu_2$ 

		Equivalent to show$\pdf_{\projr(\mu_R)}  = \pdf_{\mu_2}$.

		By definition of the $\projr$ and $\pdf$ of $\mu_R$, we have $\forall y = (\fvary_{(\rvary_l, \rvary_u)}) \in \float_{\real \times \real}$:
		\[
			\pdf_{\projr(\mu_R)}(y) = 
			\begin{cases}
			\int_{x}\pdf_{\uniform}(y) 
			& \fvarx \cdot e^{-\epsilon'} = \pi_1(\fvary) 
			\land \fvary \in [0, 1)\\
			0       & o.w.
			\end{cases} 
			= 
			\begin{cases}
			\pdf_{\uniform}(y) & \fvary \in [0, 1)\\
			0       & o.w.
			\end{cases}
			=
			\pdf_{\mu_2}(y)
		\]
	\end{itemize}	

	\item $\Delta_{\epsilon'}(\mu_L, \mu_R) \leq 0$

	By definition of $\epsilon-$DP divergence, we have:
	 \[
	 \begin{array}{ll}
	 \Delta_{\epsilon'}(\mu_L, \mu_R) 
	 & = \underset{S}{\psup}
	 \Big(
	 \pr{(x,y) \samplel \mu_L}{(x,y) \in S} - e^{\epsilon'} \pr{(x,y) \samplel \mu_R}{(x,y) \in S}
	 \Big) \\
	 & =\underset{S}{\psup}
	 \Big(
	 \int_{(x,y) \in S} \pdf_{\mu_L}(x, y) - e^{\epsilon'} \int_{(x,y) \in S} \pdf_{\mu_R}(x, y)
	 \Big)	 
	 \end{array}
	 \]
	 \begin{itemize}
	 	\item[{\bf case}]
	 	%
	 	$S \subseteq \{(x, y) ~|~ 
	 	\pi_1(x) \in [0, 1) \land \pi_1(x) \cdot e^{-\epsilon} 
	 	= \pi_1(y)\}$:
	 	%
		\[
		 \begin{array}{ll}
		 \Delta_{\epsilon'}(\mu_L, \mu_R) 
		 & = 
		 \int_{(x,y) \in S} \pdf_{\uniform}(x) - e^{\epsilon'} \int_{(x,y) \in S} \pdf_{\uniform}(y)\\
		 & = 
		 \int_{(x,y) \in S} \pdf_{\uniform}(x) - e^{\epsilon'} \int_{(x,y) \in S} \pdf_{\uniform}(x * e^{-\epsilon'})\\ 
		 & = 
		 \int_{(x,y) \in S} \pdf_{\uniform}(x) - e^{\epsilon'}* e^{-\epsilon'} \int_{(x,y) \in S} \pdf_{\uniform}(x) 
		 = 0 
		 \end{array}
		 \]
		 %
	 	\item[{\bf case}] $S \subseteq \{(x, y) 
	 	~|~ \pi_1(x) \in [1, e^{\epsilon'}) 
	 	\land \pi_1(x) \cdot e^{-\epsilon'} = \pi_1(y)\}$:
	 	%
		 \[
		 \Delta_{\epsilon'}(\mu_L, \mu_R) 
		 = 
		 0 - e^{\epsilon'} \int_{(x,y) \in S} \pdf_{\uniform}(y) <0
		 \]
	 	\item[{\bf case}] o.w.:
	 	%
		 \[
		 \Delta_{\epsilon'}(\mu_L, \mu_R) = 0 - 0 =  0 
		 \]	 	

	 \end{itemize}

\end{itemize}
\end{proof}
%
%
%
%
%
%
\clearpage
\begin{thm}[Soundness]
 $\forall \prog_1$, $\prog_2$,  $ \vdash \prog_1	
\sim_{\epsilon} 
\prog^2 :
\Phi_0 \Rightarrow \Phi $,    $\forall \trsmem_1$, $\trsmem_2$ 
s.t $\Phi_0$: 
$\trsmem_1 ~ \sem{\Phi_0} ~ \trsmem_2$,
then
$$ 
(\sem{\prog_1}_{\trsmem_1})  
\sem{\Phi}^{\#(\epsilon)} 
(\sem{\prog_2}_{\trsmem_2}) 
$$.
\end{thm}



\begin{proof}
By induction on the judgement $\vdash \prog_1	
\sim_{\epsilon}
\prog_2 :
\Phi_0 \Rightarrow \Phi $, we have following cases:
\begin{itemize}
\caseL{[\textsc{Unif}]}
	In this case, 
	$\sem{\Phi}$ is interpreted as:
	$	\exists ~ \rvalL_1, \rvalL_2, \rvalR_1, \rvalR_2. ~ s.t. ~
	e^{-\epsilon} \leq 
	\frac{\rvalL_1}{\rvalL_2}
	\leq e^{\epsilon}
	\land
	e^{-\epsilon} \leq 
	\frac{\rvalR_1}{\rvalR_2}
	\leq e^{\epsilon}
	\land
	e^{-\epsilon} \leq 
	\frac{\rvalR_1 - \rvalL_1}{\rvalR_2 - \rvalL_2}
	\leq e^{\epsilon}$, s.t. 
\[
\begin{array}{rl}
	\sem{\Phi} = &
	\{((\fval_{1(\rval_{1l}, \rval_{1u})}), (\fval_{2(\rval_{2l}, \rval_{2u})})) 
	\in (\float_{\real \times \real}) \times (\float_{\real \times \real})\\
	& ~|~
	\rval_{1l} = \rval_{1u} = \fval_1 
	\land \fval_2 = \rval_{2l} = \rval_{2u}
	\land
	\rvalL_1 \leq \fval_1 \leq \rvalR_1 ~ (\star) 
	\land 
	\rvalL_2 \leq \fval_2 \leq \rvalR_2 ~ (\diamond)
	\}
\end{array}
\]
	%
	By the semantics of sampling, we have:\\
	%
	$\sem{\varx_1 \samplel \uniform(0, 1)}_{\trsmem_1} = 
	\elet (\fval_{1(\rval_{1l}, \rval_{1u})}) 
	= \sem{\uniform(0, 1)}_{\trsmem_1} 
	\ein 
	\unit{\trsmem[\varx \mapsto (\fval_{1(\rval_{1l}, \rval_{1u})})]}
	$
	%
	\\
	%
	$\sem{\varx_2 \samplel \uniform(0, 1)}_{\trsmem_2} = 
	\elet (\fval_{2(\rval_{2l}, \rval_{2u})}) 
	= \sem{\uniform(0, 1)}_{\trsmem_2} 
	\ein 
	\unit{\trsmem[\varx \mapsto (\fval_{2(\rval_{2l}, \rval_{2u})})]}
	$. \\
	%
	By the semantics of $\sem{\uniform(0, 1)}_{\trsmem}$ we also have:
	\\
	%
	$ \rval_{1l} = \fval_1 = \rval_{1u} ~ (1)$ 
	and
	$ \rval_{2l} = \fval_2 = \rval_{2u} ~ (2)$.
	%
	\\
	%
	Then, it is enough to show:
	${\edistr_1}(x) ~ \Psi^{\#(\epsilon)} ~ {\edistr_2}(y)$,
	where ${\edistr_1}(x) \in \distr(\float)$, ${\edistr_2}(y) \in \distr(\float)$ 
	and
	 $\exists ~ \rvalL_1, \rvalL_2, \rvalR_1, \rvalR_2. ~ s.t. ~
	e^{-\epsilon} \leq 
	\frac{\rvalL_1}{\rvalL_2}
	\leq e^{\epsilon}
	\land
	e^{-\epsilon} \leq 
	\frac{\rvalR_1}{\rvalR_2}
	\leq e^{\epsilon}
	\land
	e^{-\epsilon} \leq 
	\frac{\rvalR_1 - \rvalL_1}{\rvalR_2 - \rvalL_2}
	\leq e^{\epsilon}$, 
where
\[
	\sem{\Psi} = 
	\{(\fval_1, \fval_2) \in \float \times \float 
	~|~
	\rvalL_1 \leq \fval_1 \leq \rvalR_1 
	\land 
	\rvalL_2 \leq \fval_2 \leq \rvalR_2
	\}.
\]
And the $\edistr_1(\varx), \edistr_2(\vary)$ are defined as:
\[
	\pdf_{\edistr_1}(\varx) = 
	\begin{cases}
	1 & \varx \in [0, 1)^{\mathbb{F}} 
	%\land \fvarx = \rvarx_1 = \rvarx_2
	\\
	0       & o.w.
	\end{cases},
	~~
	\pdf_{\edistr_2}(\vary) = 
	\begin{cases}
	1 & \vary \in [0, 1)^{\mathbb{F}}
	% \land \fvary = \rvary_1 = \rvary_2
	\\
	0       & o.w.
	\end{cases},
\]
	Which is proved in the Theorem \ref{thm:unif_coupling}.
	%
	%
\caseL{[\textsc{Null}] }
	In this case, 
	$\sem{\Phi} = 
	\{((\fval_1, \rval_{1l}, \rval_{1u}), (\fval_2, \rval_{2l}, \rval_{2u})) 
	\in (\float \times \real \times \real) \times (\float \times \real \times \real)
	|
	\rval_{2l} = \rval_{1l}
	\land
	\rval_{2u} = \rval_{1u}
	\land
	\fval_1 = \fval_2
	\}$
	%
	\\
	%
	By the semantics of sampling, we have:\\
	%
	$\sem{\varx_1 \samplel \edistr_1}_{\trsmem_1} = 
	\elet (\fval_1, \rval_{1l}, \rval_{1u}) 
	= \sem{\edistr_1}_{\trsmem_1} 
	\ein 
	\unit{\trsmem[\varx \mapsto (\fval_1, \rval_{1l}, \rval_{1u})]}
	$ and 
	%
	$\sem{\varx_2 \samplel \edistr_2}_{\trsmem_2} = 
	\elet (\fval_2, \rval_{2l}, \rval_{2u}) 
	= \sem{\edistr_2}_{\trsmem_2} 
	\ein 
	\unit{\trsmem[\varx \mapsto (\fval_2, \rval_{2l}, \rval_{2u})]}
	$. \\
	%
	Then by the semantics of $\sem{\uniform(0, 1)}_{\trsmem}$ we have:
	\\
	%
	$ \rval_{1l} = \fval_1 = \rval_{1u} ~ (1)$ 
	and
	$ \rval_{2l} = \fval_2 = \rval_{2u} ~ (2)$.
	%
	\\
	%
	Then, it is enough to show:
	${\edistr_1}(x) ~ \Psi^{\#(0, 0)} ~ {\edistr_1}(y)$, where
	\[
		\Psi = \{(\fval_1, \fval_2) \in \float \times \float
		~| ~
		\fval_1 = \fval_2 \}.
	\]
	%
	Which is obviously.
	\caseL{[\textsc{Assn}] }
	By the semantics of assignment, we have:\\
	\caseL{[\textsc{Seq}] }
	\caseL{[\textsc{ConSeq}] }
	\end{itemize}
\end{proof}


\newpage
\section{Snapping Mechanism}

\begin{defn}
[$\snap(a) : A \to \distr(\real)$]
Given privacy parameter $\epsilon$, the Snapping mechanism $\snap(a)$ is defined as:
\[
	\varu \samplel \uniform(0,1); s \samplel \uniform\{-1, 1\};
	\varx = f(a) + \frac{1}{\epsilon} \times s \times \ln (\varu);
	\vary = \round{\varx}_{\Lambda};
	\varz = \clamp_B (\vary)
\]
where $f(a)$ represents a value that the query function $f$ be evaluated over input database $a \in A$, $\epsilon$ is the privacy parameter, $B$ is the clamping argument and $\Lambda$ is the rounding argument satisfying $\lambda = 2^k$ where $2^k$ is the smallest power of 2 greater or equal to the $\frac{1}{\epsilon}$.
\end{defn}

\begin{defn}[$\Lambda$ equivalent]
Given two floating point values $\valv_1$ and $\valv_2$, if for some floating point value $\fvalv$ which is a multiple of $\Lambda$:
\[
	\fvalv - \frac{\Lambda}{2} \leq \valv_1 < \fvalv + \frac{\Lambda}{2}
	~~
	\land
	~~
	\fvalv - \frac{\Lambda}{2} \leq \valv_2 < \fvalv + \frac{\Lambda}{2},	
\]
then $\valv_1$ and $\valv_2$ are $\Lambda$ equivalent, i.e., 
$\valv_1 \lameq \valv_2 \lameq \fvalv$.
\end{defn}
%
% \begin{lem}[]
% \label{lem:xisLameq}
% Given the environment $\trsmem_1 = [\varu_1 \to (\fvalv_1, \rvalv_1, \rvalv_1)]$, $\trsmem_1 = [\varu_2 \to (\fvalv_2, \rvalv_2, \rvalv_2)]$ and $f(a) + 1 = f(a')$, if 
% \begin{itemize}
% 	\item $\fvalv < 0$, 
% 	$e^{\epsilon 
% 		\big((\valv - \frac{\Lambda}{2})(1 + \eta)^3 
% 		- f(a) (1 + \eta)^2) \big)}
% 	\leq \fvalv_1 \leq 
% 	e^{\epsilon 
% 		(\frac{(\frac{\valv + \frac{\Lambda}{2}}{1 + \eta} - f(a))}{(1 + \eta)^2})}$,
% 	$e^{\epsilon 
% 		\big((\valv - \frac{\Lambda}{2})(1 + \eta)^3 
% 		- f(a') (1 + \eta)^2) \big)}
% 	\leq \fvalv_2 \leq 
% 	e^{\epsilon 
% 		(\frac{(\frac{\valv + \frac{\Lambda}{2}}{1 + \eta} - f(a))}{(1 + \eta)^2})}$, 
% 	Or
% 	\item
% 	$\fvalv = 0$, 
% 	$e^{\epsilon 
% 		\big((\valv - \frac{\Lambda}{2})(1 + \eta)
% 		- f(a) (1 + \eta)^2) \big)}
% 	\leq \fvalv_1 \leq 
% 	e^{\epsilon 
% 		((\frac{\valv + \frac{\Lambda}{2}}{1 + \eta} - \frac{f(a))}{(1 + \eta)^2})}$,
% 	$e^{\epsilon 
% 		\big((\valv - \frac{\Lambda}{2})(1 + \eta) 
% 		- f(a') (1 + \eta)^2) \big)}
% 	\leq \fvalv_2 \leq 
% 	e^{\epsilon 
% 		((\frac{\valv + \frac{\Lambda}{2}}{1 + \eta} - \frac{f(a))}{(1 + \eta)^2})}$, 
% \end{itemize}
% then we have:
% 	\[
% 	\pi_1(\sem{\varx_1 = f(a) + \frac{1}{\epsilon}\ln(\varu_1)}_{\trsmem_1}(\varx_1))
% 	\lameq 
% 	\pi_1(\sem{\varx_2 = f(a') + \frac{1}{\epsilon}\ln(\varu_2)}_{\trsmem_2}(\varx_2))	
% 	\]	
% \end{lem}

\begin{thm}[The $\snap$ mechanism is 
$\epsilon-$differentially private]
\end{thm}
\begin{proof}
Induction on the output space of $\snap(a)$ mechanism, let $\valv$ be the output of $\snap(a)$, we have following cases:
\begin{itemize}
	\caseL{$\boldsymbol{\valv = -B}$}
%
Let $b$ be the largest number rounded by $\Lambda$ that is smaller than $B$, $b' = b + \Lambda / 2$.
%
\\
Let $\rvalL_1 = \rvalL_2 = 0$, 
$\rvalR_1 = e^{\epsilon 
		(\frac{(\frac{-b'}{1 + \eta} - f(a))}{(1 + \eta)^2})}$
and $\rvalR_2 = e^{\epsilon 
		(\frac{(\frac{-b'}{1 + \eta} - f(a'))}{(1 + \eta)^2})}$.
By the calculation in the Flopt Version proof, we have:
\[
	e^0 < \frac{\rvalR_1 - \rvalL_1}{\rvalR_2 - \rvalL_2}
	< e^{\epsilon(10.1 \eta B + 1 + 2.1\eta)} 
	< e^{\epsilon(23 \eta B + 1)}.
\]
%
In this case, since $\rvalL_1 = \rvalL_2 = 0$, we have $\frac{\rvalR_2}{\rvalL_2} = \infty$. 
Because the final value is all clamped to $B$, there is actually no privacy loss.
We don’t need to talk about the ratio between $\rvalL_2$ and $\rvalR_2$.

Then, we have following derivation for this case:

{\tiny
\begin{mathpar}
\inferrule*[right = Seq]
{
	\inferrule*[right = Seq]
	{
	\inferrule
	{
	\Phi \triangleq 
	\rvalL_1 \leq \pi_1(\varu_1 \langle 1 \rangle) \leq \rvalR_1 
	\land 
	\rvalL_2 \leq \pi_1(\varu_2 \langle 2 \rangle) \leq \rvalR_2
	}
	{
		\varu_1 \samplel \uniform(0,1)
		\sim_{\epsilon(23 \eta B + 1)} 
		\varu_2 \samplel \uniform(0,1)
		: 
		\top
		\Rightarrow 
		\Phi
	}~\textbf{unif0}
	~~
	\inferrule
	{
	\empty
	}
	{
		s_1 = \samplel \uniform\{-1, 1\}
		\sim_{0} 
		s_2 = \samplel \uniform\{-1, 1\}
		: 
		\Phi
		\Rightarrow 
		\Phi \land \pi_1(s_1 \langle 1 \rangle) 
		= \pi_1(s_2\langle 2 \rangle)
	}~\textbf{null}
	}
	{
		\varu_1 \samplel \uniform(0,1); s_1 = \samplel \uniform\{-1, 1\}
		\sim_{\epsilon(23 \eta B + 1)} 
		\varu_2 \samplel \uniform(0,1); s_2 = \samplel \uniform\{-1, 1\}
		: 
		\top \Rightarrow \Phi \land \pi_1(s_1\langle 1 \rangle) 
		= \pi_1(s_2\langle 2 \rangle)
	}
\\
\Pi_R
}
{
	\vdash 
	\varu_1 \samplel \uniform(0,1); s_1 = \samplel \uniform\{-1, 1\};
	\varx_1 = f(a) + \frac{1}{\epsilon} \times s_1 \times \ln (\varu_1);
	\vary_1 = \round{\varx_1}_{\Lambda};
	\varz_1 = \clamp_B (\vary_1)
	\\
	\sim_{\epsilon(23 \eta B + 1)} 
	\varu_2 \samplel \uniform(0,1); s_2 = \samplel \uniform\{-1, 1\};
	\varx_2 = f(a') + \frac{1}{\epsilon} \times s_2 \times \ln (\varu_2)
	\vary_2 = \round{\varx_2}_{\Lambda};
	\varz_2 = \clamp_B (\vary_2)
	: \\
	\valv = -B \land f(a) + 1 = f(a')  \land
	\Rightarrow  \pi_1(\varx_1\langle 1 \rangle) 
	= \pi_1(\varx_2\langle 2 \rangle) = \valv
}
\\
\Pi_R:
\\
\inferrule*[right = Seq]
{
\inferrule*[right = ConSeq]
{	
\inferrule*[right = Assn]
	{
		\empty
	}
	{
		\varx_1 = 
		f(a) + \frac{1}{\epsilon} \times s_1 \times \ln (\varu_1)
		\sim_{0} 
		\varx_2 =
		f(a') + \frac{1}{\epsilon} \times s_2 \times \ln (\varu_2)
		:
		\Phi \land \pi_1(s_1\langle 1 \rangle) = \pi_1(s_2\langle 2 \rangle)
		\Rightarrow
		\Phi'
	}
\and
\Phi' \Rightarrow \pi_1(\varx_1\langle 1 \rangle) \lameq \pi_1(\varx_2\langle 2 \rangle) 
}
{
	\varx_1 = f(a) + \frac{1}{\epsilon} \times s_1 \times \ln (\varu_1)
	\sim_{0} 
	\varx_2 = f(a') + \frac{1}{\epsilon} \times s_2 \times \ln (\varu_2)
	:
	f(a) + 1 = f(a') \land \Phi 
	\land \pi_1(s_1\langle 1 \rangle) = \pi_1(s_2\langle 2 \rangle)
	\Rightarrow \pi_1(\varx_1\langle 1 \rangle) \lameq \pi_1(\varx_2\langle 2 \rangle)
}
\and
\Delta_R
}
{
	\varx_1 = f(a) + \frac{1}{\epsilon} \times s_1 \times \ln (\varu_1);
	\vary_1 = \round{\varx_1}_{\Lambda};
	\varz_1 = \clamp(\vary_1)
	\sim_{0} 
	\varx_2 = f(a') + \frac{1}{\epsilon} \times s_2 \times \ln (\varu_2);
	\vary_2 = \round{\varx_2}_{\Lambda};
	\varz_2 = \clamp(\vary_2)
	:
	f(a) + 1 = f(a') \land \Phi \land \pi_1(s_1\langle 1 \rangle) = \pi_1(s_2\langle 2 \rangle)
	\Rightarrow \pi_1(\varx_1\langle 1 \rangle) = \pi_1(\varx_2\langle 2 \rangle)
}
\\
\Delta_R:
\\
\inferrule*[right = Seq]
{
	\inferrule*[right = round]
	{
		\empty
	}
	{
		\vary_1 = \round{\varx_1}_{\Lambda}
		\sim_{0}
		\vary_2 = \round{\varx_2}_{\Lambda}
		: \pi_1(\varx_1\langle 1 \rangle) \lameq \pi_1(\varx_2\langle 2 \rangle) 
		\Rightarrow \pi_1(\varx_1\langle 1 \rangle) = \pi_1(\varx_2\langle 2 \rangle)
	}
	\and
	\inferrule
	{
		\empty
	}
	{
		\varz_1 = \clamp(\vary_1)
		\sim_{0}
		\varz_2 = \clamp(\vary_2)
		: \pi_1(\varx_1\langle 1 \rangle) = \pi_1(\varx_2\langle 2 \rangle) 
		\Rightarrow \pi_1(\varx_1\langle 1 \rangle) = \pi_1(\varx_2\langle 2 \rangle)
	}~\textbf{null}
}
{
	\vary_1 = \round{\varx_1}_{\Lambda};
	\varz_1 = \clamp(\vary_1)
	\sim_{0} 
	\vary_2 = \round{\varx_2}_{\Lambda};
	\varz_2 = \clamp(\vary_2)
	:
	\pi_1(\varx_1\langle 1 \rangle) \lameq \pi_1(\varx_2\langle 2 \rangle)
	\Rightarrow \pi_1(\varx_1\langle 1 \rangle) = \pi_1(\varx_2\langle 2 \rangle)
}
\end{mathpar}
}
%
The $\Phi' \Rightarrow \pi_1(\varx_1) \lameq \pi_1(\varx_2)$ is proved as following:
%
\\
By the program semantics, we have:
\\
{\tiny
\[
\begin{array}{ll}
	& \sem{\varu_1 \samplel \uniform(0,1); s_1 = \samplel \uniform\{-1, 1\};
		\varx_1 = f(a) + \frac{1}{\epsilon} \times s_1 \times \ln (\varu_1)}_{[]} =
	\\
	&
	 \elet (\fval_1, \rval_1, \rval_1 ) = \sem{\uniform(0,1)}_{[]} 
	 \ein \elet (1, 1, 1) = \sem{\uniform\{-1, 1\}} \ein
	 [\varu_1 \mapsto (\fval_1, \rval_1, \rval_1); 
	 s_1 \mapsto (1, 1, 1); 
	 \varx_1 \mapsto \bigg(
				f(a) + \frac{1}{\epsilon} \times \ln(\fval_1),
				%
				 (f(a) + 
				(\frac{1}{\epsilon} \times \ln(\rval_1))
				(1 + \eta)^2)
				{(1 + \eta)},
				%
				\frac{(
				f(a) + \frac{\frac{1}{\epsilon} 
				\times \ln(\rval_1)}
				{(1 + \eta)^2}
				)}
				{(1 + \eta)}
				\bigg)]
	\\
	\sim
	&
	\sem{\varu_2 \samplel \uniform(0,1); s_2 = \samplel \uniform\{-1, 1\};
		\varx_2 = f(a') + \frac{1}{\epsilon} \times s_2 \times \ln (\varu_2)}
	\\
	&
	\elet (\fval_2, \rval_2, \rval_2) = \sem{\uniform(0,1)}_{[]}
	\ein \elet (1, 1, 1) = \sem{\uniform\{-1, 1\}} \ein
	[\varu_2 \mapsto (\fval_2, \rval_2, \rval_2);
	 s_2 \mapsto (1, 1, 1); 
	 \varx_2 \mapsto \bigg(
				f(a) + \frac{1}{\epsilon} \times \ln(\fval_2),
						%
				\big( (f(a') + 
				(\frac{1}{\epsilon} \times \ln(\rval_2))
				(1 + \eta)^2)
				{(1 + \eta)},
				%
				\frac{(
				f(a') + \frac{\frac{1}{\epsilon} 
				\times \ln(\rval_2)}
				{(1 + \eta)^2}
				)}
				{(1 + \eta)}
				 \big)
				\bigg)]	
	\end{array}
\]
}
%
 We also have $\pi_1(\varu_1) = \pi_2(\varu_1) = \pi_3(\varu_1)$, 
	$\pi_1(\varu_2) = \pi_2(\varu_2) = \pi_3(\varu_2)$,
	$\pi_2(\varx_1) \leq \pi_1(\varx_1) \leq \pi_3(\varx_1)$ and 
	$\pi_2(\varx_2) \leq \pi_1(\varx_2) \leq \pi_3(\varx_2)$ by the semantics, 
	since $\Phi' = 	
\rvalL_1 \leq \pi_1(\varu_1) < \rvalR_1 
	\land 
	\rvalL_2 \leq \pi_1(\varu_2) < \rvalR_2$, 
	we can get:
{\tiny
\[
\begin{array}{rcl}
	(f(a) + (\frac{1}{\epsilon} \times \ln(\rvalL_1))
	(1 + \eta)^2){(1 + \eta)}
	\leq \pi_1(\varx_1) \leq 
	\frac{(f(a) + \frac{\frac{1}{\epsilon} 
	\times \ln(\rvalR_1)}{(1 + \eta)^2})}{(1 + \eta)}
	& ~ \sim ~ &
	(f(a') + (\frac{1}{\epsilon} \times \ln(\rvalL_2))
	(1 + \eta)^2){(1 + \eta)} 
	\leq \pi_1(\varx_2) \leq 
	\frac{(f(a') + \frac{\frac{1}{\epsilon} 
	\times \ln(\rvalR_2)}{(1 + \eta)^2})}{(1 + \eta)}
	\\
	0 \leq \pi_1(\varx_1) \leq  b + \frac{\Lambda}{2}
	& ~ \sim ~ &
	0 \leq \pi_1(\varx_2) \leq b + \frac{\Lambda}{2}
	\\
	\pi_1(\varx_1) & ~ \lameq ~ & \pi_1(\varx_2)
\end{array}
\]
}
%
%
\caseL{
	$\boldsymbol{\valv \in (-B, \round{f(a)}_{\Lambda})} ~ (\star) $
	}
	%
	\subcaseL{
	$\boldsymbol{\round{f(a)}_{\Lambda} \leq 0 
	\lor \bigg( \round{f(a)}_{\Lambda} > 0 \land \valv \in (-B, 0) \bigg) } ~ (\star_1)$
	}
	%
	Let $\valv_1 = \valv - (\frac{\Lambda}{2})$,
		$\valv_2 = \valv + (\frac{\Lambda}{2})$, 
		we know $\valv_1 < 0$, $\valv_2 < 0$.
\\
Let $\rvalL_1 = e^{\epsilon
				\big( (\valv_1(1 + \eta) - f(a)) (1 + \eta)^2) \big)}$,
$\rvalL_2 = e^{\epsilon
				\big( (\valv_1(1 + \eta) - f(a')) (1 + \eta)^2) \big)}$, 
$\rvalR_1 = e^{\epsilon
		(\frac{(\frac{\valv_2}{1 + \eta} - f(a))}{(1 + \eta)^2})}$
and $\rvalR_2 = e^{\epsilon
		(\frac{(\frac{\valv_2}{1 + \eta} - f(a'))}{(1 + \eta)^2})}$.
By the calculation in the Flopt Version proof, we have:
\[
	e^0 < \frac{\rvalR_1 - \rvalL_1}{\rvalR_2 - \rvalL_2}
	< e^{\epsilon(23 \eta B + 1)}.
\]
We also have:
$e^0 < \frac{\rvalR_2}{\rvalL_2} \leq e^{3 \epsilon \eta B}$.
\\
Then, we have following derivation for this case:

{\tiny
\begin{mathpar}
\inferrule*[right = Seq]
{
	\inferrule*[right = Seq]
	{
	\inferrule
	{
	\Phi \triangleq 
	\rvalL_1 \leq \pi_1(\varu_1 \langle 1 \rangle) \leq \rvalR_1 
	\land 
	\rvalL_2 \leq \pi_1(\varu_2 \langle 2 \rangle) \leq \rvalR_2
	}
	{
		\varu_1 \samplel \uniform(0,1)
		\sim_{\epsilon(26 \eta B + 1)} 
		\varu_2 \samplel \uniform(0,1)
		: 
		\top
		\Rightarrow 
		\Phi
	}~\textbf{unif}
	~~
	\inferrule
	{
	\empty
	}
	{
		s_1 = \samplel \uniform\{-1, 1\}
		\sim_{0} 
		s_2 = \samplel \uniform\{-1, 1\}
		: 
		\Phi
		\Rightarrow 
		\Phi \land \pi_1(s_1 \langle 1 \rangle) 
		= \pi_1(s_2\langle 2 \rangle)
	}~\textbf{null}
	}
	{
		\varu_1 \samplel \uniform(0,1); s_1 = \samplel \uniform\{-1, 1\}
		\sim_{\epsilon(23 \eta B + 1) + 3\eta B} 
		\varu_2 \samplel \uniform(0,1); s_2 = \samplel \uniform\{-1, 1\}
		: 
		\top \Rightarrow \Phi \land \pi_1(s_1\langle 1 \rangle) 
		= \pi_1(s_2\langle 2 \rangle)
	}
\\
\Pi_R
}
{
	\vdash 
	\varu_1 \samplel \uniform(0,1); s_1 = \samplel \uniform\{-1, 1\};
	\varx_1 = f(a) + \frac{1}{\epsilon} \times s_1 \times \ln (\varu_1);
	\vary_1 = \round{\varx_1}_{\Lambda};
	\varz_1 = \clamp_B (\vary_1)
	\\
	\sim_{\epsilon(23 \eta B + 1)} 
	\varu_2 \samplel \uniform(0,1); s_2 = \samplel \uniform\{-1, 1\};
	\varx_2 = f(a') + \frac{1}{\epsilon} \times s_2 \times \ln (\varu_2)
	\vary_2 = \round{\varx_2}_{\Lambda};
	\varz_2 = \clamp_B (\vary_2)
	: \\
	\valv = -B \land f(a) + 1 = f(a')  \land
	\Rightarrow  \pi_1(\varx_1\langle 1 \rangle) 
	= \pi_1(\varx_2\langle 2 \rangle) = \valv
}
\\
\Pi_R:
\\
\inferrule*[right = Seq]
{
\inferrule*[right = ConSeq]
{	
\inferrule*[right = Assn]
	{
		\empty
	}
	{
		\varx_1 = 
		f(a) + \frac{1}{\epsilon} \times s_1 \times \ln (\varu_1)
		\sim_{0} 
		\varx_2 =
		f(a') + \frac{1}{\epsilon} \times s_2 \times \ln (\varu_2)
		:
		\Phi \land \pi_1(s_1\langle 1 \rangle) = \pi_1(s_2\langle 2 \rangle)
		\Rightarrow
		\Phi'
	}
\and
\Phi' \Rightarrow \pi_1(\varx_1\langle 1 \rangle) \lameq \pi_1(\varx_2\langle 2 \rangle) 
}
{
	\varx_1 = f(a) + \frac{1}{\epsilon} \times s_1 \times \ln (\varu_1)
	\sim_{0} 
	\varx_2 = f(a') + \frac{1}{\epsilon} \times s_2 \times \ln (\varu_2)
	:
	f(a) + 1 = f(a') \land \Phi 
	\land \pi_1(s_1\langle 1 \rangle) = \pi_1(s_2\langle 2 \rangle)
	\Rightarrow \pi_1(\varx_1\langle 1 \rangle) \lameq \pi_1(\varx_2\langle 2 \rangle)
}
\and
\Delta_R
}
{
	\varx_1 = f(a) + \frac{1}{\epsilon} \times s_1 \times \ln (\varu_1);
	\vary_1 = \round{\varx_1}_{\Lambda};
	\varz_1 = \clamp(\vary_1)
	\sim_{0} 
	\varx_2 = f(a') + \frac{1}{\epsilon} \times s_2 \times \ln (\varu_2);
	\vary_2 = \round{\varx_2}_{\Lambda};
	\varz_2 = \clamp(\vary_2)
	:
	f(a) + 1 = f(a') \land \Phi \land \pi_1(s_1\langle 1 \rangle) = \pi_1(s_2\langle 2 \rangle)
	\Rightarrow \pi_1(\varx_1\langle 1 \rangle) = \pi_1(\varx_2\langle 2 \rangle)
}
\\
\Delta_R:
\\
\inferrule*[right = Seq]
{
	\inferrule*[right = round]
	{
		\empty
	}
	{
		\vary_1 = \round{\varx_1}_{\Lambda}
		\sim_{0}
		\vary_2 = \round{\varx_2}_{\Lambda}
		: \pi_1(\varx_1\langle 1 \rangle) \lameq \pi_1(\varx_2\langle 2 \rangle) 
		\Rightarrow \pi_1(\varx_1\langle 1 \rangle) = \pi_1(\varx_2\langle 2 \rangle)
	}
	\and
	\inferrule
	{
		\empty
	}
	{
		\varz_1 = \clamp(\vary_1)
		\sim_{0}
		\varz_2 = \clamp(\vary_2)
		: \pi_1(\varx_1\langle 1 \rangle) = \pi_1(\varx_2\langle 2 \rangle) 
		\Rightarrow \pi_1(\varx_1\langle 1 \rangle) = \pi_1(\varx_2\langle 2 \rangle)
	}~\textbf{null}
}
{
	\vary_1 = \round{\varx_1}_{\Lambda};
	\varz_1 = \clamp(\vary_1)
	\sim_{0} 
	\vary_2 = \round{\varx_2}_{\Lambda};
	\varz_2 = \clamp(\vary_2)
	:
	\pi_1(\varx_1\langle 1 \rangle) \lameq \pi_1(\varx_2\langle 2 \rangle)
	\Rightarrow \pi_1(\varx_1\langle 1 \rangle) = \pi_1(\varx_2\langle 2 \rangle)
}
\end{mathpar}
}
%
	\subcaseL{
	$\boldsymbol{\round{f(a)}_{\Lambda} > 0 \land \valv \in (0, \round{f(a)}_{\Lambda}) } ~ (\star_1)$}
%
	Let $\valv_1 = \valv - (\frac{\Lambda}{2})$,
		$\valv_2 = \valv + (\frac{\Lambda}{2})$, 
		we know $\valv_1 > 0$, $\valv_2 > 0$.
\\
Let $\rvalL_1 = e^{\epsilon 
				\big( \valv_1(1 + \eta) - f(a) (1 + \eta)^2) \big)}$,
$\rvalL_2 = e^{\epsilon 
				\big( \valv_1(1 + \eta) - f(a') (1 + \eta)^2) \big)}$, 
$\rvalR_1 = e^{\epsilon 
		(\frac{\valv_2}{1 + \eta} - \frac{f(a)}{(1 + \eta)^2})}$
and $\rvalR_2 = e^{\epsilon 
		(\frac{\valv_2}{1 + \eta} - \frac{f(a')}{(1 + \eta)^2})}$.
By the calculation in the Flopt Version proof, we have:
\[
	e^0 < \frac{\rvalR_1 - \rvalL_1}{\rvalR_2 - \rvalL_2}
	\leq e^{\epsilon(12 \eta B + 1)}.
\]
%
	We also have:
	$e^0 < \frac{\rvalR_2}{\rvalL_2} \leq e^{3 \epsilon \eta B}$.
	\\
Since $ \epsilon(12 \eta B + 1) + 3 \epsilon \eta B < e^{\epsilon(23 \eta B + 1)}$, we have the derivation exactly the same as previous cases.
%
	%
	\subcaseL{$\boldsymbol{\round{f(a)}_{\Lambda} > 0 \land \valv = 0 } $}
	%
	Let $\valv_1 = \valv - (\frac{\Lambda}{2})$,
	$\valv_2 = \valv  + (\frac{\Lambda}{2})$,
	we know $\valv_1 < 0$, $\valv_2 > 0$.
	By \textbf{Lemma 3} from the Flopt Version we have: $s = 1$.	%
	\\
	Let $\rvalL_1 = e^{\epsilon 
					\big( (\valv_1(1 + \eta) - f(a)) (1 + \eta)^2) \big)}$,
	$\rvalL_2 = e^{\epsilon 
					\big(\valv_1(1 + \eta) - f(a') (1 + \eta)^2) \big)}$, 
	$\rvalR_1 = e^{\epsilon 
			(\frac{(\frac{\valv_2}{1 + \eta} - f(a))}{(1 + \eta)^2})}$
	and $\rvalR_2 = e^{\epsilon 
			(\frac{\valv_2}{1 + \eta} - \frac{f(a')}{(1 + \eta)^2})}$.
	By the calculation in the Flopt Version proof, we have:
	\[
		e^0 < \frac{\rvalR_1 - \rvalL_1}{\rvalR_2 - \rvalL_2}
		\leq e^{\epsilon(14 \eta B + 1)}.
	\]
	%
	We also have:
	$e^0 < \frac{\rvalR_2}{\rvalL_2} \leq e^{3 \epsilon \eta B}$.
	\\
	Since $ \epsilon(14 \eta B + 1) + 3 \epsilon \eta B < e^{\epsilon(23 \eta B + 1)}$, 
	we have the derivation exactly the same as previous cases.
	%
	\caseL{$\boldsymbol{\valv = \round{f(a)}_{\Lambda}}$}
	%
	There are 3 subcases by induction on $\round{f(a)}_{\Lambda}$:
		$\round{f(a)}_{\Lambda} < 0$, $\round{f(a)}_{\Lambda} = 0$ and $\round{f(a)}_{\Lambda} > 0$. 
		%
		\\
		%
		Without loss of generalization, we consider the worst case where the error propagate in the same direction, i.e. $\round{f(a)}_{\Lambda} < 0$.
		%
		\\
		%
		Let $\valv_1 = \valv - \frac{\Lambda}{2}$, $\valv_2 = \valv + \frac{\Lambda}{2}$, we know $\valv_1 < 0$, $\valv_2 < 0$.
		%
		For input $a$, by \textbf{ Lemma. 3}, \textbf{ Lemma. 7 and  8} from the Flopt Version, we have:
		 $s = 1$ or $-1$ and $\rvalR_1 = \rvalR_2 = 1$.
	%
	\subcaseL{$s = 1$}
	%
	Let $\rvalL_1 = e^{\epsilon 
					\big( (\valv_1(1 + \eta) - f(a)) (1 + \eta)^2) \big)}$,
	$\rvalL_2 = e^{\epsilon 
					\big((f(a') - \valv_1(1 + \eta)) (1 + \eta)^2) \big)}$, 
	$\rvalR_1 = e^{\epsilon 
			(\frac{(\frac{\valv_2}{1 + \eta} - f(a))}{(1 + \eta)^2})}$
	and $\rvalR_2 = e^{\epsilon 
			(\frac{ f(a') - \frac{\valv_2}{1 + \eta}}{(1 + \eta)^2})}$.
	By the calculation in the Flopt Version proof, we have:
	\[
		e^0 < \frac{\rvalR_1 - \rvalL_1}{\rvalR_2 - \rvalL_2}
		\leq e^{\epsilon(12 \eta B + 1)} .
	\]
	%
	We also have:
	$e^0 < \frac{\rvalR_2}{\rvalL_2} \leq e^{3\epsilon \eta B}$.
	\\
	Since $ \epsilon(12 \eta B + 1) + 3 \epsilon \eta B < e^{\epsilon(23 \eta B + 1)}$, 
	%
	we have the derivation exactly the same as previous cases.
	%
	\subcaseL{$s = -1$}
	%
	\caseL{
	$\boldsymbol{\valv \in (\round{f(a)}_{\Lambda}, \round{f(a')}_{\Lambda})}$
	}
	%
	\caseL{$\boldsymbol{\valv = \round{f(a')}_{\Lambda}}$}
	%
	\subcaseL{$s = 1$}
	%
	\subcaseL{$s = -1$}
	%
	\caseL{$\boldsymbol{\valv \in  (\round{f(a')}_{\Lambda}, B)}$}
	%
	\subcaseL{
	$\boldsymbol{\round{f(a')}_{\Lambda} > 0 \lor \round{f(a')}_{\Lambda} < 0 \land \valv \in  (0, B)}$}
	%
	\subcaseL{$\boldsymbol{\round{f(a')}_{\Lambda} < 0 \land \valv \in  (\round{f(a')}_{\Lambda}, 0)}$}
	%
	\subcaseL{$\boldsymbol{\round{f(a')}_{\Lambda} < 0 \land \valv = 0}$}
	%
	\caseL{$\boldsymbol{\valv = B}$}
	%
\end{itemize}


\end{proof}

\newpage
\bibliographystyle{plain}
\bibliography{verifysnap.bib}

\end{document}



