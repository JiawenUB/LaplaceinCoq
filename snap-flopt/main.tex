\documentclass[a4paper,11pt]{article}
\usepackage[utf8]{inputenc}
\input{prelude}
\input{ldef}
\usepackage{eucal}
\usepackage{url}
\usepackage{tikz}
\usepackage{amsfonts,amsmath}
\begin{document}

\title{Verifying Snapping Mechanism - Floating Point Implementation Version}
\author{Jiawen Liu}

\date{\today}

\maketitle
In order to verify the differential privacy property of an implementation of the snapping mechanism \cite{mironov2012significance}, we follow the logic rules designed from \cite{barthe2016proving} and the floating point error semantics from \cite{Ramananandro2016unified,Martel2006higher,Becker2018verified,Moscato2017Automatic}.

\section{Preliminary Definitions}
\begin{defn}
[Laplace mechanism \cite{dwork2006calibrating}]
Let $\epsilon > 0$. The Laplace mechanism  $\lapmech_{\epsilon}$: $\real \to \distr(\real)$ is defined by $\lapmech(t) = t + v$, where $v \in \real$ is drawn from the Laplace distribution $\laplace(\frac{1}{\epsilon})$.
\end{defn}
%
%
%
\section{Syntax}
Following are the syntax of the system. The circled operators are rounded operation in floating point computation.
\[\begin{array}{llll}
\mbox{Floating Point Expr.} & \fexpr & ::= & \fval
	%
	~|~ \fvarx ~|~ f(\fvarx) ~|~ \fexpr \oop \fexpr
	%
	~|~ \oln (\fexpr) ~|~ \fvarx \samplel \edistr \\
%
\mbox{Real Expr.} & \rexpr & ::= & \rval
	%
	~|~ \rvarx ~|~ F(\rvarx) ~|~ \rexpr * \rexpr
	%
	~|~ \ln (\rexpr) ~|~ \rvarx \samplel \edistr \\
%
\mbox{Arithmetic Operation} & * & ::= & + ~|~ - ~|~ \times ~|~ \div \\
%
\mbox{Value} & \valv & ::= & \rval ~|~  \fval \\
%
\mbox{Distribution} & \edistr & ::= & \laplace ~|~ \uniform ~|~ \bernoulli \\ 
%
\mbox{Error} & \err & ::= & (\rexpr, \rexpr) \\

\end{array}\]

We use upper case for variables in real computation and lower case for variables in floating point computation.

$F(\rvarx)$ denotes function $F$ evaluates to value $F(\rvarx)$ given input $\rvarx$ in real computation, and $f(\fvarx)$ denotes the same function $F$ evaluates to value $f(\fvarx)$ given the same input $\fvarx$ in floating point computation.

\section{Semantics}

The big step semantics with relative floating point computation error are shown in Figure. \ref{fig_semantics_rel}. The semantics are $\rexpr \bigstep \fexpr, \err$, which means a real world expression $\rexpr$ can be represented in floating point computation $\fexpr$ with error bound $\err$. The $\eta$ is the machine epsilon.

\begin{figure}
\begin{mathpar}
\inferrule*[right = const]
{
	\fval = \floaten(\rval)
}
{
	\rval
	\bigstep
	\fval, \big( \frac{r}{(1 + \eta)}, r(1 + \eta) \big)
}
%
\and
%
\inferrule*[right = op]
{
	\rexpr^1 \bigstep \fexpr^1, (\ubar{\rexpr^1}, \bar{\rexpr^1})
	\and
	\rexpr^2 \bigstep \fexpr^2, (\ubar{\rexpr^2}, \bar{\rexpr^2})
}
{
    \rexpr^1 * \rexpr^2
    \bigstep \floaten(\fexpr^1 \oop \fexpr^2),
    \big(
    (\frac{\ubar{\rexpr^1} * \ubar{\rexpr^2})}{(1 + \eta)}, 
    (\bar{\rexpr^1} * \bar{\rexpr^2})(1 + \eta)
    \big)
}
%
\and
%
\inferrule*[right = ln]
{
	\rexpr \bigstep \fexpr, (\ubar{\rexpr^1}, \bar{\rexpr^2})
}
{
    \ln(\rexpr)
    \bigstep \oln(\fexpr),
    \big(
    (\frac{\oln(\ubar{\rexpr^1})}{(1 + \eta)}, 
    (\ln(\bar{\rexpr^2}))(1 + \eta)
    \big)
}
\end{mathpar}
\caption{Semantics with Relative Floating Point Error}
\label{fig_semantics_rel}
\end{figure}


\begin{thm}[Soundness Theorem]
Given $\rexpr$ and $\fexpr$ where  $\rexpr \bigstep \fexpr, \err$, when evaluating the $\fexpr$ in floating point computation and get the value $c$, we have $c \in \err$.
\end{thm}




\section{Snapping Mechanism}

\begin{defn}
[$\rsnap(a) : A \to \distr(\real)$]
Given privacy parameter $\epsilon$, the ideal Snapping mechanism $\rsnap(a)$ is defined as:
\[
	U \samplel \edistr; S \samplel \{-1, 1\}; Y = \ln (U) \div \epsilon; Z = S \times Y; X = F(a); W = X + Z; W' = \round{W}_{\Lambda}; R = \clamp_B (W')
\]
where $f$ is the query function over input $a \in A$, $\epsilon$ is the privacy budget, $B$ is the clamping bound and $\Lambda$ is the rounding argument satisfying $\lambda = 2^k$ where $2^k$ is the smallest power of 2 greater or equal to the $\frac{1}{\epsilon}$.
%

%
Let $\rsnap'(a, U, S)$ be the same as $\fsnap(a)$ given $U \samplel \edistr; S \samplel \{-1, 1\}$ without rounding and clamping steps.
\end{defn}


\begin{defn}
[$\fsnap(a) : A \to \distr(\real)$]
Given privacy parameter $\epsilon$, the floating point implemented Snapping mechanism $\fsnap(a)$ is defined as (where all parameters are defined the same as above):
\[
	u_{\mathbb{F}} \xleftarrow{\$} \edistr; s_{\mathbb{F}} \samplel \{-1, 1\}; y = \oln (u) \odiv \epsilon; z = s \otimes y; x = f(a); w = x \oplus z; w' = \round{w}_{\Lambda}; r = \clamp_B (w')
\]
Let $\fsnap'(a, u, s)$ be the same as $\fsnap(a)$ without rounding and clamping precesses given $u \samplel \edistr; s \samplel \{-1, 1\}$.
\end{defn}




\section{Main Theorem}

\begin{thm}[The $\snap$ mechanism is $\epsilon-$differentially private]
Consider $\snap(a)$ defined as before, if $\snap(a) = x$ given database $a$ and privacy parameter $\epsilon$, then its actual privacy loss is bounded by $\epsilon + 12 x \epsilon \eta + 2\eta$
\end{thm}

\begin{proof}

Given $\fsnap(a) = x$ and parameter $\epsilon$, we consider $a'$ be the adjacent database of $a$ satisfying $|f(a) - f(a')| \leq 1$.
Without loss of generalization, we assume $f(a) + 1 = f(a') ~ (\diamond)$.
The proof is developed by cases of the output of $\fsnap(a)$ mechanism.
%

%
Consider the $\rsnap(a)$ outputting the same result $x$, let $(L, R)$ be the range where $\forall u \in (L, R)$ and some $s$, $\rsnap'(a, u, s) = x$, we have $\Pr[\rsnap(a)] = R - L$. Given the $\rsnap$ is $\epsilon-$dp, we have:
\[
	e^{-\epsilon} \leq \frac{\Pr[\rsnap(a)]}{\Pr[\rsnap(a)]} = \frac{R - L}{R' - L'} \leq e^{\epsilon}
\]
%

%
Let $(l, r)$ be the range where $\forall u \in (l, r)$ and some $s$, $\fsnap'(a, u, s) = x$, we estimated the $|r - l|$ in terms of floating point relative error and $|R - L|$ through our semantics in order to verify the privacy loss of $\fsnap$.
	%
	\begin{itemize}
		%
		% \item[\textbf{case}] $\boldsymbol{x = -B}$
		\caseL{$\boldsymbol{x = -B}$}
		%
		Let $b$ be the largest number rounded by $\Lambda$ that is smaller than $B$.
		We know $s = 1$, $L = l = 0$ and $R = -b$, so we only need to estimate the right side range $r$ in this case. The derivation of this case given $\fsnap'(a, R, 1) = \fsnap'(a', R, 1) = x$ is shown as following:
		% \begin{figure}
		\begin{mathpar}
		\inferrule[ln]
		{
			R 
			\bigstep
			r,
			(\ubar{R}, \bar{R})
		}
		{
			\inferrule[op]
			{
				\ln(R) 
				\bigstep
				\oln(r),
				(\ln(\ubar{R})(1 + \eta),
				\frac{\ln(\bar{R})}{(1 + \eta)})
			}
			{
				\inferrule[op]
				{
					\frac{1}{\epsilon} \times \ln(R) 
					\bigstep
					\frac{1}{\epsilon} \otimes \oln(r)
					,
					((\frac{1}{\epsilon} \times \ln(\ubar{R}))(1 + \eta)^2,
					%
					\frac{\frac{1}{\epsilon} \times \ln(\bar{R})}{(1 + \eta)^2})
				}
				{
					\inferrule[id]
					{
						f(a) + \frac{1}{\epsilon} \times \ln(R)
						\bigstep
						f(a) \oplus \frac{1}{\epsilon} \otimes \oln(r)
						,
						(
						\frac{f(a) + 
						(\frac{1}{\epsilon} \times \ln(\ubar{R}))
						(1 + \eta)^2}
						{1 + \eta},
						%
						(
						f(a) + \frac{\frac{1}{\epsilon} \times \ln(\bar{R})}
						{(1 + \eta)^2}
						)(1 + \eta)
						)
					}
					{
						\rsnap'(a, R, 1)
						\bigstep
						\fsnap'(a, r, 1)
						,
						(
						\frac{f(a) + 
						(\frac{1}{\epsilon} \times \ln(\ubar{R}))
						(1 + \eta)^2}
						{1 + \eta},
						%
						(
						f(a) + \frac{\frac{1}{\epsilon} \times \ln(\bar{R})}
						{(1 + \eta)^2}
						)(1 + \eta)
						)	
					}
				}
			}
		}
		\end{mathpar}
		% \caption{Derivation of two $\snap$ mechanisms: $\snap(a)$, $\snap(a')$}
		% \label{fig_der_snap1}
		% \end{figure}
		%
		In the same way, we have the derivation for $\fsnap'(a', r, 1)$:
		\begin{mathpar}
		\inferrule
		{
			\dots
		}
		{
			\rsnap'(a', R, 1)
			\bigstep
			\fsnap'(a', r, 1)
			,
			(
			\frac{f(a') + 
			(\frac{1}{\epsilon} \times \ln(\ubar{R'}))
			(1 + \eta)^2}
			{1 + \eta},
			%
			(
			f(a') + \frac{\frac{1}{\epsilon} \times \ln(\bar{R'})}
			{(1 + \eta)^2}
			)(1 + \eta)
			)
		}
		\end{mathpar}
		%
		%
		Given $\fsnap(a) = \fsnap(a') = x = -b$, we have following values for $\ubar{R}, \bar{R}, \ubar{R'}$ and $\bar{R'}$:
		%
		%
		\[
		\begin{array}{c}
		\ubar{R} = e^{\epsilon (\frac{-b - \frac{\Lambda}{2}}{1 + \eta} - f(a))(1 + \eta)^2)},
		%
		\bar{R} = e^{\epsilon 
		\frac{(-b - \frac{\Lambda}{2})(1 + \eta) - f(a)}
		{(1 + \eta)^2}}
		\\
		%
		\ubar{R'} = e^{\epsilon (\frac{-b - \frac{\Lambda}{2}}{1 + \eta} - f(a'))(1 + \eta)^2)},
		%
		\bar{R'} = e^{\epsilon 
		\frac{(-b - \frac{\Lambda}{2})(1 + \eta) - f(a')}
		{(1 + \eta)^2}}
		\end{array}
		\]
		%		
		The privacy loss of $\fsnap(a)$ in this case is bounded by:
		%
		\[
		\frac
		{\frac{1}{2}(\bar{R} - 0)}
		{\frac{1}{2}(\ubar{R'} - 0)}
		= e^{\epsilon( 
		(-b - \frac{\Lambda}{2})(1 + \eta - \frac{1}{1 + \eta})
		+ f(a)((1 + \eta)^2 - \frac{1}{(1 + \eta)^2})
		+ (1 + \eta)^2)}
		\leq e^{\epsilon(1 + \eta)^2 2B}
		\leq e^{\epsilon + 12 B \epsilon \eta + 2\eta}
		\]
		%
		%
		%
		%
		\caseL{$\boldsymbol{x \in (-B, \round{f(a)}_{\Lambda})}$}
		%
		Let $y_1 = x - (\frac{\Lambda}{2})$, $y_2 = x + (\frac{\Lambda}{2})$, we know $S = s = 1$, $L = e^{\epsilon(y_1 - f(a))}$ and $R = e^{\epsilon(y_2 - f(a))}$ in this case. The derivations of estimating $l$ and $r$ are shown as following:
		% in Figure. \ref{fig_der_snap2}
		% \begin{figure}
		\begin{mathpar}
		\inferrule
		{
			L 
			\bigstep
			l,
			(\ubar{L}, \bar{L})
		}
		{
			\inferrule
			{
				\ln(L) 
				\bigstep
				\oln(l),
				(\ln(\bar{L})(1 + \eta),
				\frac{\ln(\ubar{L})}{(1 + \eta)})
			}
			{
				\inferrule
				{
					\frac{1}{\epsilon} \times \ln(L) 
					\bigstep
					\frac{1}{\epsilon} \otimes \oln(l)
					,
					((\frac{1}{\epsilon} \times \ln(\bar{L}))(1 + \eta)^2,
					%
					\frac{\frac{1}{\epsilon} \times \ln(\ubar{L})}{(1 + \eta)^2})
				}
				{
					\inferrule
					{
						f(a) + \frac{1}{\epsilon} \times \ln(L) 
						\bigstep
						f(a) \oplus \frac{1}{\epsilon} \otimes \oln(l)
						,
						(
						\frac{f(a) + 
						(\frac{1}{\epsilon} \times \ln(\bar{L}))
						(1 + \eta)^2}
						{1 + \eta},
						%
						(
						f(a) + \frac{\frac{1}{\epsilon} \times \ln(\ubar{L})}
						{(1 + \eta)^2}
						)(1 + \eta)
						)
					}
					{
					\rsnap'(a, L, 1)
					\bigstep
					\fsnap'(a, l, 1)
					,
					(
					\err_1,
					%
					\err_2
					)
					}
				}
			}
		}
		\end{mathpar}
		%
		%
		From soundness theorem, we have  $\err_1 \leq y_2 \leq \err_2$.
		%

		Taking the lower bound (i.e. $\err_1 = y_1$), we get:
		$\ubar{L} = e^{(y_1 / (1 + \eta) - f(a))(1 + \eta)^2\epsilon}$.
		Taking the upper bound (i.e. $\err_2 = y_1$), we get:
		$\bar{L} = e^{(y_1 (1 + \eta) - f(a))\epsilon/(1 + \eta)^2}$.
		%
		%
		\begin{mathpar}
		\inferrule
		{
			\dots
		}
		{
			\inferrule
			{
				\rsnap'(a, R, 1)
				\bigstep
				\fsnap'(a, r, 1)
				,
				(
				\frac{f(a) + 
				(\frac{1}{\epsilon} \times \ln(\bar{R}))
				(1 + \eta)^2}
				{1 + \eta},
				%
				(
				f(a) + \frac{\frac{1}{\epsilon} \times \ln(\bar{R})}
				{(1 + \eta)^2}
				)(1 + \eta)
				)
			}
			{
				\rsnap'(a, R, 1)
				\bigstep
				\fsnap'(a, r, 1)
				,
				(\err_1, \err_2)
				%
			}
		}
		\end{mathpar}
		%
		From soundness theorem, we have  $\err_1 \leq y_2 \leq \err_2$.
		%

		%
		Taking the lower bound (i.e. $\err_1 = y_2$), we have:
		$\ubar{R} = e^{(y_2 / (1 + \eta) - f(a))(1 + \eta)^2\epsilon}$.
		Taking the upper bound (i.e. $\err_2 = y_1$), we have:
		$\bar{R} = e^{(y_2 (1 + \eta) - f(a))\epsilon/(1 + \eta)^2}$.
		%

		%
		In the same way, we have the derivation for $\fsnap'(a', l, 1)$ and $\fsnap'(a', r, 1)$:
		\begin{mathpar}
		\inferrule
		{
			\dots
		}
		{
			\rsnap'(a', L', 1)
			\bigstep
			\fsnap'(a', l', 1)
			,
			(
			\frac{f(a') + 
			(\frac{1}{\epsilon} \times \ln(\ubar{L'}))
			(1 + \eta)^2}
			{1 + \eta},
			%
			(
			f(a') + \frac{\frac{1}{\epsilon} \times \ln(\bar{L'})}
			{(1 + \eta)^2}
			)(1 + \eta)
			)
		}
		\end{mathpar}
		%
		From soundness theorem, we have  $\err_1 \leq y_2 \leq \err_2$.
		%

		Taking the lower bound (i.e. $\err_1 = y_1$), we get:
		$\ubar{L} = e^{(y_1 / (1 + \eta) - f(a'))(1 + \eta)^2\epsilon}$.
		Taking the upper bound (i.e. $\err_2 = y_1$), we get:
		$\bar{L} = e^{(y_1 (1 + \eta) - f(a'))\epsilon/(1 + \eta)^2}$.
		%
		%
		\begin{mathpar}
		\inferrule
		{
			\dots
		}
		{
			\rsnap'(a', R', 1)
			\bigstep
			\fsnap'(a', r', 1)
			,
			(
			\frac{f(a') + 
			(\frac{1}{\epsilon} \times \ln(\ubar{R'}))
			(1 + \eta)^2}
			{1 + \eta},
			%
			(
			f(a') + \frac{\frac{1}{\epsilon} \times \ln(\bar{R'})}
			{(1 + \eta)^2}
			)(1 + \eta)
			)
		}
		\end{mathpar}
		From soundness theorem, we have  $\err_1 \leq y_2 \leq \err_2$.
		%

		%
		Taking the lower bound (i.e. $\err_1 = y_2$), we have:
		$\ubar{R} = e^{(y_2 / (1 + \eta) - f(a'))(1 + \eta)^2\epsilon}$.
		Taking the upper bound (i.e. $\err_2 = y_1$), we have:
		$\bar{R} = e^{(y_2 (1 + \eta) - f(a'))\epsilon/(1 + \eta)^2}$.
		%

		%
		%
		%
		The privacy loss is bounded by:
		%
		\[
		\frac{|\bar{R} - \ubar{L}|}{|\ubar{R'} - \bar{L'}|}
		\]
		%

		%
		Since the following bound can be proved by using $1 - 2\eta < (1 + \eta)^2 < 1 + 2.1\eta, y_1 > -B, y_2 > -B $ and simple approximation:
		\[
		\bar{R} - \ubar{L} < (R - L) e^{(5B\eta\epsilon)}, 
		\ubar{R'} - \bar{L'} > (R'  - L') e^{-7B\eta \epsilon}
		\]

		We also have the $\rsnap(a)$ is $\epsilon$-dp:
		\[
		\frac{|R - L|}{|R' - L'|} = e^{\epsilon}
		\]
		So we can get:
		\[
		\frac{|\bar{R} - \ubar{L}|}{|\ubar{R'} - \bar{L'}|}
		< \frac{|R - L|}{|R' - L'|} e^{(12B\eta\epsilon)}
		= e^{(1 + 12B\eta)\epsilon}
		\]		

		%
		\caseL{$\boldsymbol{x = \round{f(a)}_{\Lambda}}$}
		%

		%
		%
		\todo{
		%
		where $\ubar{\rval_1}, \bar{\rval_1}, \ubar{\rval_2}, \bar{\rval_2}, \ubar{\rval_1'}, \bar{\rval_1'}, \ubar{\rval_2'} and \bar{\rval_2'}$ have following values:
		%
		% \[
		% \begin{array}{c}
		% u \in \big[ 
		% (
		% (1 - \eta) e^{\epsilon(x - \frac{\Lambda}{2} - f(a))(1 - \eta)^2},
		% (1 + \eta) e^{\epsilon(x - \frac{\Lambda}{2} - f(a))(1 + \eta)^2}
		% ), 
		% (
		% (1 - \eta) e^{\epsilon(x + \frac{\Lambda}{2} - f(a))(1 - \eta)^2},
		% (1 + \eta) e^{\epsilon(x + \frac{\Lambda}{2} - f(a))(1 + \eta)^2}
		% )
		% \big)\\ 
		% %
		% \sim u' \in \big[
		% (
		% (1 - \eta) e^{\epsilon(x - \frac{\Lambda}{2} - f(a'))(1 - \eta)^2},
		% (1 + \eta) e^{\epsilon(x - \frac{\Lambda}{2} - f(a'))(1 + \eta)^2}
		% ), 
		% (
		% (1 - \eta) e^{\epsilon(x + \frac{\Lambda}{2} - f(a'))(1 - \eta)^2},
		% (1 + \eta) e^{\epsilon(x + \frac{\Lambda}{2} - f(a'))(1 + \eta)^2}
		% )
		% \big)
		% \end{array}
		% \]
		%
		Given that the probability is equivalent to the length of the range, we have the ratio between $u$ and $u'$ is bounded by:
		%
		\[
		\frac{u}{u'} 
		\leq \frac
		{1 - \frac{1}{2}(\ubar{\rval_2} + \ubar{\rval_1})}
		{\frac{1}{2}(\ubar{\rval_2'} - \bar{\rval_1'})}
		\leq \epsilon + 12 x \epsilon \eta + 2\eta
		\]
		%
		By the {AxUnif} rule, we have the actual privacy loss is bounded by the same value.
		}		
		%
		%
		\caseL{$\boldsymbol{x \in (\round{f(a)}_{\Lambda}, \round{f(a')}_{\Lambda})}$}
		%
		%
		Following the semantics in Figure \ref{fig_semantics_rel}, we have following evaluation results:
		\[
		u \in 
		\big( 
		(\ubar{\rval_1}, \bar{\rval_1}),
		(\ubar{\rval_2}, \bar{\rval_2})
		\big] \land (s = 1)
		%
		\sim u' \in \big[
		(\ubar{\rval_1'}, \bar{\rval_1'}), 
		(\ubar{\rval_2'}, \bar{\rval_2'})
		\big) \land (s = -1),
		\]
		%
		\todo{
		%
		where $\ubar{\rval_1}, \bar{\rval_1}, \ubar{\rval_2}, \bar{\rval_2}, \ubar{\rval_1'}, \bar{\rval_1'}, \ubar{\rval_2'} and \bar{\rval_2'}$ have following values:
		%
		% \[
		% \begin{array}{c}
		% u \in \big[ 
		% (
		% (1 - \eta) e^{\epsilon(x - \frac{\Lambda}{2} - f(a))(1 - \eta)^2},
		% (1 + \eta) e^{\epsilon(x - \frac{\Lambda}{2} - f(a))(1 + \eta)^2}
		% ), 
		% (
		% (1 - \eta) e^{\epsilon(x + \frac{\Lambda}{2} - f(a))(1 - \eta)^2},
		% (1 + \eta) e^{\epsilon(x + \frac{\Lambda}{2} - f(a))(1 + \eta)^2}
		% )
		% \big)\\ 
		% %
		% \sim u' \in \big[
		% (
		% (1 - \eta) e^{\epsilon(x - \frac{\Lambda}{2} - f(a'))(1 - \eta)^2},
		% (1 + \eta) e^{\epsilon(x - \frac{\Lambda}{2} - f(a'))(1 + \eta)^2}
		% ), 
		% (
		% (1 - \eta) e^{\epsilon(x + \frac{\Lambda}{2} - f(a'))(1 - \eta)^2},
		% (1 + \eta) e^{\epsilon(x + \frac{\Lambda}{2} - f(a'))(1 + \eta)^2}
		% )
		% \big)
		% \end{array}
		% \]
		%
		Given that the probability is equivalent to the length of the range, we have the ratio between $u$ and $u'$ is bounded by:
		%
		\[
		\frac{u}{u'} 
		\leq \frac
		{\frac{1}{2}(\bar{\rval_2} - \ubar{\rval_1})}
		{\frac{1}{2}(\ubar{\rval_2'} - \bar{\rval_1'})}
		\leq \epsilon + 12 x \epsilon \eta + 2\eta
		\]
		%
		By the {AxUnif} rule, we have the actual privacy loss is bounded by the same value.
		}		
		%
		%
		\caseL{$\boldsymbol{x = \round{f(a')}_{\Lambda}}$}
		%

		%
		%
		Following the semantics in Figure \ref{fig_semantics_rel}, we have following evaluation results:
		\[
		u \in 
		\big( 
		(\ubar{\rval_1}, \bar{\rval_1}),
		(\ubar{\rval_2}, \bar{\rval_2})
		\big] \land (s = 1)
		%
		\sim u' \in 
		\big[ (\ubar{\rval_1'}, \bar{\rval_1'}), 1 \big] \land (s = -1)
		\lor
		\big[ (\ubar{\rval_2'}, \bar{\rval_2'}), 1 \big] \land (s = 1),
		\]
		%
		\todo{
		%
		where $\ubar{\rval_1}, \bar{\rval_1}, \ubar{\rval_2}, \bar{\rval_2}, \ubar{\rval_1'}, \bar{\rval_1'}, \ubar{\rval_2'} and \bar{\rval_2'}$ have following values:
		%
		% \[
		% \begin{array}{c}
		% u \in \big[ 
		% (
		% (1 - \eta) e^{\epsilon(x - \frac{\Lambda}{2} - f(a))(1 - \eta)^2},
		% (1 + \eta) e^{\epsilon(x - \frac{\Lambda}{2} - f(a))(1 + \eta)^2}
		% ), 
		% (
		% (1 - \eta) e^{\epsilon(x + \frac{\Lambda}{2} - f(a))(1 - \eta)^2},
		% (1 + \eta) e^{\epsilon(x + \frac{\Lambda}{2} - f(a))(1 + \eta)^2}
		% )
		% \big)\\ 
		% %
		% \sim u' \in \big[
		% (
		% (1 - \eta) e^{\epsilon(x - \frac{\Lambda}{2} - f(a'))(1 - \eta)^2},
		% (1 + \eta) e^{\epsilon(x - \frac{\Lambda}{2} - f(a'))(1 + \eta)^2}
		% ), 
		% (
		% (1 - \eta) e^{\epsilon(x + \frac{\Lambda}{2} - f(a'))(1 - \eta)^2},
		% (1 + \eta) e^{\epsilon(x + \frac{\Lambda}{2} - f(a'))(1 + \eta)^2}
		% )
		% \big)
		% \end{array}
		% \]
		%
		Given that the probability is equivalent to the length of the range, we have the ratio between $u$ and $u'$ is bounded by:
		%
		\[
		\frac{u}{u'} 
		\leq \frac
		{\frac{1}{2}(\bar{\rval_2} - \ubar{\rval_1})}
		{1 - \frac{1}{2}(\bar{\rval_2'} + \bar{\rval_1'})}
		\leq \epsilon + 12 x \epsilon \eta + 2\eta
		\]
		%
		By the {AxUnif} rule, we have the actual privacy loss is bounded by the same value.
		}
		%
		%
		\caseL{$\boldsymbol{x \in  (\round{f(a')}_{\Lambda}, B)}$}
		%

		%
		%
		Following the semantics in Figure \ref{fig_semantics_rel}, we have following evaluation results:
		\[
		u \in 
		\big( 
		(\ubar{\rval_1}, \bar{\rval_1}),
		(\ubar{\rval_2}, \bar{\rval_2})
		\big] \land (s = 1)
		%
		\sim u' \in \big(
		(\ubar{\rval_1'}, \bar{\rval_1'}), 
		(\ubar{\rval_2'}, \bar{\rval_2'})
		\big] \land (s = 1),
		\]
		%
		\todo{
		%
		where $\ubar{\rval_1}, \bar{\rval_1}, \ubar{\rval_2}, \bar{\rval_2}, \ubar{\rval_1'}, \bar{\rval_1'}, \ubar{\rval_2'} and \bar{\rval_2'}$ have following values:
		%
		% \[
		% \begin{array}{c}
		% u \in \big[ 
		% (
		% (1 - \eta) e^{\epsilon(x - \frac{\Lambda}{2} - f(a))(1 - \eta)^2},
		% (1 + \eta) e^{\epsilon(x - \frac{\Lambda}{2} - f(a))(1 + \eta)^2}
		% ), 
		% (
		% (1 - \eta) e^{\epsilon(x + \frac{\Lambda}{2} - f(a))(1 - \eta)^2},
		% (1 + \eta) e^{\epsilon(x + \frac{\Lambda}{2} - f(a))(1 + \eta)^2}
		% )
		% \big)\\ 
		% %
		% \sim u' \in \big[
		% (
		% (1 - \eta) e^{\epsilon(x - \frac{\Lambda}{2} - f(a'))(1 - \eta)^2},
		% (1 + \eta) e^{\epsilon(x - \frac{\Lambda}{2} - f(a'))(1 + \eta)^2}
		% ), 
		% (
		% (1 - \eta) e^{\epsilon(x + \frac{\Lambda}{2} - f(a'))(1 - \eta)^2},
		% (1 + \eta) e^{\epsilon(x + \frac{\Lambda}{2} - f(a'))(1 + \eta)^2}
		% )
		% \big)
		% \end{array}
		% \]
		%
		Given that the probability is equivalent to the length of the range, we have the ratio between $u$ and $u'$ is bounded by:
		%
		\[
		\frac{u}{u'} 
		\leq \frac
		{\frac{1}{2}(\bar{\rval_2} - \ubar{\rval_1})}
		{\frac{1}{2}(\ubar{\rval_2'} - \bar{\rval_1'})}
		\leq \epsilon + 12 x \epsilon \eta + 2\eta
		\]
		%
		By the {AxUnif} rule, we have the actual privacy loss is bounded by the same value.
		}
		%		
		%
		\caseL{$\boldsymbol{x = B}$}
		%
		%
		We know $s = -1$, $L = l = 0$ and $R = b$, so we only need to estimate the right side range $r$ in this case. The derivation of this case given $\fsnap'(a, r, -1) = \fsnap'(a', r, -1) = x$ is shown as following:
		% \begin{figure}
		\begin{mathpar}
		\inferrule[ln]
		{
			R 
			\bigstep
			r,
			(\ubar{R}, \bar{R})
		}
		{
			\inferrule[op]
			{
				\ln(R) 
				\bigstep
				\oln(r),
				(\ln(\ubar{R})(1 + \eta),
				\frac{\ln(\bar{R})}{(1 + \eta)})
			}
			{
				\inferrule[op]
				{
					\frac{1}{\epsilon} \times \ln(R) 
					\bigstep
					\frac{1}{\epsilon} \otimes \oln(r)
					,
					((\frac{1}{\epsilon} \times \ln(\ubar{R}))(1 + \eta)^2,
					%
					\frac{\frac{1}{\epsilon} \times \ln(\bar{R})}{(1 + \eta)^2})
				}
				{
					\inferrule[id]
					{
						f(a) + \frac{1}{\epsilon} \times \ln(R)
						\bigstep
						f(a) \oplus \frac{1}{\epsilon} \otimes \oln(r)
						,
						(
						\frac{f(a) + 
						(\frac{1}{\epsilon} \times \ln(\ubar{R}))
						(1 + \eta)^2}
						{1 + \eta},
						%
						(
						f(a) + \frac{\frac{1}{\epsilon} \times \ln(\bar{R})}
						{(1 + \eta)^2}
						)(1 + \eta)
						)
					}
					{
						\rsnap'(a, R, 1)
						\bigstep
						\fsnap'(a, r, 1)
						,
						(
						\frac{f(a) + 
						(\frac{1}{\epsilon} \times \ln(\ubar{R}))
						(1 + \eta)^2}
						{1 + \eta},
						%
						(
						f(a) + \frac{\frac{1}{\epsilon} \times \ln(\bar{R})}
						{(1 + \eta)^2}
						)(1 + \eta)
						)	
					}
				}
			}
		}
		\end{mathpar}
		% \caption{Derivation of two $\snap$ mechanisms: $\snap(a)$, $\snap(a')$}
		% \label{fig_der_snap1}
		% \end{figure}
		%
		In the same way, we have the derivation for $\fsnap'(a', r, 1)$:
		\begin{mathpar}
		\inferrule
		{
			\dots
		}
		{
			\rsnap'(a', R, 1)
			\bigstep
			\fsnap'(a', r, 1)
			,
			(
			\frac{f(a') + 
			(\frac{1}{\epsilon} \times \ln(\ubar{R'}))
			(1 + \eta)^2}
			{1 + \eta},
			%
			(
			f(a') + \frac{\frac{1}{\epsilon} \times \ln(\bar{R'})}
			{(1 + \eta)^2}
			)(1 + \eta)
			)
		}
		\end{mathpar}
		%
		%
		Given $\fsnap(a) = \fsnap(a') = x = b$, we have following values for $\ubar{R}, \bar{R}, \ubar{R'}$ and $\bar{R'}$:
		%
		%
		\[
		\begin{array}{c}
		\ubar{R} = e^{\epsilon (\frac{-b - \frac{\Lambda}{2}}{1 + \eta} - f(a))(1 + \eta)^2)},
		%
		\bar{R} = e^{\epsilon 
		\frac{(-b - \frac{\Lambda}{2})(1 + \eta) - f(a)}
		{(1 + \eta)^2}}
		\\
		%
		\ubar{R'} = e^{\epsilon (\frac{-b - \frac{\Lambda}{2}}{1 + \eta} - f(a'))(1 + \eta)^2)},
		%
		\bar{R'} = e^{\epsilon 
		\frac{(-b - \frac{\Lambda}{2})(1 + \eta) - f(a')}
		{(1 + \eta)^2}}
		\end{array}
		\]
		%		
		The privacy loss of $\fsnap(a)$ in this case is bounded by:
		%
		\[
		\frac
		{\frac{1}{2}(\bar{R} - 0)}
		{\frac{1}{2}(\ubar{R'} - 0)}
		= e^{\epsilon( 
		(-b - \frac{\Lambda}{2})(1 + \eta - \frac{1}{1 + \eta})
		+ f(a)((1 + \eta)^2 - \frac{1}{(1 + \eta)^2})
		+ (1 + \eta)^2)}
		\geq e^{- \epsilon(1 + \eta)^2 2B}
		\geq e^{-(\epsilon + 12 B \epsilon \eta)}
		\]
	%	
	\end{itemize}



\end{proof}


\newpage
\bibliographystyle{plain}
\bibliography{verifysnap.bib}



\end{document}















