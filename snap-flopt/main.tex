\documentclass[a4paper,11pt]{article}
\usepackage[utf8]{inputenc}
\input{prelude}
\input{ldef}
\usepackage{eucal}
\usepackage{url}
\usepackage{tikz}
\usepackage{amsfonts,amsmath}
\begin{document}

\title{Verifying Snapping Mechanism - Floating Point Implementation Version}
\author{Jiawen Liu}

\date{\today}

\maketitle
In order to verify the differential privacy property of an implementation of the snapping mechanism \cite{mironov2012significance}, we follow the logic rules designed from \cite{barthe2016proving} and the floating point error semantics from \cite{Ramananandro2016unified,Martel2006higher,Becker2018verified,Moscato2017Automatic}.

\section{Preliminary Definitions}
\begin{defn}
[Laplace mechanism \cite{dwork2006calibrating}]
Let $\epsilon > 0$. The Laplace mechanism  $\lapmech_{\epsilon}$: $\real \to \distr(\real)$ is defined by $\lapmech(t) = t + v$, where $v \in \real$ is drawn from the Laplace distribution $\laplace(\frac{1}{\epsilon})$.
\end{defn}
%
%
%

\section{Syntax - IMP}
\[\begin{array}{llll}
\mbox{Programs} & \prog & ::= & 
	%
     \varx = \expr ~|~ \varx \samplel \edistr
	%
	~|~ \prog ; \prog \\

\mbox{Expr.} & \expr & ::= & \rval ~|~  \fval
	%
	~|~ \varx ~|~ f(\data) ~|~ \expr \bop \expr
	%
	~|~ \uop (\expr) \\
%
\mbox{Binary Operation} & \bop & ::= & + ~|~ - ~|~ \times ~|~ \div \\
%
\mbox{Unary Operation} & \uop & ::= & \ln ~|~ - ~|~ \round{\cdot} 
	%
	~|~ \clamp_B(\cdot) \\
%
\mbox{Value} & \valv & ::= & \rval ~|~  \fval \\
%
\mbox{Distribution} & \edistr & ::= & \laplace ~|~ \uniform ~|~ \bernoulli \\ 
%
\mbox{Error} & \err & ::= & (\expr, \expr) \\
%
\mbox{Transaction Env.} & \trsenv & ::= & \cdot ~|~ \trsenv[x \mapsto (\expr, \err)] \\
% %
% \mbox{Floating Point Evaluation Env.} & \evlenvf & ::= & \cdot ~|~ \evlenvf[x \mapsto \fval] \\
% %
% \mbox{Real Evaluation Env.} & \evlenv & ::= & \cdot ~|~ \evlenv [x \mapsto \rval]
\end{array}
\]

\section{Semantics - IMP}

The transition semantics with relative floating point computation error are shown in Figure. \ref{fig_imp_trans_semantics_exp} for programs. The semantics are $\trsenv, \prog \trsto \trsenv'$, which means a real computation programs $\prog$ with environment $\trsenv$ can be transited in floating point computation with error bound for all variables in $\trsenv'$, $\eta$ is the machine epsilon.

\begin{figure}
\begin{mathpar}
\inferrule*[right = var]
{
	\trsenv(\varx) 
	= (\expr, ( \ubar{\expr}, \bar{\expr} ))
}
{
	\trsenv, \varx
	\trsto
	(\expr, ( \ubar{\expr}, \bar{\expr} ))
}
% %
% \and
% %
% \inferrule*[right = var-non]
% {
% 	\varx \notin dom(\trsenv)
% }
% {
% 	\trsenv, \varx
% 	\trsto
% 	(\varx, (\varx, \varx ))
% }
%
\and
%
\inferrule*[right = val]
{
	\rval \geq 0
}
{
	\trsenv, \rval
	\trsto
	\big(\rval, 
	(\frac{\rval}{(1 + \eta)}, \rval(1 + \eta)) 
	\big)
}
%
\and
%
\inferrule*[right = val-neg]
{
	\fval = \floaten(\rval)
	\and
	\rval < 0
}
{
	\trsenv, \rval
	\trsto
	\big(\rval, (\rval(1 + \eta), \frac{\rval}{(1 + \eta)}) \big)
}
%
\and
%
\inferrule*[right = val-eq]
{
	\rval = \floaten(\rval)
}
{
	\trsenv, \rval
	\trsto
	(\rval, (\rval, \rval) )
}
%
\and
%
\inferrule*[right = f(d)]
{
	\empty
}
{
	\trsenv, f(D)
	\trsto
	(f(D), ( f(D), f(D) ))
}
%
\and
%
\inferrule*[right = bop]
{
	\trsenv, \expr^1 \trsto (\expr, (\ubar{\expr^1}, \bar{\expr^1}))
	~~~~
	\trsenv, \expr^2 \trsto (\expr, (\ubar{\expr^2}, \bar{\expr^2}))
	~~~~
	\bar{\expr}, \ubar{\expr} = 
	\max, \min(\ubar{\expr^1} * \ubar{\expr^2}, 
	\bar{\expr^1} * \ubar{\expr^2}, 
	\ubar{\expr^1} * \bar{\expr^2}, 
	\bar{\expr^1} * \bar{\expr^2})
	~~~~
	\expr^1 * \expr^2 \geq 0
}
{
    \trsenv, \expr^1 * \expr^2
    \trsto
    \big(
    \expr^1 * \expr^2,
    (\frac{\bar{\expr}}{(1 + \eta)}, 
        (\ubar{\expr})(1 + \eta))
    \big)
}
%
\and
%
\inferrule*[right = bop-neg]
{
	\trsenv, \expr^1 \trsto (\expr, (\ubar{\expr^1}, \bar{\expr^1}))
	~~~~
	\trsenv, \expr^2 \trsto (\expr, (\ubar{\expr^2}, \bar{\expr^2}))
	~~~~
	\bar{\expr}, \ubar{\expr} = 
	\max, \min(\ubar{\expr^1} * \ubar{\expr^2}, 
	\bar{\expr^1} * \ubar{\expr^2}, 
	\ubar{\expr^1} * \bar{\expr^2}, 
	\bar{\expr^1} * \bar{\expr^2})
	~~~~
	\expr^1 * \expr^2 < 0
}
{
    \trsenv, \expr^1 * \expr^2
    \trsto
    \big(\expr^1 * \expr^2,
    (\bar{\expr})(1 + \eta),
    \frac{\ubar{\expr}}{(1 + \eta)}
    \big)
}%
\and
%
\inferrule*[right = uop]
{
	\trsenv, \expr \trsto (\expr, (\ubar{\expr}, \bar{\expr}))
	\and
	\uop (\expr) \geq 0
}
{
    \trsenv, \uop(\expr)
    \trsto
    \Big(\uop(\expr),
    \big(
    \frac{\uop(\ubar{\expr})}{(1 + \eta)}, 
    (\uop(\bar{\expr}))(1 + \eta)
    \big)
    \Big)
}
%
~~
%
\inferrule*[right = uop-neg]
{
	\trsenv, \expr \trsto (\expr, (\ubar{\expr}, \bar{\expr}))
	\and
	\uop (\expr) < 0
}
{
    \trsenv, \uop(\expr)
    \trsto 
    \Big(\uop(\expr),
    \big(\uop(\ubar{\expr})(1 + \eta),
    \frac{\uop(\bar{\expr})}{(1 + \eta)}
    \big)
    \Big)
}
\end{mathpar}
\caption{Semantics of Transition for Expressions with Relative Floating Point Error}
\label{fig_imp_trans_semantics_exp}
\end{figure}

\begin{figure}
\begin{mathpar}
\inferrule*[right = asg]
{
	\trsenv, \expr \trsto (\expr, \err )
}
{
	\trsenv, \varx = \expr
	\trsto
	\trsenv[\varx \mapsto (\expr, \err )]
}
%
~~
%
\inferrule*[right = consq]
{
	\trsenv, \prog_1  \trsto \trsenv_1
	\and
	\trsenv_2, \prog_2  \trsto \trsenv_2
}
{
	\trsenv, \prog_1; \prog_2
	\trsto
	\trsenv_2
}
%
~~
%
\inferrule*[right = sample]
{
	 \fval \leftarrow \edistr^{\diamond}
}
{
	\trsenv, \varx \samplel \edistr
	\trsto
	\trsenv[\varx \mapsto (\fval, (\fval, \fval))]
}
\end{mathpar}
\caption{Semantics of Transition with Relative Floating Point Error Propagation for Programs}
\label{fig_semantics_prog}
\end{figure}


\begin{figure}
\begin{mathpar}
\inferrule*[right = rval]
{
	\floaten(\rval) = \fval
}
{
	\rval
	\fbigstep
	\fval
}
%
~~
%
\inferrule*[right = fval]
{
	\empty
}
{
	\fval
	\fbigstep
	\fval
}
%
~~
%
\inferrule*[right = fbop]
{
	\expr^1 \fbigstep \fval^1
	~~~
	\expr^2 \fbigstep \fval^2
	~~~
	\floaten(\fval^1 \bop \fval^2) = \fval
}
{
    \expr^1 \bop \expr^2 \fbigstep \fval
}
%
~~
%
\inferrule*[right = fuop]
{
	\expr \fbigstep \fval',
	~~~
	\floaten(\uop (\fval')) = \fval
}
{
    \uop(\expr) \fbigstep \fval
}
\end{mathpar}
\caption{Semantics of Evaluation in Floating Point Computation}
\label{fig_imp_real_semantics_exp}
\end{figure}

\begin{figure}
\begin{mathpar}
\inferrule*[right = rval]
{
	\empty
}
{
	\rval
	\rbigstep
	\rval
}
%
~~
%
\inferrule*[right = rval]
{
	\empty
}
{
	\fval
	\rbigstep
	\fval
}
%
~~
%
\inferrule*[right = rbop]
{
	\expr^1 \rbigstep \rval^1
	~~~
	\expr^2 \rbigstep \rval^2
	~~~
	\rval^1 \bop \rval^2 = \rval
}
{
    \expr^1 \bop \expr^2 \rbigstep \rval
}
%
~~
%
\inferrule*[right = ruop]
{
	\expr \rbigstep \rval',
	~~~
	\uop (\rval') = \rval
}
{
    \uop(\expr) \rbigstep \rval
}
%
~~
%
\inferrule*[right = f(d)]
{
	f(D) = \fval
}
{
	f(D) \bigstep \fval
}
\end{mathpar}
\caption{Semantics of Evaluation in Real Computation}
\label{fig_real_semantics_exp}
\end{figure}

\clearpage
\begin{thm}[Soundness Theorem]

For any $\prog$, if there exists a transition 
$\trsenv, \prog \trsto \trsenv'$ and $\trsenv$ is a bounded transaction environment 
(i.e., $\forall x \in dom(\trsenv)$ s.t. $\trsenv(x) =(\expr, (\ubar{\expr}, \bar{\expr}))$,
if $\expr \fbigstep c$, 
$\ubar{\expr} \rbigstep \ubar{r}$ and $\bar{\expr} \rbigstep \bar{r}$, then 
$\ubar{r} \leq c \leq \bar{r}$) , 
%
then $\forall x \in dom(\trsenv')$ s.t. $\trsenv'(x) =(\expr, (\ubar{\expr}, \bar{\expr}))$,
if $\expr \fbigstep c$, 
$\ubar{\expr} \rbigstep \ubar{r}$ and $\bar{\expr} \rbigstep \bar{r}$, then: 
\[
\ubar{r} \leq c \leq \bar{r}
\]
\end{thm}
%
\begin{proof}
Induction on transition rule of $\prog$, by assumption, we know $\trsenv$ is a safe environment $(\star)$.
\begin{itemize}
	\caseL{
	\[
	\inferrule*[right = consq]
	{
	\trsenv, \prog_1  \trsto \trsenv_1
	\and
	\trsenv_1, \prog_2  \trsto \trsenv_2
	}
	{
	\trsenv, \prog_1; \prog_2
	\trsto
	\trsenv_2
	}
	\]
	}
	We need to show $\trsenv_2$ is a bounded environment.\\
	%
	Since we know $\trsenv$ is a bounded environment by assumption $(\star)$, by induction hypothesis, we have:
	%
	\\
	$\trsenv_1$ and $\trsenv_2$ are all bounded environment. This case is proved.

	\caseL{\[
	\inferrule*[right = sample]
	{
		 \fval \leftarrow \edistr^{\diamond}
	}
	{
		\trsenv, \varx \samplel \edistr
		\trsto
		\trsenv[\varx \mapsto (\fval, (\fval, \fval))]
	}
	\]}
	We need to show $\trsenv[\varx \mapsto (\fval, (\fval, \fval))]$ is a safe environment.\\
	%
	Since we know $\trsenv$ is a safe environment by assumption $(\star)$.
	It is trivial that $\fval \leq \fval \leq \fval$.
	We can know $\trsenv[\varx \mapsto (\fval, (\fval, \fval))]$ is also a safe environment.

	\caseL{\[
	\inferrule*[right = asg]
	{
		\trsenv, \expr \trsto (\expr, \err )
	}
	{
		\trsenv, \varx = \expr
		\trsto
		\trsenv[\varx \mapsto (\expr, \err )]
	}
	\]}
	We need to show: $\trsenv[\varx \mapsto (\expr, \err )]$ is a safe environment.\\
	%
	By assumption $(\star)$ we know: $\trsenv$ is already a safe environment. We still need to show:\\
	%
	Let $\err = (\ubar{\expr}, \bar{\expr})$, 
	$\expr \fbigstep c $, $\ubar{\expr} \rbigstep \ubar{r}$ and $\bar{\expr} \rbigstep \bar{r}$, 
	$\ubar{r} \leq c \leq \bar{r}$.\\
	%
	Induction on transition of $\expr$, we have:
	\begin{itemize}
%
	\subcaseL{
	\[\inferrule*[right = var]
		{
			\trsenv(\varx) 
			= (\expr, ( \ubar{\expr}, \bar{\expr} ))
		}
		{
			\trsenv, \varx
			\trsto
			(\expr, ( \ubar{\expr}, \bar{\expr} ))
		}\]
		}
	By the assumption, we have $\forall \varx \in dom(\trsenv)$ s.t. $\trsenv(x) = (\expr, (\ubar{\expr}, \bar{\expr}))$, $\expr \fbigstep c $, $\ubar{\expr} \rbigstep \ubar{r}$ and $\bar{\expr} \rbigstep \bar{r}$, 
	$\ubar{r} \leq c \leq \bar{r}$.
	This case is proved.
	%
	%
	\subcaseL{
	\[\inferrule*[right = val]
		{
			\rval \geq 0
		}
		{
			\trsenv, \rval
			\trsto
			\big(\rval, \frac{\rval}{(1 + \eta)}, \rval(1 + \eta) \big)
		}
		\]
	}
	%
	By evaluation rule of floating point computation for $r$, we have:
	\[
	\inferrule*[right = rval]
		{
			\floaten(\rval ) = \fval
		}
		{
			\rval
			\fbigstep
			\fval
		}
	\]
	By the definition of floating point rounding error and $\rval \geq 0$, we have:
	%
	$\frac{\rval}{(1 + \eta)}
	\leq \fval \leq
	\rval(1 + \eta)$
	%
	%
	\subcaseL{\[
	\inferrule*[right = val-neg]
		{
			\fval = \floaten(\rval)
			\and
			\rval < 0
		}
		{
			\trsenv, \rval
			\trsto
			\big(\rval, \rval(1 + \eta), \frac{\rval}{(1 + \eta)} \big)
		}
	\]}
	%
	By evaluation rule of floating point computation for $\rval$, we have:
	\[
	\inferrule*[right = rval]
		{
			\floaten(\rval ) = \fval
		}
		{
			\rval
			\fbigstep
			\fval
		}
	\]
	By the definition of floating point rounding error and $\rval < 0$, we have:
	%
	$\rval(1 + \eta)
	\leq \fval \leq
	\frac{\rval}{(1 + \eta)}$
	%
	\subcaseL{
	\[
	\inferrule*[right = val-eq]
		{
			\rval = \floaten(\rval)
		}
		{
			\trsenv, \rval
			\trsto
			(\rval, \rval, \rval )
		}
	\]
	}
	%
	Given $\rval \fbigstep \fval$, it is trivial to show $\rval \leq \fval = \floaten(\rval) = \rval \leq \rval$
	%
	\subcaseL{
	\[\inferrule*[right = f(d)]
		{
			\empty
		}
		{
			\trsenv, f(D)
			\trsto
			(f(D), ( f(D), f(D) ))
		}%
		\]
	}
	Given $f(D) \bigstep \fval$ in both floating point and real computation, it is trivial to show $\fval \leq \fval \leq \fval$
	%
	%
	\subcaseL{
	\[
	\inferrule*[right = bop]
		{
			\trsenv, \expr^1 \trsto 
			(\expr, (\ubar{\expr^1}, \bar{\expr^1})) ~ (\diamond)
			\and
			\trsenv, \expr^2 \trsto 
			(\expr, (\ubar{\expr^2}, \bar{\expr^2})) ~ (\triangle)
			\\
		\bar{\expr}, \ubar{\expr} = 
		\max, \min(\ubar{\expr^1} * \ubar{\expr^2}, 
		\bar{\expr^1} * \ubar{\expr^2}, 
		\ubar{\expr^1} * \bar{\expr^2}, 
		\bar{\expr^1} * \bar{\expr^2})
			\and
			\expr^1 * \expr^2 \geq 0 ~ (\square)
		}
		{
		    \trsenv, \expr^1 * \expr^2
		    \trsto
		    \big(
		    \expr^1 * \expr^2,
		    (\frac{\ubar{\expr}}{(1 + \eta)}, 
		        (\bar{\expr})(1 + \eta))
		    \big)
		}
	\]
	}
	%
	We need to show: for $\expr^1 * \expr^2 \fbigstep \fval$, 
	$\frac{\ubar{\expr}}{(1 + \eta)} \rbigstep \ubar{\rval}$ 
	and $(\bar{\expr})(1 + \eta) \rbigstep \bar{\rval}$, the $\ubar{\rval} \leq \fval \leq \bar{\rval}$ holds.\\
	%
	By induction hypothesis on $(\diamond)$ and $(\triangle)$, we have:\\
	%
	(1) for $\expr^1 \fbigstep \fval_1$, 
	$\ubar{\expr^1} \rbigstep \ubar{\rval_1}$ 
	and $\bar{\expr^1} \rbigstep \bar{\rval_1}$,
	the $\ubar{\rval_1} \leq \fval_1 \leq \bar{\rval_1}$ holds.\\
	%
	(2) for $\expr^2 \fbigstep \fval_2$, 
	$\ubar{\expr^2} \rbigstep \ubar{\rval_2}$ 
	and $\bar{\expr^2} \rbigstep \bar{\rval_2}$,
	the $\ubar{\rval_2} \leq \fval_2 \leq \bar{\rval_2}$ holds.\\
	%
	Let $\bar{\rval'} = 
	\min(\bar{\rval_2} \bop \bar{\rval_1}, 
	\ubar{\rval_2} \bop \bar{\rval_1},
	\bar{\rval_2} \bop \ubar{\rval_1},
	\ubar{\rval_2} \bop \ubar{\rval_1})$ and 
	%
	$\ubar{\rval'} = 
	\max(\bar{\rval_2} \bop \bar{\rval_1}, 
	\ubar{\rval_2} \bop \bar{\rval_1},
	\bar{\rval_2} \bop \ubar{\rval_1},
	\ubar{\rval_2} \bop \ubar{\rval_1})
	$\\
	%
	By (1) and (2), we have:
	$\ubar{\rval'}
	\leq \fval_2 \bop \fval_1
	\leq \bar{\rval'}$.\\
	%
	By hypothesis $(\square)$ and relative error of floating point rounding, we have:\\
	%
	$\frac{\ubar{\rval'}}{1 + \eta}
	\leq \floaten(\fval_2 \bop \fval_1)
	\leq (\bar{\rval'})(1 + \eta)$.\\
	%
	By evaluation rule FBOP and RBOP, we have:\\
	%
	$\expr^1 * \expr^2 \fbigstep \floaten(\fval_2 \bop \fval_1)$, 
	%
	$\frac{\ubar{\expr}}{(1 + \eta)} 
	\rbigstep \frac{\ubar{\rval'}}{1 + \eta}$ 
	%
	and $(\bar{\expr})(1 + \eta) \rbigstep (\bar{\rval'})(1 + \eta)$.\\
	%
	This case is proved.
	%
	\subcaseL
	{
	\[
	\inferrule*[right = bop-neg]
		{
			\trsenv, \expr^1 \trsto 
			(\expr, (\ubar{\expr^1}, \bar{\expr^1}))
			\and
			\trsenv, \expr^2 \trsto 
			(\expr, (\ubar{\expr^2}, \bar{\expr^2}))
			\\
		\bar{\expr}, \ubar{\expr} = 
		\max, \min(\ubar{\expr^1} * \ubar{\expr^2}, 
		\bar{\expr^1} * \ubar{\expr^2}, 
		\ubar{\expr^1} * \bar{\expr^2}, 
		\bar{\expr^1} * \bar{\expr^2})
			\and
			\expr^1 * \expr^2 < 0
		}
		{
		    \trsenv, \expr^1 * \expr^2
		    \trsto
		    \big(\expr^1 * \expr^2,
		    (\bar{\expr})(1 + \eta),
		    \frac{\ubar{\expr}}{(1 + \eta)}
		    \big)
		}
	\]
	}
	%
	%
	We need to show: for $\expr^1 * \expr^2 \fbigstep \fval$, 
	$(\ubar{\expr})(1 + \eta) \rbigstep \ubar{\rval}$
	%
	and $\frac{\bar{\expr}}{(1 + \eta)} \rbigstep \bar{\rval}$, the $\ubar{\rval} \leq \fval \leq \bar{\rval}$ holds.\\
	%
	By induction hypothesis on $(\diamond)$ and $(\triangle)$, we have:\\
	%
	(1) for $\expr^1 \fbigstep \fval_1$, 
	$\ubar{\expr^1} \rbigstep \ubar{\rval_1}$ 
	and $\bar{\expr^1} \rbigstep \bar{\rval_1}$,
	the $\ubar{\rval_1} \leq \fval_1 \leq \bar{\rval_1}$ holds.\\
	%
	(2) for $\expr^2 \fbigstep \fval_2$, 
	$\ubar{\expr^2} \rbigstep \ubar{\rval_2}$ 
	and $\bar{\expr^2} \rbigstep \bar{\rval_2}$,
	the $\ubar{\rval_2} \leq \fval_2 \leq \bar{\rval_2}$ holds.\\
	%
	Let $\bar{\rval'} = 
	\min(\bar{\rval_2} \bop \bar{\rval_1}, 
	\ubar{\rval_2} \bop \bar{\rval_1},
	\bar{\rval_2} \bop \ubar{\rval_1},
	\ubar{\rval_2} \bop \ubar{\rval_1})$ and 
	%
	$\ubar{\rval'} = 
	\max(\bar{\rval_2} \bop \bar{\rval_1}, 
	\ubar{\rval_2} \bop \bar{\rval_1},
	\bar{\rval_2} \bop \ubar{\rval_1},
	\ubar{\rval_2} \bop \ubar{\rval_1})
	$\\
	%
	By (1) and (2), we have:
	$\ubar{\rval'}
	\leq \fval_2 \bop \fval_1
	\leq \bar{\rval'}$.\\
	%
	By hypothesis $(\square)$ and relative error of floating point rounding, we have:\\
	%
	$\ubar{\rval'}(1 + \eta)
	\leq \floaten(\fval_2 \bop \fval_1)
	\leq \frac{\bar{\rval'}}{1 + \eta}$.\\
	%
	By evaluation rule FBOP and RBOP, we have:\\
	%
	$\expr^1 * \expr^2 \fbigstep \floaten(\fval_2 \bop \fval_1)$, 
	%
	$\ubar{\expr}(1 + \eta) \rbigstep \ubar{\rval'}(1 + \eta)$
	%
	and $\frac{\bar{\expr}}{(1 + \eta)} 
	\rbigstep \frac{\bar{\rval'}}{1 + \eta}$ .\\
	%
	This case is proved.
	%
    %         	%
	\subcaseL
	{
	\[
	\inferrule*[right = uop]
		{
			\trsenv, \expr 
			\trsto (\expr, \ubar{\expr}, \bar{\expr})
			~(\diamond)
			\and
			\uop (\expr) \geq 0
			~ (\square)
		}
		{
		    \trsenv, \uop(\expr)
		    \trsto
		    \big(\uop(\expr),
		    \frac{\uop(\ubar{\expr})}{(1 + \eta)}, 
		    (\uop(\bar{\expr}))(1 + \eta)
		    \big)
		}
	\]
	}
	%
	We need to show: 
	%
	for $\uop(\expr) \fbigstep \fval$, 
	$\frac{\uop(\ubar{\expr})}{(1 + \eta)} \rbigstep \ubar{\rval}$ 
	and $\uop(\bar{\expr})(1 + \eta) \rbigstep \bar{\rval}$,
	the $\ubar{\rval} \leq \fval \leq \bar{\rval}$ holds.\\
	%
	By induction hypothesis on $(\diamond)$, we have:\\
	%
	(1) for $\expr \fbigstep \fval'$, 
	$\ubar{\expr} \rbigstep \ubar{\rval'}$ 
	and $\bar{\expr} \rbigstep \bar{\rval'}$,
	the $\ubar{\rval'} \leq \fval \leq \bar{\rval'}$ holds.\\
	%
	%
	By (1) and monotone of unary operations, we have:
	$\uop(\ubar{\rval'})
	\leq \uop(\fval')
	\leq \uop(\bar{\rval'})$.\\
	%
	By hypothesis $(\square)$ and relative error of floating point rounding, we have:\\
	%
	$\frac{\uop(\ubar{\rval'})}{1 + \eta}
	\leq \floaten(\uop(\fval'))
	\leq \uop(\bar{\rval'})(1 + \eta)$.\\
	%
	By evaluation rule FBOP and RBOP, we have:\\
	%
	$\uop(\fval') \fbigstep \floaten(\uop(\fval'))$, 
	%
	$\frac{\uop(\ubar{\expr})}{1 + \eta} 
	\rbigstep \frac{\uop(\ubar{\rval'})}{1 + \eta}$ 
	%
	and $\uop(\bar{\expr})(1 + \eta) 
	\rbigstep \uop(\bar{\rval'})(1 + \eta)$.\\
	%
	This case is proved.
	%
	\subcaseL
	{
	\[
	\inferrule*[right = uop-neg]
		{
			\trsenv, \expr \trsto (\expr, \ubar{\expr}, \bar{\expr})
			\and
			\uop (\expr) < 0
		}
		{
		    \trsenv, \uop(\expr)
		    \trsto 
		    \big(\uop(\expr),
		    (\uop(\ubar{\expr}))(1 + \eta),
		    \frac{\uop(\bar{\expr})}{(1 + \eta)}
		    \big)
		}
	\]
	}
	%
	We need to show: 
	%
	for $\uop(\expr) \fbigstep \fval$, 
	$\uop(\ubar{\expr})(1 + \eta) \rbigstep \ubar{\rval}$
	and $\frac{\uop(\bar{\expr})}{(1 + \eta)} \rbigstep \bar{\rval}$,
	the $\ubar{\rval} \leq \fval \leq \bar{\rval}$ holds.\\
	%
	By induction hypothesis on $(\diamond)$, we have:\\
	%
	(1) for $\expr \fbigstep \fval'$, 
	$\ubar{\expr} \rbigstep \ubar{\rval'}$ 
	and $\bar{\expr} \rbigstep \bar{\rval'}$,
	the $\ubar{\rval'} \leq \fval \leq \bar{\rval'}$ holds.\\
	%
	%
	By (1) and monotone of unary operations, we have:
	$\uop(\ubar{\rval'})
	\leq \uop(\fval')
	\leq \uop(\bar{\rval'})$.\\
	%
	By hypothesis $(\square)$ and relative error of floating point rounding, we have:\\
	%
	$\uop(\ubar{\rval'})(1 + \eta)
	\leq \floaten(\uop(\fval'))
	\leq \frac{\uop(\bar{\rval'})}{1 + \eta}$.\\
	%
	By evaluation rule FBOP and RBOP, we have:\\
	%
	$\uop(\fval') \fbigstep \floaten(\uop(\fval'))$, 
	%
	$\uop(\ubar{\expr})(1 + \eta) 
	\rbigstep \uop(\ubar{\rval'})(1 + \eta)$
	%
	and $\frac{\uop(\bar{\expr})}{1 + \eta} 
	\rbigstep \frac{\uop(\bar{\rval'})}{1 + \eta}$ .\\
	%
	Let $\fval = \floaten(\uop(\fval'))$,
	$\ubar{\rval} = \uop(\ubar{\rval'})(1 + \eta)$ and $\bar{\rval} = \frac{\uop(\bar{\rval'})}{1 + \eta}$, this case is proved.
	%
	\end{itemize}
	%
\end{itemize}
%
\end{proof}

\newpage
\section{Snapping Mechanism}

\begin{defn}
[$\snap(a) : A \to \distr(\real)$]
Given privacy parameter $\epsilon$, the Snapping mechanism $\snap(a)$ is defined as:
\[
	U \samplel \edistr; S \samplel \{-1, 1\};
	y = f(a) + S \times \ln (U) \div \epsilon;
	z = \clamp_B \big(
	\round{y}_{\Lambda}
	\big)
\]
where $F$ is a primitive query function over input database $a \in A$, $\epsilon$ is the privacy budget, $B$ is the clamping bound and $\Lambda$ is the rounding argument satisfying $\lambda = 2^k$ where $2^k$ is the smallest power of 2 greater or equal to the $\frac{1}{\epsilon}$.
%
\\
%
Let $\snap'(a)$ be the same as $\snap(a)$ given $U, S$ without rounding and clamping steps, i.e., $\snap'(a): y = f(a) + S \times \ln (U) \div \epsilon$.
%
\\
%
Let $\snap''(a)$ be the same as $\snap(a)$ given $U, S$, i.e., $\snap''(a): 
\snap'(a); z = \clamp_B \big( \round{y}_{\Lambda} \big)$.
\end{defn}


% \begin{defn}
% [$\snap(a) : A \to \distr(\real)$]
% Given privacy parameter $\epsilon$, the floating point implemented
% Snapping mechanism $\snap(a)$ is defined as (where all parameters are defined the same as above):
% \[
% 	u_{\mathbb{F}} \xleftarrow{\$} \edistr;
% 	s_{\mathbb{F}} \samplel \{-1, 1\};
% 	z = \clamp_B \big(
% 	\round{f(a) \oplus s \otimes \oln (u) \odiv \epsilon}_{\Lambda}
% 	\big)
% \]
% Let $\snap'(a)$ be the same as $\snap(a)$ without rounding and clamping steps given $u, s$.
% \end{defn}



\newpage
\section{Main Theorem}

\begin{thm}[The $\snap$ mechanism is $\epsilon-$differentially private]
Consider $\snap(a)$ defined as before, if $\snap(a) = x$ given database $a$ and privacy parameter $\epsilon$, then its actual privacy loss is bounded by $\epsilon + 23 B \epsilon \eta$.
\end{thm}

\begin{proof}
%
%
Given $\snap(a) = x$ and parameter $\epsilon$, we consider $a'$ be the adjacent database of $a$ satisfying $|f(a) - f(a')| \leq 1$.
Without loss of generalization, we assume $f(a) + 1 = f(a') ~ (\diamond)$.
%

%
Consider the $\snap(a)$ outputting the same result $x$ under floating point and real computaion, let $(L, R)$ be the range where $\forall u \in (L, R)$ and some $s$ s.t.:
%
$$[U \mapsto u, S \mapsto s],\snap''(a) \rbigstep [z \mapsto \varx].$$
%
We have $\Pr[\snap(a) = \varx] = R - L$. Sice the $\snap(a)$ is $\epsilon-$DP, we can get:
\[
	e^{-\epsilon} \leq \frac{\Pr[\snap(a)]}{\Pr[\snap(a')]} = \frac{R - L}{R' - L'} \leq e^{\epsilon}
\]
%
\\
%
Let $(l, r)$ be the range where $\forall u \in (l, r)$ and some $s$ s.t.: 
%
$$[U \mapsto u, S \mapsto s],\snap''(a) \fbigstep [z \mapsto \varx].$$
%
To show the privacy loss of $\snap$ mechanism in floating point computation is bounded by $\epsilon + 23 B \epsilon \eta$, it’s sufficent to show:
$|r - l|$ is bounded $f(|{R} - {L}|)$ and $g(|{R} - {L}|)$ s.t.:
%
\[
	-(\epsilon + 23 B \epsilon \eta)
	\leq \ln( \frac{f(|{R} - {L}|)}{g(|{R} - {L}|)} )
	\leq \epsilon + 23 B \epsilon \eta.
\]

%
Induction on the outputspace of $\snap(a)$ mechanism, we have following cases:
	%
	\begin{itemize}
		%
		% \item[\textbf{case}] $\boldsymbol{x = -B}$
		\caseL{$\boldsymbol{x = -B}$}
		%
		Let $b$ be the largest number rounded by $\Lambda$ that is smaller than $B$, $b' = b - \Lambda / 2$.
		%
		\\
		%
		Let $L$ and $R$ be the range where $\forall u \in (L, R)$ and $s = 1$, s.t.
		$[U \mapsto u, S \mapsto s],\snap''(a) \rbigstep [z \mapsto \varx]$.
		%
		\\
		%
		Let $l$ and $r$ be the range where $\forall u \in (l, r)$ and $s = 1$, s.t.
		$[U \mapsto u, S \mapsto s],\snap''(a) \fbigstep [z \mapsto \varx]$.
		%
		\\
		%
		So we know $s = 1$, $l = L = 0$, $\ubar{R} < r < \bar{R}$ s.t.:
		$$[U \mapsto r, S \mapsto 1], \snap'(a) \fbigstep [y \mapsto -b']
		\land
		[U \mapsto R, S \mapsto 1], \snap'(a) \rbigstep [y \mapsto -b'].$$
		%
		%
		The derivation of this case given $\trsenv = [U \mapsto (R, (\ubar{R}, \bar{R})), S \mapsto (1, (1, 1))]$ is shown as following:
		% \begin{figure}
		\begin{mathpar}
		\inferrule[uop]
		{
			\inferrule*[right = val-eq]
			{
				\empty
			}
			{
				\trsenv, U 
				\trsto
				(R,
				(\ubar{R}, \bar{R}))
			}
		}
		{
			\inferrule[bop]
			{
				\trsenv,
				\ln(U) 
				\trsto
				(\ln(R), \ln(\ubar{R})(1 + \eta),
				\frac{\ln(\bar{R})}{(1 + \eta)})
			}
			{
				\inferrule[bop]
				{
					\trsenv,
					\frac{1}{\epsilon} \times \ln(U) 
					\trsto
					(\frac{1}{\epsilon} \times \ln(R),
					((\frac{1}{\epsilon} \times \ln(\ubar{R}))(1 + \eta)^2,
					%
					\frac{\frac{1}{\epsilon} \times \ln(\bar{R})}{(1 + \eta)^2}))
				}
				{
					\inferrule[id]
					{
						\trsenv,
						f(a) + \frac{1}{\epsilon} \times \ln(U)
						\trsto
						\bigg(
						f(a) + \frac{1}{\epsilon} \times \ln(R),
						\big( (f(a) + 
						(\frac{1}{\epsilon} \times \ln(\ubar{R}))
						(1 + \eta)^2)
						{(1 + \eta)},
						%
						\frac{(
						f(a) + \frac{\frac{1}{\epsilon} \times \ln(\bar{R})}
						{(1 + \eta)^2}
						)}
						{(1 + \eta)}
						 \big)
						\bigg)
					}
					{
						\trsenv,\snap'(a)
						\trsto
						\trsenv[y \mapsto \bigg(
						f(a) + \frac{1}{\epsilon} \times \ln(R),
						\big( (f(a) + 
						(\frac{1}{\epsilon} \times \ln(\ubar{R}))
						(1 + \eta)^2)
						{(1 + \eta)},
						%
						\frac{(
						f(a) + \frac{\frac{1}{\epsilon} \times \ln(\bar{R})}
						{(1 + \eta)^2}
						)}
						{(1 + \eta)} \big)
						\bigg)
						]
					}
				}
			}
		}
		\end{mathpar}
		%
		%
		% 
		%
		In the same way, we have the derivation for $\snap'(a')$:
		\begin{mathpar}
		\inferrule
		{
			\dots
		}
		{
			\trsenv, \snap'(a'); \snap''
			\trsto
			\trsenv[
			y \mapsto 
			\bigg(\snap'(a'),
			\big( (f(a') + 
			(\frac{1}{\epsilon} \times \ln(\ubar{R'}))
			(1 + \eta)^2)
			{(1 + \eta)},
			%
			\frac{(
			f(a') + \frac{\frac{1}{\epsilon} \times \ln(\bar{R'})}
			{(1 + \eta)^2}
			)}
			{(1 + \eta)} \big)
			\bigg)
			]
		}
		\end{mathpar}
		%
		%
		Given $\snap(a') \fbigstep -b'$, $\snap(a) \fbigstep -b'$, we have the worst case lower and upper bounds for $R$ and $R'$, which are $\ubar{R}, \bar{R}, \ubar{R'}$ and $\bar{R'}$:
		%
		%
		\[
		\begin{array}{c}
		\ubar{R} = e^{\epsilon 
		\big( (-b'(1 + \eta) - f(a)) (1 + \eta)^2) \big)},
		%
		\bar{R} = e^{\epsilon 
		\frac{(\frac{-b'}{1 + \eta} - f(a))}{(1 + \eta)^2}}
		\\
		%
		\ubar{R'} = e^{\epsilon 
		\big((-b'(1 + \eta) - f(a'))(1 + \eta)^2 \big)},
		%
		\bar{R'} = e^{\epsilon 
		(\frac{(\frac{-b'}{1 + \eta} - f(a'))}{(1 + \eta)^2})}
		\end{array}
		\]
		%		
		The privacy loss of $\snap(a)$ in this case is bounded by:
		%
		\[
		\begin{array}{ll}
		\frac
		{\frac{1}{2}(\bar{R} - 0)}
		{\frac{1}{2}(\ubar{R'} - 0)}
		& = e^{\epsilon
		\bigg(
		\frac{(\frac{-b'}{1 + \eta} - f(a))}{(1 + \eta)^2}
		-
		\big((-b'(1 + \eta) - f(a'))(1 + \eta)^2 \big)
		\bigg)}\\
		& = e^{\epsilon
		\bigg(
		\frac{-b'}{(1 + \eta)^3} - \frac{f(a)}{(1 + \eta)^2}
		-
		x(1 + \eta)^3 + f(a')(1 + \eta)^2 
		\bigg)} ~ (\star)
		\end{array}
		\]
		%
		Since $ (1 + \eta)^3 > 1 + 3\eta$,  $\frac{1}{(1 + \eta)^3} < \frac{1}{1 + 3\eta} $, $(1 + \eta)^2 < 1 + 2.1\eta$ and $\frac{1}{(1 + \eta)^2} > 1 - 2 \eta$, we have:
		%
		\[
		\begin{array}{ll}
		(\star) & < e^{\epsilon \big( 
		\frac{9\eta + 6}{1 + 3\eta} b'
		+ 4.1 \eta f(a)
		+ (1 + 2.1\eta) 
		\big)}\\
		%
		& < e^{\epsilon(10.1 \eta B + 1 + 2.1\eta)}
		\end{array}
		\]
		%
		%
		%
		%
		\caseL{$\boldsymbol{x \in (-B, \round{f(a)}_{\Lambda})}$}
		%
		\subcaseL{$\boldsymbol{\round{f(a)}_{\Lambda} \leq 0 \lor \bigg( \round{f(a)}_{\Lambda} > 0 \land x \in (-B, 0) \bigg) } $}
		%
		Let $y_1 = x - (\frac{\Lambda}{2})$, $y_2 = x + (\frac{\Lambda}{2})$, we know $y_1 < 0$, $y_2 < 0$.
		%
		\\
		%
		Let $L = e^{\epsilon(y_1 - f(a))}$ and $R = e^{\epsilon(y_2 - f(a))}$, we have: $\forall u \in (L, R)$:
		$[U \mapsto u, S \mapsto 1],\snap''(a) \rbigstep [z \mapsto \varx]$.
		%
		\\
		%
		Let $l$ and $r$ be the range where $\forall u \in (l, r)$ and $s = 1$, s.t.
		$[U \mapsto u, S \mapsto s],\snap''(a) \fbigstep [z \mapsto \varx]$.
		%
		\\
		%
		So we know: $\ubar{L} < l < \bar{L}$, $\ubar{R} < r < \bar{R}$ s.t.:
		%
		$$[U \mapsto l, S \mapsto 1], \snap'(a) \fbigstep [y \mapsto y_1]
		\land
		[U \mapsto r, S \mapsto 1], \snap'(a) \fbigstep [y \mapsto y_2].$$

		The transition from $R$ to $r$ given the transition environment 
		$\trsenv = [U \mapsto (R, (\ubar{R}, \bar{R})), S \mapsto (1, (1, 1))]$ is shown as following:
		%
		\begin{mathpar}
		\inferrule[ln]
		{
			\inferrule*[right = val-eq]
			{
				\empty
			}
			{
				\trsenv, R 
				\trsto
				(R, (\ubar{R}, \bar{R})
			}
		}
		{
			\inferrule[op]
			{
				\trsenv, \ln(U) 
				\trsto
				(\ln(R) ,
				(\ln(\ubar{R})(1 + \eta),
				\frac{\ln(\bar{R})}{(1 + \eta)}))
			}
			{
				\inferrule[op]
				{
					\trsenv, \frac{1}{\epsilon} \times \ln(U) 
					\trsto
					\big(
					\frac{1}{\epsilon} \times \ln(R)
					,
					((\frac{1}{\epsilon} \times \ln(\ubar{R}))(1 + \eta)^2,
					%
					\frac{\frac{1}{\epsilon} \times \ln(\bar{R})}{(1 + \eta)^2})
					\big)
				}
				{
					\inferrule[id]
					{
					\trsenv,f(a) + \frac{1}{\epsilon} \times \ln(U)
						\trsto
						\Big(
						f(a) + \frac{1}{\epsilon} \times \ln(R)
						,
						\bigg(
						\big( f(a) + 
						(\frac{1}{\epsilon} \times \ln(\ubar{R}))
						(1 + \eta)^2 \big)
						{(1 + \eta)},
						%
						\frac{(
						f(a) + \frac{\frac{1}{\epsilon} \times \ln(\bar{R})}
						{(1 + \eta)^2}
						)}
						{(1 + \eta)}
						\bigg)
						\Big)
					}
					{
						\trsenv, \snap'(a)
						\trsto
						\trsenv
						[y \mapsto 
						(f(a) + \frac{1}{\epsilon} \times \ln(R),
						(\expr^1,
						%
						\expr^2))]
					}
				}
			}
		}
		\end{mathpar}
		From soundness theorem, we have  $\expr^1 \leq y_2 \leq \expr^2$, where we can get:
		%
		\\ 
		$\ubar{R} = e^{\epsilon 
				\big( (y_1(1 + \eta) - f(a)) (1 + \eta)^2) \big)}$ and
		%
		$\bar{R} = e^{\epsilon 
				\frac{(\frac{y_1}{1 + \eta} - f(a))}{(1 + \eta)^2}}$.
		%
		The transition from $L$ to $l$ given the transition environment 
		$\trsenv = [U \mapsto (L, (\ubar{L}, \bar{L})), S \mapsto (1, (1, 1))]$ is shown as following:
		%
		\begin{mathpar}
		\inferrule
		{
		\dots
		}
		{
		 \trsenv, \snap'(a)
		 \trsto
		 \trsenv[
		 z \mapsto(
		 f(a) + (\frac{1}{\epsilon} \times \ln(\ubar{L})
		 ,
		 \big(
		 \frac{f(a) + 
		 (\frac{1}{\epsilon} \times \ln(\ubar{L}))
		 (1 + \eta)^2}
		 {1 + \eta},
		 %
		 (
		 f(a) + \frac{\frac{1}{\epsilon} \times \ln(\bar{ L})}
		 {(1 + \eta)^2}
		 )(1 + \eta)
		 )
		 \big)
		 ]
		}
		\end{mathpar}
		%
		From soundness theorem, we have  $\err_1 \leq y_2 \leq \err_2$.\\
		%
		%
		Taking the lower bound , we have:
		$\ubar{L} = e^{\epsilon 
				\big( (y_2(1 + \eta) - f(a)) (1 + \eta)^2) \big)}$.\\
		%
		Taking the upper bound, we have: 
		$\bar{L} = e^{\epsilon 
				\frac{(\frac{y_2}{1 + \eta} - f(a))}{(1 + \eta)^2}}$.

		In the same way, we have the bound of $l, r$ for adjacent data set $a'$:

		$$\ubar{R'} = e^{\epsilon 
				\big( (y_1(1 + \eta) - f(a')) (1 + \eta)^2) \big)},  ~
		\bar{R'} = e^{\epsilon 
				\frac{(\frac{y_1}{1 + \eta} - f(a'))}{(1 + \eta)^2}}.$$
		%
		%
		$$ 
		\ubar{L'} = e^{\epsilon 
				\big( (y_2(1 + \eta) - f(a')) (1 + \eta)^2) \big)}, ~ 
		\bar{L'} = e^{\epsilon 
				\frac{(\frac{y_2}{1 + \eta} - f(a'))}{(1 + \eta)^2}}$$

		Then, we have the privacy loss is bounded by:
		\[
		\frac{|\bar{R} - \ubar{L}|}{|\ubar{R'} - \bar{L'}|}.		
		\]
		%
		We also have:
		\[
		\begin{array}{ll}
		\frac{\bar{R}}{R} 
		& = e^{\epsilon
		\big(\frac{y_1}{(1 + \eta)^3} - \frac{f(a)}{(1 + \eta) ^2} 
		- y_1 + f(a) \big)}
		 \leq e^{\epsilon
		\big(- \frac{3 \eta}{1 +3 \eta}y_1 + 2 \eta f(a) \big)}
		 \leq e^{\epsilon
		\big(\frac{3 \eta}{1 +3 \eta}B + 2 \eta B \big)}
		\leq e^{5 \epsilon B \eta}\\
%
		\frac{\ubar{L}}{L} 
		& = e^{\epsilon
		\big({y_2}{(1 + \eta)^3} - {f(a)}{(1 + \eta) ^2} 
		- y_2 + f(a) \big)}
		 \geq e^{\epsilon
		\big({3 \eta}y_1 - 2 \eta f(a) \big)}
		\geq e^{-5 \epsilon B \eta}\\
		\end{array}
		\]
		%
		Then, we can derive:
		%
		\[
		\begin{array}{ll}
		|\bar{R} - \ubar{L}| 
		& \leq e^{5 \epsilon B \eta}R - e^{-5 \epsilon B \eta} L \\
		& = L \big(  e^{ \Lambda\epsilon + 5 \epsilon B \eta} 
		- e^{-5 \epsilon B \eta} \big)\\
		& = L \big( e^{ \Lambda\epsilon} e^{5 \epsilon B \eta}
		-e^{5 \epsilon B \eta}
		+  e^{5 \epsilon B \eta}
		- e^{-5 \epsilon B \eta} \big)\\
		& = L \big( e^{ \Lambda\epsilon} e^{5 \epsilon B \eta}
		- e^{5 \epsilon B \eta}
		+  \frac{1}{(e^{ \Lambda\epsilon} - 1)}
		(e^{ \Lambda\epsilon} - 1)e^{5 \epsilon B \eta}
		- e^{-5 \epsilon B \eta} \big)\\
		& \leq L \big( e^{ \Lambda\epsilon} e^{5 \epsilon B \eta}
		- e^{5 \epsilon B \eta}
		+  \frac{1}{(e - 1)}
		(e^{ \Lambda\epsilon} - 1)e^{5 \epsilon B \eta}
		- e^{-5 \epsilon B \eta} \big) ~( by 1 \leq \Lambda \epsilon < 2)\\ 
		& = L  \frac{e}{(e - 1)} \big( e^{ \Lambda\epsilon} e^{5 \epsilon B \eta}
		- e^{5 \epsilon B \eta}
		- e^{-5 \epsilon B \eta} \big)\\
		& < L  \frac{e}{(e - 1)} \big( e^{ \Lambda\epsilon} e^{5 \epsilon B \eta}
		- e^{5 \epsilon B \eta} \big)\\
		& = L (e^{ \Lambda\epsilon} -  1) e^{\ln(\frac{e}{(e - 1)}) + 5 \epsilon B \eta}\\
		& < L (e^{ \Lambda\epsilon} -  1)e^{11 \epsilon B \eta}~ (by ~ ( \frac{1}{\epsilon} < B < 2^{42} \frac{1}{\epsilon} )) \\
		& = (R - L)e^{11 \epsilon B \eta}
		\end{array}
		\]
		In the same way, we can derive:
		\[
		|\ubar{R} - \bar{L}| > e^{-5 \epsilon B\eta} R - e^{5 \epsilon B\eta} L
		> (R - L)e^{- 12 \epsilon B \eta}
		\]
		Then we have:
		\[
		\frac{|\bar{R} - \ubar{L}|}{|\ubar{R'} - \bar{L'}|}
		< e^{(23 \epsilon B \eta + \epsilon)}.		
		\]
%
		\subcaseL{$\boldsymbol{\round{f(a)}_{\Lambda} > 0 \land x \in (0, \round{f(a)}_{\Lambda}) } $}
		%

		Let $y_1 = x - (\frac{\Lambda}{2})$, $y_2 = x + (\frac{\Lambda}{2})$, we know $y_1 > 0$, $y_2 > 0$.
		%
		\\
		%
		Let $S = 1$, $L = e^{\epsilon(y_1 - f(a))}$ and $R = e^{\epsilon(y_2 - f(a))}$, we have $\forall u \in (L, R)$:
		$[U \mapsto u, S \mapsto 1],\snap''(a) \rbigstep [z \mapsto \varx]$.
		%
		\\
		%
		Let $l$ and $r$ be the range where $\forall u \in (l, r)$ and $s = 1$, s.t.
		$[U \mapsto u, S \mapsto s],\snap''(a) \fbigstep [z \mapsto \varx]$.
		%
		\\
		%
		We know: $\ubar{L} < l < \bar{L}$, $\ubar{R} < r < \bar{R}$ s.t.:
		%
		$$[U \mapsto l, S \mapsto 1], \snap'(a) \fbigstep [y \mapsto y_1]
		\land
		[U \mapsto r, S \mapsto 1], \snap'(a) \fbigstep [y \mapsto y_2].$$

		The transition from $L$ to $l$ given the transition environment 
		$\trsenv = [U \mapsto (L, (\ubar{L}, \bar{L})), S \mapsto (1, (1, 1))]$ is shown as following:
		% in Figure. \ref{fig_der_snap2}
		% \begin{figure}
		\begin{mathpar}
		\inferrule
		{
			\trsenv, U 
			\trsto
			(
			L,
			(\ubar{L}, \bar{L})
			)
		}
		{
			\inferrule
			{
				\trsenv, \ln(U) 
				\trsto
				(\ln(L),
				(\ln(\ubar{L})(1 + \eta),
				\frac{\ln(\bar{L})}{(1 + \eta)}))
			}
			{
				\inferrule
				{
					\trsenv, \frac{1}{\epsilon} \times \ln(U) 
					\trsto
				\big(
				\frac{1}{\epsilon} \times \ln(L) 
					,
					((\frac{1}{\epsilon} \times \ln(\ubar{L}))(1 + \eta)^2,
					%
					\frac{\frac{1}{\epsilon} \times \ln(\bar{L})}{(1 + \eta)^2})
					\big)
				}
				{
					\inferrule
					{
						\trsenv, f(a) + \frac{1}{\epsilon} \times \ln(U) 
						\trsto
						\big(
						f(a) + \frac{1}{\epsilon} \times \ln(l)
						,
						(
						\frac{f(a) + 
						(\frac{1}{\epsilon} \times \ln(\ubar{L}))
						(1 + \eta)^2}
						{1 + \eta},
						%
						(
						f(a) + \frac{\frac{1}{\epsilon} \times \ln(\bar{L})}
						{(1 + \eta)^2}
						)(1 + \eta)
						)
						\big)
					}
					{
					\trsenv, \snap'(a)
					\trsto
					\trsenv[
					y \mapsto 
					(f(a) + \frac{1}{\epsilon} \times \ln(L)
					,
					(
					\err_1,
					%
					\err_2
					))
					}
				}
			}
		}
		\end{mathpar}
		%
		%
		From soundness theorem, we have  $\err_1 \leq y_1 \leq \err_2$, then we can get:
		%
		\\
		$\ubar{L} = e^{(y_1 / (1 + \eta) - f(a))(1 + \eta)^2\epsilon}$ and
		$\bar{L} = e^{(y_1 (1 + \eta) - f(a))\epsilon/(1 + \eta)^2}$.
		%
		%
		The transition from $R$ to $r$ given the transition environment 
		$\trsenv = [U \mapsto (R, (\ubar{R}, \bar{R})), S \mapsto (1, (1, 1))]$ is shown as following:
%
%
		\begin{mathpar}
		\inferrule
		{
			\dots
		}
		{
   		\trsenv, \snap'(a)
   		\trsto
   		\trsenv[y \mapsto 
   		\big(
   		f(a) + \frac{1}{\epsilon} \times \ln(R)
   		,
   		(
   		\frac{f(a) + 
   		(\frac{1}{\epsilon} \times \ln(\ubar{R}))
   		(1 + \eta)^2}
   		{1 + \eta},
   		%
   		(
   		f(a) + \frac{\frac{1}{\epsilon} \times \ln(\bar{R})}
   		{(1 + \eta)^2}
   		)(1 + \eta)
   		)\big)
   		]
		}
		\end{mathpar}
		%
		From soundness theorem, we have  $\err_1 \leq y_2 \leq \err_2$.
		%
\\
		%
		Taking the lower bound (i.e. $\err_1 = y_2$), we have:
		$\ubar{R} = e^{(y_2 / (1 + \eta) - f(a))(1 + \eta)^2\epsilon}$.
		Taking the upper bound (i.e. $\err_2 = y_1$), we have:
		$\bar{R} = e^{(y_2 (1 + \eta) - f(a))\epsilon/(1 + \eta)^2}$.
		%

		%
		For the adjacent input $a$, we first have the same setting as input $a$ for $R'$ and $L'$.
		Then the transition from $L'$ to $l'$ given the transition environment 
		$\trsenv = [U \mapsto (L', (\ubar{L'}, \bar{L'})), S \mapsto (1, (1, 1))]$ is shown as following:
		\begin{mathpar}
		\inferrule
		{
			\dots
		}
		{
			\trsenv, \snap'(a')
			\trsto
			\trsenv[ y \mapsto
			\big(f(a) + \frac{1}{\epsilon} \times \ln(L')
			,
			(
			\frac{f(a') + 
			(\frac{1}{\epsilon} \times \ln(\ubar{L'}))
			(1 + \eta)^2}
			{1 + \eta},
			%
			(
			f(a') + \frac{\frac{1}{\epsilon} \times \ln(\bar{L'})}
			{(1 + \eta)^2}
			)(1 + \eta)
			)\big)
			]
		}
		\end{mathpar}
		%
		From soundness theorem, we have  $\err_1 \leq y_2 \leq \err_2$.
		%

		Taking the lower bound (i.e. $\err_1 = y_1$), we get:
		$\ubar{L'} = e^{(y_1 / (1 + \eta) - f(a'))(1 + \eta)^2\epsilon}$.
		%
		Taking the upper bound (i.e. $\err_2 = y_1$), we get:
		$\bar{L'} = e^{(y_1 (1 + \eta) - f(a'))\epsilon/(1 + \eta)^2}$.
		%
		%
		The transition from $R'$ to $r'$ given the transition environment 
		$\trsenv = [U \mapsto (R', (\ubar{R'}, \bar{R'})), S \mapsto (1, (1, 1))]$ is shown as following:
		\begin{mathpar}
		\inferrule
		{
			\dots
		}
		{
			\trsenv, \snap'(a')
			\trsto
			\trsenv[y \mapsto
			\big(f(a) + \frac{1}{\epsilon} \times \ln(R') 
			,
			(
			\frac{f(a') + 
			(\frac{1}{\epsilon} \times \ln(\ubar{R'}))
			(1 + \eta)^2}
			{1 + \eta},
			%
			(
			f(a') + \frac{\frac{1}{\epsilon} \times \ln(\bar{R'})}
			{(1 + \eta)^2}
			)(1 + \eta)
			) \big)
			]
		}
		\end{mathpar}
		From soundness theorem, we have  $\err_1 \leq y_2 \leq \err_2$.
		%

		%
		Taking the lower bound (i.e. $\err_1 = y_2$), we have:
		$\ubar{R'} = e^{(y_2 / (1 + \eta) - f(a'))(1 + \eta)^2\epsilon}$.
		Taking the upper bound (i.e. $\err_2 = y_1$), we have:
		$\bar{R'} = e^{(y_2 (1 + \eta) - f(a'))\epsilon/(1 + \eta)^2}$.
		%
		\\
		%
		%
		%
		We have the privacy loss is bounded by:
		%
		\[
		\frac{|\bar{R} - \ubar{L}|}{|\ubar{R'} - \bar{L'}|}
		\]
		%
\\
		%
		Since the following bound can be proved by using $1 - 2\eta < (1 + \eta)^2 < 1 + 2.1\eta, y_1 > -B, y_2 > -B $ and simple approximation:
		\[
		\bar{R} - \ubar{L} < (R - L) e^{(5B\eta\epsilon)}, 
		\ubar{R'} - \bar{L'} > (R'  - L') e^{-7B\eta \epsilon}
		\]

		We also have the $\snap(a)$ is $\epsilon$-dp:
		\[
		\frac{|R - L|}{|R' - L'|} = e^{\epsilon}
		\]
		So we can get:
		\[
		\frac{|\bar{R} - \ubar{L}|}{|\ubar{R'} - \bar{L'}|}
		< \frac{|R - L|}{|R' - L'|} e^{(12B\eta\epsilon)}
		= e^{(1 + 12B\eta)\epsilon}
		\]		
%
%
		\subcaseL{$\boldsymbol{\round{f(a)}_{\Lambda} > 0 \land x = 0 } $}

		Let $y_1 = x - (\frac{\Lambda}{2})$, $y_2 = x + (\frac{\Lambda}{2})$, we know $y_1 < 0$, $y_2 > 0$.
		\\
		%
		Let $S = 1$, $L = e^{\epsilon(y_1 - f(a))}$ and $R = e^{\epsilon(y_2 - f(a))}$, we have $\forall u \in (L, R)$:
		$[U \mapsto u, S \mapsto 1],\snap''(a) \rbigstep [z \mapsto \varx]$.
		%
		\\
		%
		Let $l$ and $r$ be the range where $\forall u \in (l, r)$ and $s = 1$, s.t.
		$[U \mapsto u, S \mapsto s],\snap''(a) \fbigstep [z \mapsto \varx]$.
		%
		\\
		%
		We know: $\ubar{L} < l < \bar{L}$, $\ubar{R} < r < \bar{R}$ s.t.:
		%
		$$[U \mapsto l, S \mapsto 1], \snap'(a) \fbigstep [y \mapsto y_1]
		\land
		[U \mapsto r, S \mapsto 1], \snap'(a) \fbigstep [y \mapsto y_2].$$
		%
		The transition from $L$ to $l$ given the transition environment 
		$\trsenv = [U \mapsto (L, (\ubar{L}, \bar{L})), S \mapsto (1, (1, 1))]$ is shown as following:
		%
		%
		\begin{mathpar}
		\inferrule
		{
		\dots
		}
		{
		\trsenv, \snap'(a)
		\trsto
		\trsenv[y \mapsto
		\big(
		f(a) + 
		\frac{1}{\epsilon} \times \ln(\ubar{L})
		,
		(
		\frac{f(a) + 
		(\frac{1}{\epsilon} \times \ln(\ubar{L}))
		(1 + \eta)^2}
		{1 + \eta},
		%
		(
		f(a) + \frac{\frac{1}{\epsilon} \times \ln(\bar{L})}
		{(1 + \eta)^2}
		)(1 + \eta)
		) \big)
		]
		}
		\end{mathpar}
		%
		From soundness theorem, we have  $\err_1 \leq y_2 \leq \err_2$.\\
		%
		%
		Taking the lower bound , we have:
		$\ubar{L} = e^{\epsilon 
				\big( (y_2(1 + \eta) - f(a)) (1 + \eta)^2) \big)}$.\\
		%
		Taking the upper bound, we have: 
		$\bar{L} = e^{\epsilon 
				\frac{(\frac{y_2}{1 + \eta} - f(a))}{(1 + \eta)^2}}$.  
		%
		%
		The transition from $R$ to $r$ given the transition environment 
		$\trsenv = [U \mapsto (R, (\ubar{R}, \bar{R})), S \mapsto (1, (1, 1))]$ is shown as following:
		\begin{mathpar}
		\inferrule
		{
		 \dots
		}
		{
		\trsenv, \snap'(a)
		\trsto
		\trsenv[y \mapsto
		\big(
		f(a) + 
		\frac{1}{\epsilon} \times \ln(\ubar{R})
		,
		(
		\frac{f(a) + 
		(\frac{1}{\epsilon} \times \ln(\ubar{R}))
		(1 + \eta)^2}
		{1 + \eta},
		%
		(
		f(a) + \frac{\frac{1}{\epsilon} \times \ln(\bar{R})}
		{(1 + \eta)^2}
		)(1 + \eta)
		) \big)
		]
		}
	   \end{mathpar}
		%
		From soundness theorem, we have  $\err_1 \leq y_2 \leq \err_2$.
		%
		%
		Taking the lower bound (i.e. $\err_1 = y_2$), we have:
		$\ubar{R} = e^{(y_2 / (1 + \eta) - f(a))(1 + \eta)^2\epsilon}$.
		Taking the upper bound (i.e. $\err_2 = y_1$), we have:
		$\bar{R} = e^{(y_2 (1 + \eta) - f(a))\epsilon/(1 + \eta)^2}$.
		%
		Using the bound we proved before, we have the folloing bound on $|\bar{R} - \ubar{L}|$ and $|\ubar{R} - \bar{L}|$:
		%
		\[
		\begin{array}{ll}
		\bar{R} - \ubar{L} 
		& < 
		e^{(2B\eta \epsilon)}R - e^{-5B\eta \epsilon} L < 
		(R - L) e^{6B\eta \epsilon}\\
		\ubar{R} - \bar{L}
		& > e^{(-3B\eta \epsilon)}R - e^{5B\eta \epsilon} L > (R - L) e^{-8B\eta \epsilon},
		\end{array}
		\]

		and privacy loss is bounded by:
		%
		\[
		\frac{|\bar{R} - \ubar{L}|}{|\ubar{R'} - \bar{L'}|}
		< e^{14B\eta \epsilon + \epsilon}
		\]

		%
		\caseL{$\boldsymbol{x = \round{f(a)}_{\Lambda}}$}
		%
		%
		This case can also be split into 3 subcases by: $\round{f(a)}_{\Lambda} < 0$, $\round{f(a)}_{\Lambda} = 0$ and $\round{f(a)}_{\Lambda} > 0$. 
		%
		Without loss of generalization, we consider the worst case where the error propagate in the same direction, i.e. $\round{f(a)}_{\Lambda} < 0$.\\
		%
		From this assumption, let $y_1 = x - \frac{\Lambda}{2}$, $y_2 = x + \frac{\Lambda}{2}$, we know $y_1 < 0$, $y_2 < 0$.
		%
		Since $f(a) + 1 = f(a')$, we also have $\round{f(a)} < \round{f(a')}$.
		So, we know $s$ can only be $1$ for input $a'$ but $s$ can be $1$ or $-1$ for input $a$.
		%
		\\
		%
		%
		For input $a$,
		let $S = s$, $L = e^{\epsilon(y_1 - f(a))}$ and $R = e^{\epsilon(y_2 - f(a))}$, we have $\forall u \in (L, R)$:
		$[U \mapsto u, S \mapsto s],\snap''(a) \rbigstep [z \mapsto \varx]$.
		%
		\\
		%
		Let $l$ and $r$ be the range where $\forall u \in (l, r)$ and $S = s$, s.t.
		$[U \mapsto u, S \mapsto s],\snap''(a) \fbigstep [z \mapsto \varx]$.
		%
		\\
		%
		We know: $\ubar{L} < l < \bar{L}$, $\ubar{R} < r < \bar{R}$ s.t.:
		%
		$$[U \mapsto l, S \mapsto s], \snap'(a) \fbigstep [y \mapsto y_1]
		\land
		[U \mapsto r, S \mapsto s], \snap'(a) \fbigstep [y \mapsto y_2].$$
		%
		Induction on $s$, we have when $s = 1$:
		%
		\\
		%
		The transition from $R$ to $r$ given the transition environment 
		$\trsenv = [U \mapsto (R_{+}, (\ubar{R_{+}}, \bar{R_{+}})), S \mapsto (1, (1, 1))]$ is shown as following:
		%
		\begin{mathpar}
		\inferrule
		{
		 \trsenv, U
		 \trsto
		 R_{+}, ( \ubar{R_{+}}, \bar{R_{+}} )
		}
		{
		 \inferrule
		 {
		  \trsenv, \ln(U)
		  \trsto
		  \big(\ln (R_{+}), 
		  (\ln(\ubar{R_{+}})(1 + \eta), \frac{\ln(\bar{R_{+}})}{1+\eta})
		  \big)
		 }
		 {
		  \inferrule
		  {
		  \trsenv,  \frac{1}{\epsilon}\ln(U)
		   \trsto
		   \bigg(\frac{1}{\epsilon} \times \ln (R_{+}), 
		   \big(
		   \frac{1}{\epsilon}\ln(\ubar{R_{+}})(1 + \eta)^2, 
		   \frac{1}{\epsilon}\frac{\ln(\bar{R_{+}})}{(1+\eta)^2}
		   \big) \bigg)
		  }
		  {
		   \inferrule
		   {
		    \trsenv, f(a) + \frac{1}{\epsilon}\ln(U)
			\trsto
			\bigg(f(a) + \frac{1}{\epsilon} \times \ln (R_{+}), 
			\big(
			(f(a) + \frac{1}{\epsilon}\ln(\ubar{R_{+}})(1 + \eta)^2)(1 + \eta), 
			(f(a) + \frac{1}{\epsilon}\frac{\ln(\bar{R_{+}})}{(1+\eta)^2}) / (1 + \eta) \big)
			\bigg)
		   }
		   {
		   \trsenv, \snap'(a) \trsto 
		   \trsenv[y \mapsto
		   (f(a) + \frac{1}{\epsilon} \times \ln (R_{+}), 
		   (\err_1, \err_2))
		   ]
		   }
		  }
		 }
		}
		\end{mathpar}
		%
		%
		From soundness theorem, we have  $\err_1 \leq y_2 \leq \err_2$. Then we can get following bounds for $r$:\\
		%
		%
		$\ubar{R_+} = e^{\epsilon 
				\big( (y_2(1 + \eta) - f(a)) (1 + \eta)^2) \big)}$, 
		%
		$\bar{R_+} = e^{\epsilon 
				\frac{(\frac{y_2}{1 + \eta} - f(a))}{(1 + \eta)^2}}$.  
		%
		\\
		%
		Since $y_2 = \round{f(a)} + \frac{\Lambda}{2}$, we have $e^{\epsilon 
				\big( (y_2 - f(a))) \big)} > 1$, so actually we know $R = r = 1$.
		%
		% 
		\\
		%
		We can also derive the bound for $l$ in the same way as:\\
		$\ubar{L_+} = e^{\epsilon 
				\big( (y_1(1 + \eta) - f(a)) (1 + \eta)^2) \big)}$, 
		%
		$\bar{L_+} = e^{\epsilon 
				\frac{(\frac{y_1}{1 + \eta} - f(a))}{(1 + \eta)^2}}$.
		%

		% 
		When $s = -1$, we can derive following bounds in the same way for $l$ and $r$:\\
		%
		$\ubar{L_-} = e^{\epsilon 
				\big( (f(a) - y_2(1 + \eta)) (1 + \eta)^2) \big)}$,
		%
		$\bar{L_-} = e^{\epsilon 
				\frac{(f(a) - \frac{y_2}{1 + \eta})}{(1 + \eta)^2}}$.\\
		%
		% 
		$\ubar{R_2} = e^{\epsilon 
				\big( (f(a) - y_1(1 + \eta)) (1 + \eta)^2) \big)}$, 
		%
		$\bar{R_2} = e^{\epsilon 
				\frac{(f(a) - \frac{y_1}{1 + \eta})}{(1 + \eta)^2}}$.\\
		%
		Since $y_1 = \round{f(a)} - \frac{\Lambda}{2}$, 
		%
		we have $e^{\epsilon \big( (f(a) - y_1)) \big)} > 1$, so actually we know $R' = r' = 1$.
		%
		\\
		%
		For input $a'$, we have only one case where $s = 1$, the following bound can be derived:
		%
		\\
		%
		$\ubar{R'} = e^{\epsilon 
				\big( (y_2(1 + \eta) - f(a')) (1 + \eta)^2) \big)}$, 
		%
		$\bar{R'} = e^{\epsilon 
				\frac{(\frac{y_2}{1 + \eta} - f(a'))}{(1 + \eta)^2}}$.  
		% 
		\\
		%
		$\ubar{L'} = e^{\epsilon 
				\big( (y_1(1 + \eta) - f(a')) (1 + \eta)^2) \big)}$, 
		%
		$\bar{L'} = e^{\epsilon 
				\frac{(\frac{y_1}{1 + \eta} - f(a'))}{(1 + \eta)^2}}$.

		% \begin{mathpar}
		% \end{mathpar}

		We have following bounds on their ratios:
		%
		\[
		\frac{\ubar{R_+}}{R_+} = e^{\epsilon 
		\big(
		(1 + \eta)^3 y_2 - (1 + \eta)^2f(a) - y_2 + f(a)
		\big)}
		> e^{-3\epsilon B \eta},
		\frac{\bar{R_+}}{R_+} = e^{\epsilon 
		\big(
		frac{y_2}{(1 + \eta)^3} - \frac{f(a)}{(1 + \eta)^2} - y_2 + f(a)
		\big)}
		< e^{3\epsilon B \eta},
		\]
		%
		The same bound for $L_+$ by substituting $y_2$ with $y_1$, and similar bound for $L', R'$.
		%
		\[
		\frac{\ubar{R'}}{R} = e^{\epsilon 
		\big(
		(1 + \eta)^2f(a) - (1 + \eta)^3 y_2 - f(a) + y_2
		\big)}
		> e^{-2\epsilon B \eta},
		%
		\frac{\bar{R'}}{R'} = e^{\epsilon 
		\big(
		\frac{f(a)}{(1 + \eta)^2} - frac{y_2}{(1 + \eta)^3} - f(a) + y_2
		\big)}
		< e^{2\epsilon B \eta},
		\]
		%
		Using the bound on their ratios, we can get following bounds on $|\bar{R_+} - \ubar{L_+}|$ and $|\ubar{R'} - \bar{L'}|$:
		%
		\[
		|\bar{R_+} - \ubar{L_+}| < e^{3\epsilon B \eta} R - e^{-3\epsilon B \eta}L < (R - L) e^{7\epsilon B \eta},
		%
		|\ubar{R'} - \bar{L'}| > e^{-2\epsilon B \eta} R - e^{2\epsilon B \eta}L > (R' - L') e^{-5\epsilon B \eta}
		\]
		%
		Then we have the following bounds on privacy loss:
		%
		\[
		\frac{2 - (\ubar{L_+} + \ubar{L_-})}{\ubar{R'} - \bar{L'}}
		< \frac{\bar{R_+} - \ubar{L_+}}{\ubar{R'} - \bar{L'}}
		< \frac{e^{7\epsilon B \eta}(R_+ - L_+)}
		{e^{-5\epsilon B \eta} (R' - L')}
		= e^{12\epsilon B \eta + \epsilon}
		\]
		%
		%
		%
		\caseL{$\boldsymbol{x \in (\round{f(a)}_{\Lambda}, \round{f(a')}_{\Lambda})}$}
		%
		Since the output set $(\round{f(a)}_{\Lambda}, \round{f(a')}_{\Lambda})$ is empty when $\Lambda \geq 1$, so we consider the situation where $\Lambda < 1$.
		%
		There are two subcases in this case : $x >0$ and $x < 0$.
		%
		Without loss of generalization, we consider the worst case where error propagate in the same direction, i.e., $\round{f(a')}_{\Lambda}) < 0$. The bounds derived for $l, r$ and $l', r'$ under input $a$ and $a'$ are as follows:
		%
		\\
		%
		For input $a$:
		%
		\\
		%
		$\ubar{R} = e^{\epsilon 
				\big( (f(a) - y_2(1 + \eta)) (1 + \eta)^2) \big)}$, 
		%
		$\bar{R} = e^{\epsilon 
				\frac{(f(a) - \frac{y_2}{1 + \eta})}{(1 + \eta)^2}}$.  
		% 
		\\
		%
		$\ubar{L} = e^{\epsilon 
				\big( (f(a) - y_1(1 + \eta)) (1 + \eta)^2) \big)}$, 
		%
		$\bar{L} = e^{\epsilon 
				\frac{f(a) - \frac{y_1}{1 + \eta}}{(1 + \eta)^2}}$.
		%
		\\
		For input $a'$:
		%
		\\
		% 
		$\ubar{R'} = e^{\epsilon 
				\big( (y_2(1 + \eta) - f(a')) (1 + \eta)^2) \big)}$, 
		%
		$\bar{R'} = e^{\epsilon 
				\frac{ \frac{y_2}{1 + \eta} - f(a') }{(1 + \eta)^2}}$.
		%
		\\
		%
		%
		$\ubar{L'} = e^{\epsilon 
				\big( (y_1(1 + \eta) - f(a') ) (1 + \eta)^2) \big)}$,
		%
		$\bar{L'} = e^{\epsilon 
				\frac{\frac{y_1}{1 + \eta} - f(a') }{(1 + \eta)^2}}$.
		%
		\\
		%
		The bounds on their ratio are as follows:
		%
		\[
		\frac{\ubar{R}}{R} > e^{-5B\eta \epsilon}, 
		~ \frac{\bar{R}}{R} < e^{5B\eta \epsilon};
		~~~~
		\frac{\ubar{R'}}{R'} > e^{-5B\eta \epsilon}, 
		~ \frac{\bar{R'}}{R'} < e^{5B\eta \epsilon}.
		\]
		%
		And the bounds on $|\ubar{R} - \bar{L}|$ and $|\bar{R'} - \ubar{L'}|$ are as follows:
		%
		\[
		|\ubar{R} - \bar{L}| > e^{-12 B\eta \epsilon}|R - L|, 
		~ |\bar{R'} - \ubar{L'}| < e^{11 B\eta \epsilon}|R' - L'|
		\]
		%
		So we have the privacy loss is bounded by:
		%
		\[
		\frac{|\ubar{R} - \bar{L}|}{|\bar{R'} - \ubar{L'}|}
		> \frac{e^{-12 B\eta \epsilon}|R - L|}{e^{11 B\eta \epsilon}|R' - L'|}
		= e^{-23B \eta \epsilon - \epsilon}
		\]
		%
		%
		%
		\caseL{$\boldsymbol{x = \round{f(a')}_{\Lambda}}$}
		%
		%
		%
		This case is symmetric with the case where $\boldsymbol{x = \round{f(a')}_{\Lambda}}$.
		%
		It can also be split into 3 subcases by: $\round{f(a')}_{\Lambda} < 0$, $\round{f(a')}_{\Lambda} = 0$ and $\round{f(a')}_{\Lambda} > 0$. 
		%
		Without loss of generalization, we consider the worst case where the error propagate in the same direction, i.e. $\round{f(a')}_{\Lambda} < 0$.\\
		%
		From this assumption, let $y_1 = x - (\frac{\Lambda}{2})$, $y_2 = x + (\frac{\Lambda}{2})$, we know $y_1 < 0$, $y_2 < 0$.
		%
		Since $f(a) + 1 = f(a')$, we also have $\round{f(a)} < \round{f(a')} <0$.
		So, we know $s$ can only be $-1$ for input $a$ but $s$ can be $1$ or $-1$ for input $a'$.
		%
		\\
		%
		For input $a'$, 
		Let $S = s$, $L' = e^{\epsilon(y_1 - f(a'))}$ and $R' = e^{\epsilon(y_2 - f(a))}$, we have $\forall u \in (L', R')$:
		$[U \mapsto u, S \mapsto s],\snap''(a') \rbigstep [z \mapsto \varx]$.
		%
		\\
		%
		Let $l'$ and $r'$ be the range where $\forall u \in (l', r')$ and $S = s$, s.t.
		$[U \mapsto u, S \mapsto s],\snap''(a) \fbigstep [z \mapsto \varx]$.
		%
		\\
		%
		We know: $\ubar{L'} < l' < \bar{L'}$, $\ubar{R'} < r < \bar{R'}$ s.t.:
		%
		$$[U \mapsto l', S \mapsto s], \snap'(a) \fbigstep [y \mapsto y_1]
		\land
		[U \mapsto r', S \mapsto s], \snap'(a) \fbigstep [y \mapsto y_2].$$
		%
		Induction on s, we have:
		When $s = 1$.
		%
		\\
		%
		The transition from $R'$ to $r'$ given the transition environment 
		$\trsenv = [U \mapsto (R'_{+}, (\ubar{R'_{+}}, \bar{R'_{+}})), S \mapsto (1, (1, 1))]$ is shown as following:
		%
		%
		\begin{mathpar}
		\inferrule
		{
		 \trsenv, U
		 \trsto
		 R_+, ( R_+', R_+' )
		}
		{
		 \inferrule
		 {
		  \trsenv, \ln(U)
		  \trsto
		  \big(\ln (R_+), 
		  (\ln(R_+')(1 + \eta), \frac{\ln(R_+')}{1+\eta}) \big)
		 }
		 {
		  \inferrule
		  {
		   \trsenv, \frac{1}{\epsilon}\ln(U)
		   \trsto
		   \frac{1}{\epsilon} \times \ln (R_+), 
		   \big(
		   \frac{1}{\epsilon}\ln(R_+')(1 + \eta)^2, 
		   \frac{1}{\epsilon}\frac{\ln(R_+')}{(1+\eta)^2}
		   \big)
		  }
		  {
		   \inferrule
		   {
		    \trsenv, f(a) + \frac{1}{\epsilon}\ln(U)
			\trsto
			\bigg(
			f(a) + \frac{1}{\epsilon} \times \ln (R_+), 
			\big(
			(f(a) + \frac{1}{\epsilon}\ln(R_+')(1 + \eta)^2)(1 + \eta), 
			(f(a) + \frac{1}{\epsilon}\frac{\ln(R_+')}{(1+\eta)^2}) / (1 + \eta)
			\big) \bigg)
		   }
		   {
		   \trsenv, \snap'(a) \trsto 
		   \trsenv[y \mapsto 
		   (f(a) + \frac{1}{\epsilon} \times \ln (R_+), 
		   	(\err_1, \err_2))]
		   }
		  }
		 }
		}
		\end{mathpar}
		%
		%
		From soundness theorem, we have  $\err_1 \leq y_2 \leq \err_2$. Then we can get following bounds for $r$:\\
		%
		%
		$\ubar{R_+'} = e^{\epsilon 
				\big( (y_2(1 + \eta) - f(a')) (1 + \eta)^2) \big)}$, 
		%
		$\bar{R_+'} = e^{\epsilon 
				\frac{(\frac{y_2}{1 + \eta} - f(a'))}{(1 + \eta)^2}}$.  
		%
		\\
		%
		Since $y_2 = \round{f(a)} + \frac{\Lambda}{2}$, we have 
		$e^{\epsilon 
				\big( (y_2 - f(a))) \big)} > 1$, so actually we know $R_+' = r_+' = 1$.
		%
		% 
		\\
		%
		We can also derive the bound for $l$ in the same way as:\\
		$\ubar{L_+'} = e^{\epsilon 
				\big( (y_1(1 + \eta) - f(a')) (1 + \eta)^2) \big)}$, 
		%
		$\bar{L_+'} = e^{\epsilon 
				\frac{(\frac{y_1}{1 + \eta} - f(a'))}{(1 + \eta)^2}}$.
		%

		% 
		When $s = -1$, we can derive following bounds in the same way for $l$ and $r$:\\
		%
		$\ubar{L_-'} = e^{\epsilon 
				\big( (f(a') - y_2(1 + \eta)) (1 + \eta)^2) \big)}$,
		%
		$\bar{L_-'} = e^{\epsilon 
				\frac{(f(a') - \frac{y_2}{1 + \eta})}{(1 + \eta)^2}}$.\\
		%
		% 
		$\ubar{R_-'} = e^{\epsilon 
				\big( (f(a') - y_1(1 + \eta)) (1 + \eta)^2) \big)}$, 
		%
		$\bar{R_-'} = e^{\epsilon 
				\frac{(f(a') - \frac{y_1}{1 + \eta})}{(1 + \eta)^2}}$.\\
		%
		Since $y_1 = \round{f(a')} - \frac{\Lambda}{2}$, 
		%
		we have $e^{\epsilon \big( (f(a') - y_1)) \big)} > 1$, so actually we know $R_-' = r_-' = 1$.
		%
		\\
		%
		For input $a$, we have only one case where $s = -1$, the following bound can be derived:
		%
		\\
		%
		$\ubar{R} = e^{\epsilon 
				\big( f(a) - (y_2(1 + \eta)) (1 + \eta)^2) \big)}$, 
		%
		$\bar{R} = e^{\epsilon 
				\frac{(f(a) - \frac{y_2}{1 + \eta})}{(1 + \eta)^2}}$.  
		% 
		\\
		%
		$\ubar{L} = e^{\epsilon 
				\big( (f(a) - y_1(1 + \eta)) (1 + \eta)^2) \big)}$, 
		%
		$\bar{L} = e^{\epsilon 
				\frac{f(a) - \frac{y_1}{1 + \eta}}{(1 + \eta)^2}}$.

		% \begin{mathpar}
		% \end{mathpar}

		We have following bounds on their ratios:
		%
		\[
		\frac{\ubar{R_+'}}{R_+'} = e^{\epsilon 
		\big(
		(1 + \eta)^3 y_2 - (1 + \eta)^2f(a) - y_2 + f(a)
		\big)}
		> e^{-3\epsilon B \eta},
		\frac{\bar{R_+'}}{R_+'} = e^{\epsilon 
		\big(
		frac{y_2}{(1 + \eta)^3} - \frac{f(a)}{(1 + \eta)^2} - y_2 + f(a)
		\big)}
		< e^{3\epsilon B \eta},
		\]
		%
		The same bound for $L_+'$ by substituting $y_2$ with $y_1$, and similar bound for $L, R$.
		%
		\[
		\frac{\ubar{R}}{R} = e^{\epsilon 
		\big(
		(1 + \eta)^2f(a) - (1 + \eta)^3 y_2 - f(a) + y_2
		\big)}
		> e^{-2\epsilon B \eta},
		%
		\frac{\bar{R}}{R} = e^{\epsilon 
		\big(
		\frac{f(a)}{(1 + \eta)^2} - frac{y_2}{(1 + \eta)^3} - f(a) + y_2
		\big)}
		< e^{2\epsilon B \eta},
		\]
		%
		Using the bound on their ratios, we can get following bounds on $|\bar{R_-'} - \ubar{L_-'}|$ and $|\ubar{R} - \bar{L}|$:
		%
		\[
		|\bar{R_-'} - \ubar{L_-'}| < e^{3\epsilon B \eta} R - e^{-3\epsilon B \eta}L < (R_-' - L_-') e^{7\epsilon B \eta},
		%
		|\ubar{R} - \bar{L}| > e^{-2\epsilon B \eta} R - e^{2\epsilon B \eta}L > (R - L) e^{-5\epsilon B \eta}
		\]
		%
		Then we have the following bounds on privacy loss:
		%
		\[
		\frac{\ubar{R} - \bar{L}}{2 - (\ubar{L_+'} + \ubar{L_-'})}
		> \frac{\ubar{R} - \bar{L}}{\bar{R_-'} - \ubar{L_-'}}
		> \frac{e^{-5\epsilon B \eta} (R - L)}
		{e^{7\epsilon B \eta}(R_-' - L_-')}
		= e^{-12\epsilon B \eta - \epsilon}
		\]
		%
		%
		%
		\caseL{$\boldsymbol{x \in  (\round{f(a')}_{\Lambda}, B)}$}
		%
		This case can also be split into 3 subcases symmetric with the case where $\boldsymbol{x \in  (-B, \round{f(a)}_{\Lambda})}$:
		%
		%
		%
		\subcaseL{$\boldsymbol{\round{f(a')}_{\Lambda} > 0 \lor \round{f(a')}_{\Lambda} < 0 \land x \in  (0, B)}$}
		%
		%
		let $y_1 = x - \frac{\Lambda}{2}$, $y_2 = x + \frac{\Lambda}{2}$, we have $y_1, y_2 > 0$. The bounds derived for $l, r$ and $l', r'$ under input $a$ and $a'$ in this case are as follows:
		%
		\\
		For input $a'$:
		%
		\\
		% 
		$\ubar{R'} = e^{\epsilon 
				\big( (f(a') - \frac{y_2}{1 + \eta}) (1 + \eta)^2) \big)}$, 
		%
		$\bar{R'} = e^{\epsilon 
				\frac{(f(a') - y_2(1 + \eta))}{(1 + \eta)^2}}$.
		%
		\\
		%
		%
		$\ubar{L'} = e^{\epsilon 
				\big( (f(a') - \frac{y_1}{1 + \eta})) (1 + \eta)^2) \big)}$,
		%
		$\bar{L'} = e^{\epsilon 
				\frac{(f(a') - y_1(1 + \eta)}{(1 + \eta)^2}}$.
		%
		\\
		%
		For input $a$:
		%
		\\
		%
		$\ubar{R} = e^{\epsilon 
				\big( (f(a) - \frac{y_2}{1 + \eta}) (1 + \eta)^2) \big)}$, 
		%
		$\bar{R} = e^{\epsilon 
				\frac{(f(a) - y_2(1 + \eta))}{(1 + \eta)^2}}$.  
		% 
		\\
		%
		$\ubar{L} = e^{\epsilon 
				\big( (f(a) - \frac{y_1}{1 + \eta}) (1 + \eta)^2) \big)}$, 
		%
		$\bar{L} = e^{\epsilon 
				\frac{f(a) - y_1(1 + \eta)}{(1 + \eta)^2}}$.
		%
		%
		The bounds on their ratio are as follows:
		%
		\[
		\frac{\ubar{R}}{R} > e^{-3B\eta \epsilon}, 
		~ \frac{\bar{R}}{R} < e^{3B\eta \epsilon}
		\]
		%
		And the bounds on $|\ubar{R} - \bar{L}|$ and $|\bar{R'} - \ubar{L'}|$ are as follows:
		%
		\[
		|\ubar{R} - \bar{L}| > e^{-7 B\eta \epsilon}|R - L|, 
		~ |\bar{R'} - \ubar{L'}| < e^{7 B\eta \epsilon}|R' - L'|
		\]
		%
		So we have the privacy loss is bounded by:
		%
		\[
		\frac{|\ubar{R} - \bar{L}|}{|\bar{R'} - \ubar{L'}|}
		> \frac{e^{-7 B\eta \epsilon}|R - L|}{e^{7 B\eta \epsilon}|R' - L'|}
		= e^{-14B \eta \epsilon - \epsilon}
		\]
		%
		\subcaseL{$\boldsymbol{\round{f(a')}_{\Lambda} < 0 \land x \in  (\round{f(a')}_{\Lambda}, 0)}$}
		%		
		let $y_1 = x - \frac{\Lambda}{2}$, $y_2 = x - \frac{\Lambda}{2}$, we have $y_1, y_2 < 0$. The bounds derived for $l, r$ in this case are as follows:
		%
		\\
		For input $a'$:
		%
		\\
		% 
		$\ubar{R'} = e^{\epsilon 
				\big( (f(a') - y_2(1 + \eta)) (1 + \eta)^2) \big)}$, 
		%
		$\bar{R'} = e^{\epsilon 
				\frac{(f(a') - \frac{y_2}{1 + \eta})}{(1 + \eta)^2}}$.
		%
		\\
		%
		%
		$\ubar{L'} = e^{\epsilon 
				\big( (f(a') - y_1(1 + \eta) ) (1 + \eta)^2) \big)}$,
		%
		$\bar{L'} = e^{\epsilon 
				\frac{(f(a') - \frac{y_1}{1 + \eta}}{(1 + \eta)^2}}$.
		%
		\\
		%
		For input $a$:
		%
		\\
		%
		$\ubar{R} = e^{\epsilon 
				\big( (f(a) - y_2(1 + \eta)) (1 + \eta)^2) \big)}$, 
		%
		$\bar{R} = e^{\epsilon 
				\frac{(f(a) - \frac{y_2}{1 + \eta})}{(1 + \eta)^2}}$.  
		% 
		\\
		%
		$\ubar{L} = e^{\epsilon 
				\big( (f(a) - y_1(1 + \eta)) (1 + \eta)^2) \big)}$, 
		%
		$\bar{L} = e^{\epsilon 
				\frac{f(a) - \frac{y_1}{1 + \eta}}{(1 + \eta)^2}}$.
		%
		\\
		%
		The bounds on their ratio are as follows:
		%
		\[
		\frac{\ubar{R}}{R} > e^{-5B\eta \epsilon}, 
		~ \frac{\bar{R}}{R} < e^{5B\eta \epsilon}
		\]
		%
		And the bounds on $|\ubar{R} - \bar{L}|$ and $|\bar{R'} - \ubar{L'}|$ are as follows:
		%
		\[
		|\ubar{R} - \bar{L}| > e^{-12 B\eta \epsilon}|R - L|, 
		~ |\bar{R'} - \ubar{L'}| < e^{11 B\eta \epsilon}|R' - L'|
		\]
		%
		So we have the privacy loss is bounded by:
		%
		\[
		\frac{|\ubar{R} - \bar{L}|}{|\bar{R'} - \ubar{L'}|}
		> \frac{e^{-12 B\eta \epsilon}|R - L|}{e^{11 B\eta \epsilon}|R' - L'|}
		= e^{-23B \eta \epsilon - \epsilon}
		\]
		%
		%
		\subcaseL{$\boldsymbol{\round{f(a')}_{\Lambda} < 0 \land x = 0}$}
		%
		let $y_1 = x - \frac{\Lambda}{2}$, $y_2 = x - \frac{\Lambda}{2}$, we have $y_1 < 0$ and $y_2 > 0$. The bounds derived for $l, r$ in this case are as follows:
		%
		\\
		For input $a'$:
		%
		\\
		% 
		$\ubar{R'} = e^{\epsilon 
				\big( (f(a') - \frac{y_2}{1 + \eta}) (1 + \eta)^2) \big)}$, 
		%
		$\bar{R'} = e^{\epsilon 
				\frac{(f(a') - y_2(1 + \eta))}{(1 + \eta)^2}}$.
		%
		\\
		%
		%
		$\ubar{L'} = e^{\epsilon 
				\big( (f(a') - y_1(1 + \eta)) (1 + \eta)^2) \big)}$, 
		%
		$\bar{L'} = e^{\epsilon 
				\frac{f(a') - \frac{y_1}{1 + \eta}}{(1 + \eta)^2}}$.
		%
		\\
		%
		For input $a$:
		%
		\\
		%
		$\ubar{R} = e^{\epsilon 
				\big( (f(a) - \frac{y_2}{1 + \eta}) (1 + \eta)^2) \big)}$, 
		%
		$\bar{R} = e^{\epsilon 
				\frac{(f(a) - y_2(1 + \eta))}{(1 + \eta)^2}}$.  
		% 
		\\
		%
		$\ubar{L} = e^{\epsilon 
				\big( (f(a) - y_1(1 + \eta)) (1 + \eta)^2) \big)}$, 
		%
		$\bar{L} = e^{\epsilon 
				\frac{f(a) - \frac{y_1}{1 + \eta}}{(1 + \eta)^2}}$.
		%
		\\
		%
		The bounds on their ratio are as follows:
		%
		\[
		\frac{\ubar{R}}{R} > e^{-3B\eta \epsilon}, 
		~ \frac{\bar{R}}{R} < e^{3B\eta \epsilon}
		\frac{\ubar{L}}{L} > e^{-5B\eta \epsilon}, 
		~ \frac{\bar{L}}{L} < e^{5B\eta \epsilon}
		\]
		%
		And the bounds on $|\ubar{R} - \bar{L}|$ and $|\bar{R'} - \ubar{L'}|$ are as follows:
		%
		\[
		|\ubar{R} - \bar{L}| > e^{-8 B\eta \epsilon}|R - L|, 
		~ |\bar{R'} - \ubar{L'}| < e^{8 B\eta \epsilon}|R' - L'|
		\]
		%
		So we have the privacy loss is bounded by:
		%
		\[
		\frac{|\ubar{R} - \bar{L}|}{|\bar{R'} - \ubar{L'}|}
		> \frac{e^{-8 B\eta \epsilon}|R - L|}{e^{8 B\eta \epsilon}|R' - L'|}
		= e^{-16B \eta \epsilon - \epsilon}
		\]
		%
		%
		%
		\caseL{$\boldsymbol{x = B}$}
		%
		%
		We know $s = -1$, $L = l = 0$ and $R = b$, so we only need to estimate the right side range $r$ in this case. The bounds derived for $r, r'$ are as following:
		\[
		\begin{array}{c}
		\ubar{R} = e^{\epsilon 
		\big( (f(a) -  \frac{x}{1 + \eta}) (1 + \eta)^2) \big)},
		%
		\bar{R} = e^{\epsilon 
		\frac{(f(a) - x(1 + \eta))}{(1 + \eta)^2}}
		\\
		%
		\ubar{R'} = e^{\epsilon 
		\big( (f(a') -  \frac{x}{1 + \eta}) (1 + \eta)^2) \big)},
		%
		\bar{R'} = e^{\epsilon 
		\frac{(f(a') - x(1 + \eta))}{(1 + \eta)^2}}
		\end{array}
		\]
		%		
		The privacy loss of $\snap(a)$ in this case is bounded by:
		%
		\[
		\begin{array}{ll}
		\frac
		{\frac{1}{2}(\ubar{R} - 0)}
		{\frac{1}{2}(\bar{R'} - 0)}
		& = e^{\epsilon
		\bigg(
		\big( (f(a) -  \frac{x}{1 + \eta}) (1 + \eta)^2) \big)
		-
		\frac{(f(a') - x(1 + \eta))}{(1 + \eta)^2}
		\bigg)}\\
		& = e^{\epsilon
		\bigg(
		f(a)(1 + \eta)^2 - x(1 + \eta) 
		- \frac{f(a)}{(1 + \eta)^2} + \frac{x}{(1 + \eta)}   
		\bigg)} ~ (\star)
		\end{array}
		\]
		%
		Since $ 1 + 2.1\eta > (1 + \eta)^2 > 1 + 2\eta$ and $\frac{1}{(1 + \eta)^2} > 1 - 2 \eta$, we have:
		%
		\[
		\begin{array}{ll}
		(\star) & > e^{\epsilon \big(
		(1 + 2\eta) f(a) - \frac{\eta(\eta + 2)}{1 + \eta} x
		- \frac{1}{1 + 2\eta}(f(a) + 1)
		\big)}\\
		%
		& = e^{\epsilon\big(
		\frac{4\eta(\eta + 1)}{1 + 2\eta} f(a) 
		- \frac{\eta(\eta + 2)}{1 + \eta} x
		- \frac{1}{1 + 2\eta}		
		\big)}\\
		%
		& > e^{\epsilon\big( -B \eta
		\frac{4(\eta + 1)}{1 + 2\eta} + \frac{(\eta + 2)}{1 + \eta} x - 1	
		\big)}\\
%
		& > e^{\epsilon(-6 \eta B - 1)}
		\end{array}
		\]
	%	
	\end{itemize}



\end{proof}

\newpage
\section{Syntax - Functional}
Following are the syntax of our system:
%
\[\begin{array}{llll}
\mbox{Expr.} & \expr & ::= & \varx 
	~|~ \rval ~|~ \fval
	%
	~|~ F(\data) ~|~ \expr \bop \expr
	%
	~|~ \uop (\expr) ~|~ \elet ~ \varx \samplel \edistr ~ \ein ~ \expr
	~|~ \elet ~ \varx = \expr_1 ~ \ein ~ \expr_2 \\
%
\mbox{Binary Operation} & \bop & ::= & + ~|~ - ~|~ \times ~|~ \div \\
%
\mbox{Unary Operation} & \uop & ::= & \ln ~|~ - ~|~ \round{\cdot} 
	%
	~|~ \clamp_B(\cdot) \\
%
\mbox{Value} & \valv & ::= & \rval ~|~  \fval \\
%
\mbox{Distribution} & \edistr & ::= & \uniform ~|~ \bernoulli \\ 
%
\mbox{Error} & \err & ::= & (\expr, \expr)
%
\end{array}
\]


\newpage
\section{Semantics - Functional}

The transition semantics with relative floating point computation error are shown in Figure. \ref{fig_func_trans_semantics_exp}. The semantics are $\expr \trsto (\err)$, which means a real expression $\expr$ can be transited in floating point computation with error bound $\err$, $\eta$ is the machine epsilon.

We assume the SAMPLE and F(D) semantics for floating point and real computation are the same. $\edistr \bigstep_{\$} \valv$ represents $\valv$ is sampled from the distribution $\edistr$.

\begin{figure}
\begin{mathpar}
\inferrule*[right = val]
{
	\rval \geq 0
}
{
	\rval
	\trsto
	\big( \frac{\rval}{(1 + \eta)}, \rval(1 + \eta) \big)
}
%
\and
%
\inferrule*[right = val-neg]
{
	\rval < 0
}
{
	\rval
	\trsto
	\big( \rval(1 + \eta), \frac{\rval}{(1 + \eta)} \big)
}
%
\and
%
\inferrule*[right = val-eq]
{
	\rval = \floaten(\rval)
}
{
	\rval
	\trsto
	( \rval, \rval )
}
%
\and
%
\inferrule*[right = f(d)]
{
	\empty
}
{
	f(D)
	\trsto
	( f(D), f(D) )
}
%
\and
%
\inferrule*[right = sample]
{
	\empty
}
{
	\samplel \edistr
	\trsto
	( \samplel \edistr, \samplel \edistr )
}
%
\and
%
\inferrule*[right = bop]
{
	\expr^1 \trsto (\ubar{\expr^1}, \bar{\expr^1})
	\and
	\expr^2 \trsto (\ubar{\expr^2}, \bar{\expr^2})
	\and
	\expr^1 * \expr^2 \geq 0
}
{
    \expr^1 * \expr^2
    \trsto 
    \big(
    \frac{\ubar{\expr^1} * \ubar{\expr^2}}{(1 + \eta)}, 
    (\bar{\expr^1} * \bar{\expr^2})(1 + \eta)
    \big)
}
%
\inferrule*[right = bop-neg]
{
	\expr^1 \trsto  (\ubar{\expr^1}, \bar{\expr^1})
	\and
	\expr^2 \trsto  (\ubar{\expr^2}, \bar{\expr^2})
	\and
	\expr^1 * \expr^2 < 0
}
{
    \expr^1 * \expr^2
    \trsto 
    \big(
    (\bar{\expr^1} * \bar{\expr^2})(1 + \eta),
    \frac{\ubar{\expr^1} * \ubar{\expr^2}}{(1 + \eta)}
    \big)
}%
\and
%
\inferrule*[right = uop]
{
	\expr \trsto (\ubar{\expr}, \bar{\expr})
	\and
	\uop (\expr) \geq 0
}
{
    \uop(\expr)
    \trsto 
    \big(
    \frac{\uop(\ubar{\expr})}{(1 + \eta)}, 
    (\uop(\bar{\expr}))(1 + \eta)
    \big)
}
%
\inferrule*[right = uop-neg]
{
	\expr \trsto  (\ubar{\expr}, \bar{\expr})
	\and
	\uop (\expr) < 0
}
{
    \uop(\expr)
    \trsto 
    \big(
    (\uop(\ubar{\expr}))(1 + \eta),
    \frac{\uop(\bar{\expr})}{(1 + \eta)}
    \big)
}
\end{mathpar}
\caption{Semantics of Transition for Expressions with Relative Floating Point Error}
\label{fig_func_trans_semantics_exp}
\end{figure}



\begin{figure}
\begin{mathpar}
\inferrule*[right = fval]
{
	\floaten(\rval) = \fval
}
{
	\rval
	\bigstep
	\fval
}
%
\and
%
\inferrule*[right = fbop]
{
	\expr^1 \bigstep \fval^1
	\and
	\expr^2 \bigstep \fval^2
	\and
	\floaten(\fval^1 \bop \fval^2) = \fval
}
{
    \expr^1 \bop \expr^2 \bigstep \fval
}
%
\and
%
\inferrule*[right = fuop]
{
	\expr \bigstep \fval',
	\and
	\floaten(\uop (\fval')) = \fval
}
{
    \uop(\expr) \bigstep \fval
}
\end{mathpar}
\caption{Semantics of Evaluation in Floating Point Computation}
\label{fig_fl_semantics_exp}
\end{figure}

\begin{figure}
\begin{mathpar}
\inferrule*[right = rval]
{
	\empty
}
{
	\rval
	\bigstep
	\rval
}
%
\and
%
\inferrule*[right = rbop]
{
	\expr^1 \bigstep \rval^1
	\and
	\expr^2 \bigstep \rval^2
	\and
	\rval^1 \bop \rval^2 = \rval
}
{
    \expr^1 \bop \expr^2 \bigstep \rval
}
%
\and
%
\inferrule*[right = ruop]
{
	\expr \bigstep \rval',
	\and
	\uop (\rval') = \rval
}
{
    \uop(\expr) \bigstep \rval
}
%
\and
%
\inferrule*[right = sample]
{
	 \fval \leftarrow \edistr^{\diamond}
}
{
	\samplel \edistr \bigstep \fval
}
%
\and
%
\inferrule*[right = f(d)]
{
	f(D) = \fval
}
{
	f(D) \bigstep \fval
}
\end{mathpar}
\caption{Semantics of Evaluation in Real Computation}
\label{fig_func_real_semantics_exp}
\end{figure}


\begin{thm}[Soundness Theorem]
Given $\expr$ where the transition 
$\expr \trsto (\ubar{\expr}, \bar{\expr})$ holds, 
then if $\expr$ evaluates to $c$ in floating point computation and 
$\ubar{\expr}$ and $\bar{\expr}$ evaluates to $\ubar{r}$ and $\bar{r}$ in real computation, we have: 
\[
\ubar{r} \leq c \leq \bar{r}
% ~~ \land ~~ 
% \frac{r^1}{r^2} \leq \frac{c}{r} \leq \frac{r^2}{r^1}.
\]
\end{thm}
% \begin{proof}
% Induction on $\expr$, we have following cases:

% \end{proof}

\newpage
\bibliographystyle{plain}
\bibliography{verifysnap.bib}



\end{document}















