\documentclass[a4paper,11pt]{article}
\usepackage[utf8]{inputenc}
\input{prelude}
\input{ldef}
\usepackage{eucal}
\usepackage{url}
\usepackage{tikz}
\usepackage{amsfonts,amsmath}
\usepackage{hyperref}
\begin{document}

\title{Verifying Snapping Mechanism - Connecting Ideal and Flopt}
\author{}

\date{}

\maketitle
In order to verify the differential privacy proeprty of
the snapping mechanism \cite{mironov2012significance},
we follow the logic rules designed from
\cite{barthe2016proving} and connecting 
it with the floating point computation semantics.
\section{Syntax}
\[\begin{array}{llll}
\mbox{Programs} & \prog & ::= & 
	%
     \varx = \expr ~|~ \varx \samplel \edistr
	%
	~|~ \prog ; \prog \\

\mbox{Expr.} & \expr & ::= & \rval 
	%
	~|~ \varx  ~|~ \expr \bop \expr
	%
	~|~ \uop (\expr) \\
%
\mbox{Binary Operation} & \bop & ::= & + ~|~ - ~|~ \times ~|~ \div \\
%
\mbox{Unary Operation} & \uop & ::= & \ln ~|~ - ~|~ \round{\cdot} 
	%
	~|~ \clamp_B(\cdot) \\
%
\mbox{Value} & \valv & ::= & \rval ~|~  \fval \\
%
\mbox{Distribution} & \edistr & ::= & \uniform(0, 1) 
%
	~|~ \uniform\{-1, 1\}\\ 
%
\mbox{Error} & \err & ::= & (\rval, \rval) \\
%
\mbox{Env.} & \trsenv & ::= & \cdot ~|~ \trsenv[x \mapsto (\fval, \err)] \\
%
\mbox{Assert.} & \Phi &  & 
\end{array}
\]
where $\rval$ is in domain of real number $\real$, $\rval \in \real$ and $\fval$ is in domain of floating point number $\float$, $\fval \in \float$. Furthermore, the domain of floating point number $\float$ is a subset of $\real$ containing the real number that can be represented in the floating point computation.

\section{
Connecting Coupling Logic
%
with Floating Point Computation
}
%
Fig. \ref{fig:aprhl} presents the main rules from apRHL excluding the while and condition rules which is not defined in out syntax, as well as the sampling rule, which we generalized in extended apRHL.
The rule [SEQ] for sequential composition generalizes the sequential composition theorem of differential privacy, which intuitively corresponds to the case where the postcondition of the composed commands is equality.
This generalization allows apRHL to prove differential privacy using the coupling composition principle when the standard composition theorem is insufficient.
\\
The rule in Fig. \ref{fig:aprhlplus} represents the lifting proved in soundness theorem. They all extended from the apRHL+ \cite{barthe2016proving}.
\begin{figure}[t]
\boxed{\vdash: prog \times prog \times Assert \times Assert}\\
\boxed{\Phi: Env \times Env \to bool;
~~~~
\sem{\Phi} = 
\{(\trsenv_1, \trsenv_2) | \Phi(\trsenv_1, \trsenv_2) = true\}}\\
\boxed{\trsenv: var \to \fval \times \rval \times \rval}\\
\boxed{\pi_i: \fval \times \rval \times \rval \to v}
\begin{mathpar}
\inferrule*[right = FloptUnif]
{
\empty
}
{
	\vdash
	\varx_1 \samplel \uniform(0, 1) 	
	\sim_{\epsilon, 0} 
	\varx_2 \samplel \uniform(0, 1)
	: 
	\top \Rightarrow  
	% (P \Rightarrow   Q)
	e^{-\epsilon} \pi_2(\varx_2) \leq \pi_3 (\varx_1) 
	\land \pi_2 (\varx_1) \leq e^{\epsilon} \pi_3 (\varx_2)
}
\and
\inferrule*[right = FloptNull]
{
\empty
}
{
	\vdash 
	\varx^1 \samplel \uniform(0, 1) 	
	\sim_{0, 0} 
	\varx^2 \samplel \uniform(0, 1) 
	: \top \Rightarrow 
	\pi_1 \varx^2 = \pi_1 \varx^1 
	\land \pi_2 \varx^2 = \pi_2 \varx^1
	\land \pi_3 \varx^2 = \pi_3 \varx^1
}
\end{mathpar}
\caption{Rules Extended from apRHL+}
\label{fig:aprhlplus}
\end{figure}

\begin{figure}[t]
\begin{mathpar}
\inferrule*[right = Assn]
{
\empty
}
{
	\vdash 
	\varx_1 = \expr_1  
	\sim_{0, 0} 
	\varx_2 = \expr_2  
	: \Phi[\expr_1/\varx_1][\expr_2/\varx_2]  \Rightarrow \Phi
}
\and
\inferrule*[right = Seq]
{
\prog_1 \sim_{k, 0} \prog_2 : \Phi_1 \Rightarrow \Phi'_1
\\
\prog'_1 \sim_{k', 0} \prog'_2 : \Phi'_1 \Rightarrow \Phi_2
}
{
	\vdash 
	\prog_1; \prog'_1  
	\sim_{k + k', 0} 
	\prog_2; \prog'_2
	: \Phi_1  \Rightarrow  \Phi_2
}
\and
\inferrule*[right = Conseq]
{
\prog_1 \sim_{k, 0} \prog_2 : \Phi'_1 \Rightarrow \Phi'_2
\and
\Phi_1 \Rightarrow \Phi'_1
\and 
\Phi'_2 \Rightarrow \Phi_2
}
{
\prog_1 \sim_{k, 0} \prog_2 : 
\Phi_1 \Rightarrow \Phi_2
}
\end{mathpar}
\caption{Proving Rules from apRHL}
\label{fig:aprhl}
\end{figure}
The judgment $\vdash \prog_1 \sim_{\epsilon, \delta} \prog_2: \Phi_0 \Rightarrow \Phi$ is read as, given two environments $\trsenv_1$ and $\trsenv_2$ satisfying precondition $\Phi_0$, 
then under the semantics definition, 
$(\sem{\prog_1}_{\trsenv_1})$ 
$\sem{\Phi}^{\#(\epsilon, \delta)}$ 
$(\sem{\prog_2}_{\trsenv_2})$.

\newpage
\paragraph{Semantics.}
$\boxed{\trsenv, \prog \trsto \distr(\trsenv)}$
\[
	\begin{array}{rcl}
% 	\sem{\eskip}_{\trsenv}
% 	& = & 
% 	~\unit{\trsenv}
% 	\\
	%
	\sem{\varx \samplel \uniform(0, 1)}_{\trsenv}
	& = & 
	\elet (\fval, \rval^{l}, \rval^{u}) = \sem{\uniform(0, 1)}_{\trsenv} 
	\ein 
	\unit{\trsenv[\varx \mapsto (\fval, \rval^{l}, \rval^{u})]}
	\\
	%
	\sem{\varx = \expr}_{\trsenv}
	& = &  
	~\unit{\trsenv[\varx \mapsto \sem{\expr}_{\trsenv}]}
	\\
	%
	\sem{\prog_1; \prog_2}_{\trsenv}
	& = &  \elet  \trsenv_1 = 
	\sem{\prog_1}_{\trsenv} \ein
	\sem{\prog_2}_{\trsenv_1} 
	\end{array}
\]
$\boxed{\trsenv, \expr \trsto \fval \times \rval \times \rval}$
\[
	\begin{array}{rcl}
	\sem{\expr}_{\trsenv}
	& \in &  
	\big\{(\fval, \rval^{l}, \rval^{u}) |
	\exists ~~  
	\trsenv,  
	\expr \trsto (\fvalv, \rval^{l}, \rval^{u})\big\}
	\end{array}
\]
$
\boxed{\trsenv, \edistr \trsto \distr(\fval \times \rval \times \rval)}
$
\[
	\begin{array}{rcl}
	\sem{\uniform(0, 1)}_{\trsenv}
	& \in & 
	\big\{
	(\fval, \rval^{l}, \rval^{u}) |
	\fval \leftarrow \uniform(0, 1)^{\diamond}
	\land \rval^{l} = \fval
	\land \rval^{u} = \fval
	\big\}
	\end{array}
\]
In the semantics, 
$\trsenv, \expr \trsto (\fvalv, err)$ represents given an environment $\trsenv$, the expression $\expr$
is transited to $\fvalv$ with error bound $err = (\rval^{l}, \rval^{u})$ in floating point transition semantics, s.t. $\rval^{l} \leq \fvalv \leq \rval^{u}$. 
$\trsenv, \prog \trsto \trsenv'$ represents given and environment $\trsenv$, the program $\prog$ is transited to a new environment $\trsenv'$.


\clearpage
\begin{thm}[Soundness]
 $\forall \prog^1$, $\prog^2$,  $ \vdash \prog^1	
\sim_{\epsilon, \delta} 
\prog^2 :
\Phi_0 \Rightarrow \Phi $,    $\forall \trsenv^1_0$, $\trsenv^2_0$ 
s.t $\Phi_0$: 
$\trsenv^1_0 ~ \sem{\Phi_0} ~ \trsenv^2_0$,
then
$$ 
(\sem{\prog^1}_{\trsenv^1_0})  
\sem{\Phi}^{\#(\epsilon, \delta)} 
(\sem{\prog^2}_{\trsenv^2_0}) 
$$.
\end{thm}



\begin{proof}
By induction on the transition judgement $\vdash \prog^1	
\sim_{\epsilon, \delta} 
\prog^2 :
\Phi_0 \Rightarrow \Phi $.
\begin{itemize}
\caseL{[\textsc{FloptUnif}]}
	In this case, 
	$\sem{\Phi} = 
	\{((\fval^1, \rval^{1l}, \rval^{1u}), (\fval^2, \rval^{2l}, \rval^{2u})) 
	\in (\float \times \real \times \real) \times (\float \times \real \times \real)
	|
	\expr^{-\epsilon} \rval^{2l} \leq \rval^{1u}
	\land
	\expr^{\epsilon} \rval^{1l} \leq \rval^{2u}
	\}$
	%
	\\
	%
	By the semantics of sampling, we have:\\
	%
	$\sem{\varx^1 \samplel \edistr^1}_{\trsenv^1_0} = \distr(\trsenv^1)$ and 
	%
	$\sem{\varx^2 \samplel \edistr^2}_{\trsenv^2_0} = \distr(\trsenv^2)$. \\
	%
	By the definition of the environment and the soundness of the transition semantics, we have for any $(\fval^1, \rval^{1l}, \rval^{1u}), (\fval^2, \rval^{2l}, \rval^{2u})$ s.t.,
	%
	$\trsenv^1 (\varx^1) = (\fval^1, \rval^{1l}, \rval^{1u})$
	and
	$\trsenv^2 (\varx^2) = (\fval^2, \rval^{2l}, \rval^{2u})$:
	%
	\\
	%
	$ \rval^{1l} \leq \fval^1 \leq \rval^{1u} ~ (1)$ 
	and
	$ \rval^{2l} \leq \fval^2 \leq \rval^{2u} ~ (2)$.
	%
	\\
	%
	Let $\rval^1$ and $\rval^2$ be the real representation of $\fval^1$ and $\fval^2$ in $\real$, by the soundness of ideal judgment, we have:
	$\pi_1 (\distr(\trsenv^1)) ~ \Psi^{\#(\epsilon, 0)} ~ \pi_1 (\distr(\trsenv^2))$, where
	\[
		\Psi = \{(\rval^1, \rval^2) \in \real \times \real
		| 
		\rval^1 e^{-\epsilon} 
		\leq \rval^2
		\leq \rval^1 e^{\epsilon} \}.
	\]
	By $(1)$ and $(2)$, we have:
	$\Psi \implies \Phi$.
	\\
	So it can be proven by implication that 
	$(\distr(\trsenv^1)) ~ \Phi^{\#(\epsilon, 0)} ~ (\distr(\trsenv^2))$, i.e., 
	$$
	\sem{\varx^1 \samplel \edistr^1}_{\trsenv^1_0} 
		~ \sem{\Phi}^{\#(\epsilon, 0)} ~
		\sem{\varx^2 \samplel \edistr^2}_{\trsenv^2_0}
	$$
\caseL{[\textsc{FloptNull}] }
	In this case, 
	$\sem{\Phi} = 
	\{((\fval^1, \rval^{1l}, \rval^{1u}), (\fval^2, \rval^{2l}, \rval^{2u})) 
	\in (\float \times \real \times \real) \times (\float \times \real \times \real)
	|
	\rval^{2l} = \rval^{1l}
	\land
	\rval^{2u} = \rval^{1u}
	\land
	\fval^1 = \fval^2
	\}$
	%
	\\
	%
	By the semantics of sampling, we have:\\
	%
	$\sem{\varx^1 \samplel \edistr^1}_{\trsenv^1_0} = \distr(\trsenv^1)$ and 
	%
	$\sem{\varx^2 \samplel \edistr^2}_{\trsenv^2_0} = \distr(\trsenv^2)$. \\
	%
	By the definition of the environment and the soundness of the transition semantics, we have for any $(\fval^1, \rval^{1l}, \rval^{1u}), (\fval^2, \rval^{2l}, \rval^{2u})$ s.t.,
	%
	$\trsenv^1 (\varx^1) = (\fval^1, \rval^{1l}, \rval^{1u})$
	and
	$\trsenv^2 (\varx^2) = (\fval^2, \rval^{2l}, \rval^{2u})$:
	%
	\\
	%
	$ \rval^{1l} \leq \fval^1 \leq \rval^{1u} ~ (1)$ 
	and
	$ \rval^{2l} \leq \fval^2 \leq \rval^{2u} ~ (2)$.
	%
	\\
	%
	Let $\rval^1$ and $\rval^2$ be the real representation of $\fval^1$ and $\fval^2$ in $\real$, by the soundness of ideal judgment, we have:
	$\pi_1 (\distr(\trsenv^1)) ~ \Psi^{\#(\epsilon, 0)} ~ \pi_1 (\distr(\trsenv^2))$, where
	\[
		\Psi = \{(\rval^1, \rval^2) \in \real \times \real
		| 
		\rval^1 = \rval^2 \}.
	\]
	By $(1)$ and $(2)$, we have:
	$\Psi \implies \Phi$.
	\\
	So it can be proven by implication that 
	$(\distr(\trsenv^1)) ~ \Phi^{\#(\epsilon, 0)} ~ (\distr(\trsenv^2))$, i.e., 
	$$
	\sem{\varx^1 \samplel \edistr^1}_{\trsenv^1_0} 
		~ \sem{\Phi}^{\#(\epsilon, 0)} ~
		\sem{\varx^2 \samplel \edistr^2}_{\trsenv^2_0}
	$$
	\caseL{[\textsc{Assn}] }
	\caseL{[\textsc{Seq}] }
	\caseL{[\textsc{ConSeq}] }
	\end{itemize}
\end{proof}


\newpage
\section{Snapping Mechanism}

\begin{defn}
[$\snap(a) : A \to \distr(\real)$]
Given privacy parameter $\epsilon$, the Snapping mechanism $\snap(a)$ is defined as:
\[
	\varu \samplel \uniform(0,1); s \samplel \uniform\{-1, 1\};
	\varx = \clamp_B \big(
	\round{f(a) + \frac{1}{\epsilon} \times s \times \ln (\varu)}_{\Lambda}
	\big)
\]
where $f(a)$ represents a value that the query function $f$ be evaluated over input database $a \in A$, $\epsilon$ is the privacy parameter, $B$ is the clamping argument and $\Lambda$ is the rounding argument satisfying $\lambda = 2^k$ where $2^k$ is the smallest power of 2 greater or equal to the $\frac{1}{\epsilon}$.
\end{defn}

\begin{thm}[The $\snap$ mechanism is 
$\epsilon-$differentially private]
\end{thm}
\begin{proof}
\tiny{
\begin{mathpar}
\inferrule*[right = Seq]
{
	\inferrule*[right = Seq]
	{
	\inferrule[FloptUnif]
	{
	\Phi = e^{-\epsilon(1 + 24B\eta)} \pi_2(\varu^2) \leq \pi_3 (\varu^1) 
		\land \pi_2 (\varu^1) \leq e^{\epsilon(1 + 24B\eta)} \pi_3 (\varu^2)
	}
	{
		\varu_1 \samplel \uniform(0,1)
		\sim_{\epsilon + 24B\eta\epsilon, 0} 
		\varu_2 \samplel \uniform(0,1)
		: 
		\top
		\Rightarrow 
		\Phi
	}
	~~
	\inferrule[FloptNull]
	{
	\empty
	}
	{
		s_1 = \samplel \uniform\{-1, 1\}
		\sim_{0, 0} 
		s_2 = \samplel \uniform\{-1, 1\}
		: 
		\Phi
		\Rightarrow 
		\Phi \land \pi_1(s_1) = \pi_1(s_2)
	}
	}
	{
		\varu_1 \samplel \uniform(0,1); s_1 = \samplel \uniform\{-1, 1\}
		\sim_{\epsilon + 24B\eta\epsilon, 0} 
		\varu_2 \samplel \uniform(0,1); s_2 = \samplel \uniform\{-1, 1\}
		: \top \Rightarrow \Phi \land \pi_1(s_1) = \pi_1(s_2)
	}
\\
\Pi_R
}
{
	\vdash 
	\varu_1 \samplel \uniform(0,1); s_1 = \samplel \uniform\{-1, 1\};
	\varx_1 = \clamp_B \big(
	\round{f(a) + \frac{1}{\epsilon} \times s_1 \times \ln (\varu_1)}_{\Lambda}
	\big) 
	\sim_{\epsilon + 24B\eta\epsilon, 0} 
	\varu_2 \samplel \uniform(0,1); s_2 = \samplel \uniform\{-1, 1\};
	\varx_2 = \clamp_B \big(
	\round{f(a') + \frac{1}{\epsilon} \times s_2 \times \ln (\varu_2)}_{\Lambda}
	: \top  \Rightarrow  \varx_1 = \varx_2
}
\\
\Pi_R:
\\
\inferrule*[right = ConSeq]
{	
\inferrule*[right = Assn]
	{
		\Phi' = 
		e^{-\epsilon(1 + 24B\eta)} 
		e^{\epsilon (\frac{\pi_2(\varx^2)}{(1 + \eta)^3} - \frac{f(a')}{(1 + \eta)^2})}
		\leq 
		e^{\pi_3 (\varx^1)(1 + \eta)^3 - f(a)(1 + \eta)^2}
		\land 
		e^{\epsilon(1 + 24B\eta)} 
		e^{\epsilon (\frac{\pi_2(\varx^1)}{(1 + \eta)^3} - \frac{f(a)}{(1 + \eta)^2})}
		\leq 
		e^{\pi_3 (\varx^2)(1 + \eta)^3 - f(a')(1 + \eta)^2}
	}
	{
		\varx_1 = \clamp_B \big(
		\round{f(a) + \frac{1}{\epsilon} \times s_1 \times \ln (\varu_1)}_{\Lambda}
		\big) 
		\sim_{0, 0} 
		\varx_2 = \clamp_B \big(
		\round{f(a) + \frac{1}{\epsilon} \times s_2 \times \ln (\varu_2)}_{\Lambda}
		:
		\Phi \land \pi_1(s_1) = \pi_1(s_2)
		\Rightarrow
		\Phi'
	}
\and
\mathtodo{ \Phi' \Rightarrow \varx_1 = \varx_2}
\\
\Phi \land \pi_1(s_1) = \pi_1(s_2)
\Rightarrow \Phi \land \pi_1(s_1) = \pi_1(s_2)
}
{
	\varx_1 = \clamp_B \big(
	\round{f(a) + \frac{1}{\epsilon} \times s_1 \times \ln (\varu_1)}_{\Lambda}
	\big) 
	\sim_{0, 0} 
	\varx_2 = \clamp_B \big(
	\round{f(a) + \frac{1}{\epsilon} \times s_2 \times \ln (\varu_2)}_{\Lambda}
	:
	\Phi \land \pi_1(s_1) = \pi_1(s_2)
	\Rightarrow \varx_1 = \varx_2
}
\end{mathpar}
}
\todo{
	given that:
	$
	\Phi' = 
		e^{-\epsilon(1 + 24B\eta)} 
		e^{\epsilon (\frac{\pi_2(\varx^2)}{(1 + \eta)^3} - \frac{f(a')}{(1 + \eta)^2})}
		\leq 
		e^{\pi_3 (\varx^1)(1 + \eta)^3 - f(a)(1 + \eta)^2}
		\land 
		e^{\epsilon(1 + 24B\eta)} 
		e^{\epsilon (\frac{\pi_2(\varx^1)}{(1 + \eta)^3} - \frac{f(a)}{(1 + \eta)^2})}
		\leq 
		e^{\pi_3 (\varx^2)(1 + \eta)^3 - f(a')(1 + \eta)^2}
	$
	I'm able to prove that:
	$\varx_1 = \varx_2 \Rightarrow \Phi'$
	but not 
	$\Phi' \Rightarrow \varx_1 = \varx_2$.
	\\
	However, in order to show the differential privacy, it is needed to prove:
	$\Phi' \Rightarrow \varx_1 = \varx_2$.
}
\end{proof}

\newpage
\bibliographystyle{plain}
\bibliography{verifysnap.bib}

\end{document}



